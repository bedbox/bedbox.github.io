<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Codes Online">
<meta property="og:url" content="http://51codes.top/page/3/index.html">
<meta property="og:site_name" content="Codes Online">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Codes Online">






  <link rel="canonical" href="http://51codes.top/page/3/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Codes Online</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Codes Online</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _enjoying</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2018/03/15/centos-dubbo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/15/centos-dubbo/" itemprop="url">
                  CentOS下部署Dubbo记录
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-15 02:36:42 / 修改时间：03:04:26" itemprop="dateCreated datePublished" datetime="2018-03-15T02:36:42+08:00">2018-03-15</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/环境搭建/" itemprop="url" rel="index"><span itemprop="name">环境搭建</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>推荐JDK1.8, 不推荐Java 9</p>
<h4 id="安装-zookeeper"><a href="#安装-zookeeper" class="headerlink" title="安装 zookeeper"></a>安装 <a href="http://zookeeper.apache.org" target="_blank" rel="external">zookeeper</a></h4><p>集群设置注意data路径和myid文件</p>
<p>zoo.cfg<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># The number of ticks that the initial </span></span><br><span class="line"><span class="comment"># synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="comment"># The number of ticks that can pass between </span></span><br><span class="line"><span class="comment"># sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="comment"># the directory where the snapshot is stored.</span></span><br><span class="line">dataDir=/Users/John/Documents/Code/ServerSource/zkCluster/zk1/data</span><br><span class="line"><span class="comment"># the port at which the clients will connect</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="comment">#集群配置</span></span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br></pre></td></tr></table></figure></p>
<h4 id="编译安装dubbo-monitor"><a href="#编译安装dubbo-monitor" class="headerlink" title="编译安装dubbo-monitor"></a>编译安装<a href="[https://github.com/dubbo/dubbo-ops">dubbo-monitor</a></h4><p>下载dubbo-ops源码</p>
<p>跳转至根目录, 执行mvn install -Dmaven.test.skip=true</p>
<p>可能会出现以下两个编译失败</p>
<p>1-找不到相关jar包，找不到FilterXXX的类，解决办法，工程依赖项添加tomcat/lib，需要将该目录下的jsp-api.jar、servlet-api.jar拷贝到target/dubbo-monitor-simple-2.0.0-assembly.tar.gz解压后的目录lib</p>
<p>2-如果是java 9, 可能会遇到无法识别某些将被放弃的api和参数，所以把jdk改为1.8可解决，执行start.sh可能会出现内存不足<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JAVA_MEM_OPTS=<span class="string">" -server -Xmx2g -Xms2g -Xmn256m -XX:PermSize=128m -Xss256k -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 "</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    JAVA_MEM_OPTS=<span class="string">" -server -Xms1g -Xmx1g -XX:PermSize=128m -XX:SurvivorRatio=2 -XX:+UseParallelGC "</span></span><br></pre></td></tr></table></figure></p>
<p>其中<code>-server -Xmx2g -Xms2g -Xmn256m</code>2g改为512m即可</p>
<h4 id="安装dubbo-admin"><a href="#安装dubbo-admin" class="headerlink" title="安装dubbo-admin"></a>安装dubbo-admin</h4><p>同monitor一个工程</p>
<p>部署时候遇到端口被占用，这个好解决，还遇到某些api和参数执行错误，导致tomcat无法开启，所以要tomcat使用的jdk为1.8版本，之前用9，所以一直失败，其他版本没去试过</p>
<h4 id="搭建dubbo工程"><a href="#搭建dubbo工程" class="headerlink" title="搭建dubbo工程"></a>搭建dubbo工程</h4><p>至此可以开始搭建业务框架，基于雏形框架，逐步完善优化，dubbo比想象中的强大，还有好多特性需要去挖掘</p>
<p>官网 <a href="http://wwww.dubbo.io" target="_blank" rel="external">http://wwww.dubbo.io</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2018/03/05/socket-accept/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/05/socket-accept/" itemprop="url">
                  Socket的accept函数解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-05 12:39:40 / 修改时间：12:46:40" itemprop="dateCreated datePublished" datetime="2018-03-05T12:39:40+08:00">2018-03-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/架构/" itemprop="url" rel="index"><span itemprop="name">架构</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天与同学争执一个话题：<strong>由于socket的accept函数在有客户端连接的时候产生了新的socket用于服务该客户端，那么，这个新的socket到底有没有占用一个新的端口？</strong></p>
<p>讨论完后，才发现，自己虽然熟悉socket的编程套路，但是却并不是那么清楚socket的原理，今天就趁这个机会，把有关socket编程的几个疑问给搞清楚吧。</p>
<p>先给出一个典型的TCP/IP通信示意图。</p>
<p><img src="/2018/03/05/socket-accept/1.png" alt=""></p>
<h4 id="问题一：socket结构体对象究竟是怎样定义的？"><a href="#问题一：socket结构体对象究竟是怎样定义的？" class="headerlink" title="问题一：socket结构体对象究竟是怎样定义的？"></a>问题一：socket结构体对象究竟是怎样定义的？</h4><p>我们知道，在使用socket编程之前，需要调用socket函数创建一个socket对象，该函数返回该socket对象的描述符。</p>
<p>函数原型：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>那么，这个socket对象究竟是怎么定义的呢？它记录了哪些信息呢？只记录了本机IP及端口、还是目的IP及端口、或者都记录了？</strong></p>
<p>关于这个问题，大家可以在内核源码里面找，也可以参考这篇文章《struct socket 结构详解》，我们可以看到 socket  结构体的定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct socket   </span><br><span class="line">&#123;   </span><br><span class="line">    socket_state              state;   </span><br><span class="line">    unsigned <span class="keyword">long</span>             flags;   </span><br><span class="line">    <span class="keyword">const</span> struct proto_ops    *ops;   </span><br><span class="line">    struct fasync_struct      *fasync_list;   </span><br><span class="line">    struct file               *file;   </span><br><span class="line">    struct sock               *sk;   </span><br><span class="line">    wait_queue_head_t         wait;   </span><br><span class="line">    <span class="keyword">short</span>                     type;   </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>其中，struct sock 包含有一个 sock_common 结构体，而sock_common结构体又包含有struct inet_sock 结构体，而struct inet_sock 结构体的部分定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct inet_sock   </span><br><span class="line">&#123;   </span><br><span class="line">    struct sock     sk;   </span><br><span class="line">#if defined(CONFIG_IPV6) || defined(CONFIG_IPV6_MODULE)   </span><br><span class="line">    struct ipv6_pinfo   *pinet6;   </span><br><span class="line">#endif   </span><br><span class="line">    __u32           daddr;          <span class="comment">//IPv4的目的地址。   </span></span><br><span class="line">    __u32           rcv_saddr;      <span class="comment">//IPv4的本地接收地址。   </span></span><br><span class="line">    __u16           dport;          <span class="comment">//目的端口。   </span></span><br><span class="line">    __u16           num;            <span class="comment">//本地端口（主机字节序）。  </span></span><br><span class="line">    </span><br><span class="line">    …………      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>由此，我们清楚了，socket结构体不仅仅记录了本地的IP和端口号，还记录了目的IP和端口。</strong></p>
<h4 id="问题二：connect函数究竟做了些什么操作？"><a href="#问题二：connect函数究竟做了些什么操作？" class="headerlink" title="问题二：connect函数究竟做了些什么操作？"></a>问题二：connect函数究竟做了些什么操作？</h4><p>在TCP客户端，首先调用一个socket()函数，得到一个socket描述符socketfd，然后通过connect函数对服务器进行连接，连接成功后，就可以利用这个socketfd描述符使用send/recv函数收发数据了。</p>
<p>关于connect函数和send函数的原型如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">( <span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct sockaddr* server_addr, socklen_t addrlen)</span>  </span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">send</span><span class="params">( <span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">void</span> *msg,<span class="keyword">int</span> len,<span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<p>那么，现在的困惑是，<strong>为什么send函数仅仅传入sockfd就可以知道服务器的ip和端口号？</strong></p>
<p>其实，由“问题一”中的答案我们已经很清楚了，sockfd 描述符所描述的socket对象不仅包含了本地IP和端口，同时也包含了服务器的IP和端口，这样，才能使得send函数只需要传入sockfd 即可知道该把数据发向什么地方。而代码中，目的IP和端口只是在connect函数中出现过，因此，肯定是connect函数在成功建立连接后，将目的IP和端口写入了sockfd 描述符所描述的socket对象中。</p>
<h4 id="问题三：-accept函数产生的socket有没有占用新的端口？"><a href="#问题三：-accept函数产生的socket有没有占用新的端口？" class="headerlink" title="问题三： accept函数产生的socket有没有占用新的端口？"></a>问题三： accept函数产生的socket有没有占用新的端口？</h4><p>首先，回顾一下accept函数，原型如下：</p>
<pre><code class="java"><span class="comment">/* 参数：sockfd 监听套接字，即服务器端创建的用于listen的socket描述符。  </span>
<span class="comment"> * 参数：addr  这是一个结果参数，它用来接受一个返回值，这返回值指定客户端的地址  </span>
<span class="comment"> * 参数：len 描述 addr 的长度  </span>
<span class="comment"> */</span> 
<span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr* addr, socklen_t* len)</span></span>
</code></pre>
<p>accept函数主要用于服务器端，一般位于listen函数之后，默认会阻塞进程，直到有一个客户请求连接，建立好连接后，它返回的一个新的套接字 socketfd_new ，此后，服务器端即可使用这个新的套接字socketfd_new与该客户端进行通信，而sockfd 则继续用于监听其他客户端的连接请求。</p>
<p>至此，我的困惑产生了，<strong>这个新的套接字 socketfd_new 与监听套接字sockfd 是什么关系？它所代表的socket对象包含了哪些信息？socketfd_new 是否占用了新的端口与客户端通信？</strong></p>
<p>先简单分析一番，由于网站的服务器也是一种TCP服务器，使用的是80端口，并不会因客户端的连接而产生新的端口给客户端服务，该客户端依然是向服务器端的80端口发送数据，其他客户端依然向80端口申请连接。因此，可以判断，socketfd_new 并没有占用新的端口与客户端通信，依然使用的是与监听套接字socketfd_new一样的端口号。</p>
<p>那这么说，<strong>难道一个端口可以被两个socket对象绑定？当客户端发送数据过来的时候，究竟是与哪一个socket对象通信呢？</strong></p>
<hr>
<p>我是这么理解的（欢迎拍砖）。</p>
<h4 id="首先一个端口肯定只能绑定一个socket。"><a href="#首先一个端口肯定只能绑定一个socket。" class="headerlink" title="首先一个端口肯定只能绑定一个socket。"></a>首先一个端口肯定只能绑定一个socket。</h4><p>我认为，服务器端的端口在bind的时候已经绑定到了监听套接字socetfd所描述的对象上，accept函数新创建的socket对象其实并没有进行端口的占有，而是复制了socetfd的本地IP和端口号，并且记录了连接过来的客户端的IP和端口号。</p>
<h4 id="那么，当客户端发送数据过来的时候，究竟是与哪一个socket对象通信呢？"><a href="#那么，当客户端发送数据过来的时候，究竟是与哪一个socket对象通信呢？" class="headerlink" title="那么，当客户端发送数据过来的时候，究竟是与哪一个socket对象通信呢？"></a>那么，当客户端发送数据过来的时候，究竟是与哪一个socket对象通信呢？</h4><p>客户端发送过来的数据可以分为2种，一种是连接请求，一种是已经建立好连接后的数据传输。</p>
<p>由于TCP/IP协议栈是维护着一个接收和发送缓冲区的。在接收到来自客户端的数据包后，服务器端的TCP/IP协议栈应该会做如下处理：如果收到的是请求连接的数据包，则传给监听着连接请求端口的socetfd套接字，进行accept处理；如果是已经建立过连接后的客户端数据包，则将数据放入接收缓冲区。这样，当服务器端需要读取指定客户端的数据时，则可以利用socketfd_new 套接字通过recv或者read函数到缓冲区里面去取指定的数据（因为socketfd_new代表的socket对象记录了客户端IP和端口，因此可以鉴别）。</p>
<p>这就是我对socket编程的一些疑问的理解，有不正确的地方欢迎留言或者来信 lujun.hust@gmail.com 交流。 </p>
<p>来源：<a href="http://blog.51cto.com/ticktick/779866" target="_blank" rel="external">http://blog.51cto.com/ticktick/779866</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2018/03/04/nettyprotobuf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/04/nettyprotobuf/" itemprop="url">
                  一个基于 Netty + Protobuf 构建的高性能 TCP 网关开源组件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-04 23:40:15" itemprop="dateCreated datePublished" datetime="2018-03-04T23:40:15+08:00">2018-03-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-03-05 12:35:00" itemprop="dateModified" datetime="2018-03-05T12:35:00+08:00">2018-03-05</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/架构/" itemprop="url" rel="index"><span itemprop="name">架构</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.linkedkeeper.com" target="_blank" rel="external">张松然</a><br><code>京东商城 POP平台系统架构师。对构建高性能，高可用的大规模分布系统有丰富的开发经验，有多年NIO领域的设计、开发经验，对HTTP、TCP长连接技术有深入研究与领悟。</code></p>
<h4 id="TCP-网关"><a href="#TCP-网关" class="headerlink" title="TCP 网关"></a>TCP 网关</h4><p>本文将为大家介绍一个基于 Netty + Protobuf 构建的高性能 TCP 网关开源组件。该组件部署业务化运行2年以上，实现TCP 双向通道通信，维持高并发在线长连接，优化传输字节码等。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>从 <a href="https://github.com/linkedkeeper/tcp-gateway" target="_blank" rel="external">GitHub</a> 克隆这个工程，并将它作为一个依赖包添加到 Maven 项目中。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><h4 id="1-创建-TCP-服务"><a href="#1-创建-TCP-服务" class="headerlink" title="1. 创建 TCP 服务"></a>1. 创建 TCP 服务</h4><p>基于 Spring 配置文件：spring-tcp-server.xml 启动服务器<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">                   http://www.springframework.org/schema/beans/spring-beans.xsd"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">default-autowire</span>=<span class="string">"byName"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- tcp server config start. --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"tcpServer"</span> <span class="attr">class</span>=<span class="string">"com.linkedkeeper.tcp.connector.tcp.server.TcpServer"</span> <span class="attr">init-method</span>=<span class="string">"init"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">destroy-method</span>=<span class="string">"shutdown"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- port is tcp server port --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"2000"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"tcpSessionManager"</span> <span class="attr">class</span>=<span class="string">"com.linkedkeeper.tcp.connector.tcp.TcpSessionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxInactiveInterval"</span> <span class="attr">value</span>=<span class="string">"500"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- you can add listener to listen session event, include session create, destroy and so on. --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sessionListeners"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"logSessionListener"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- logSessionListener is related tcpSessionManager, those listener should implements SessionListener --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"logSessionListener"</span> <span class="attr">class</span>=<span class="string">"com.linkedkeeper.tcp.connector.api.listener.LogSessionListener"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- tcp sender is a container that can send message to client from server --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"tcpSender"</span> <span class="attr">class</span>=<span class="string">"com.linkedkeeper.tcp.remoting.TcpSender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"tcpConnector"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- server config is combine the config, don't modify --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serverConfig"</span> <span class="attr">class</span>=<span class="string">"com.linkedkeeper.tcp.connector.tcp.config.ServerTransportConfig"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"tcpConnector"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"proxy"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"notify"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- tcp connector is container that manage the connection between server and client --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"tcpConnector"</span> <span class="attr">class</span>=<span class="string">"com.linkedkeeper.tcp.connector.tcp.TcpConnector"</span> <span class="attr">init-method</span>=<span class="string">"init"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">destroy-method</span>=<span class="string">"destroy"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- notify proxy is proxy that implement send notify to client --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"notify"</span> <span class="attr">class</span>=<span class="string">"com.linkedkeeper.tcp.notify.NotifyProxy"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"tcpConnector"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- default tcp server config end. --&gt;</span></span><br><span class="line">     </span><br><span class="line">    <span class="comment">&lt;!-- this proxy is your proxy that can receive message from client --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"proxy"</span> <span class="attr">class</span>=<span class="string">"com.linkedkeeper.tcp.server.TestSimpleProxy"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>说明：</p>
<ul>
<li><p>TcpServer：提供 TCP 连接的服务</p>
</li>
<li><p>TcpSessionManager：你可以添加监听事件，用于监听 TCP 会话的创建、销毁等</p>
</li>
<li><p>LogSessionListener：一个日志监听器，它和 tcpSessionManager 关联，监听器必须事先 SessionListener</p>
</li>
<li><p>TcpSender：TCP 发送者，用于向客户端发送通知消息，实现下行逻辑</p>
</li>
<li><p>ServerConfig：TCP 的配置管理类</p>
</li>
<li><p>TcpConnector：TCP 容器，用于管理服务端和客户端的连接</p>
</li>
<li><p>NotifyProxy：发送通知的代理类</p>
</li>
</ul>
<p>上面的配置都是默认的，你可以不更改，但是你可能需要换个 TCP 端口。</p>
<h4 id="例子1-创建测试代理用于从客户端接收消息"><a href="#例子1-创建测试代理用于从客户端接收消息" class="headerlink" title="例子1 创建测试代理用于从客户端接收消息"></a>例子1 创建测试代理用于从客户端接收消息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.protobuf.ByteString;</span><br><span class="line"><span class="keyword">import</span> com.google.protobuf.InvalidProtocolBufferException;</span><br><span class="line"><span class="keyword">import</span> com.linkedkeeper.tcp.connector.tcp.codec.MessageBuf;</span><br><span class="line"><span class="keyword">import</span> com.linkedkeeper.tcp.data.Login;</span><br><span class="line"><span class="keyword">import</span> com.linkedkeeper.tcp.data.Protocol;</span><br><span class="line"><span class="keyword">import</span> com.linkedkeeper.tcp.invoke.ApiProxy;</span><br><span class="line"><span class="keyword">import</span> com.linkedkeeper.tcp.message.MessageWrapper;</span><br><span class="line"><span class="keyword">import</span> com.linkedkeeper.tcp.message.SystemMessage;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSimpleProxy</span> <span class="keyword">implements</span> <span class="title">ApiProxy</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageWrapper <span class="title">invoke</span><span class="params">(SystemMessage sMsg, MessageBuf.JMTransfer message)</span> </span>&#123;</span><br><span class="line">        ByteString body = message.getBody();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (message.getCmd() == <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Login.MessageBufPro.MessageReq messageReq </span><br><span class="line">                    = Login.MessageBufPro.MessageReq.parseFrom(body);</span><br><span class="line">                <span class="keyword">if</span> (messageReq.getCmd().equals(Login.MessageBufPro.CMD.CONNECT)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> MessageWrapper(MessageWrapper.MessageProtocol.CONNECT, </span><br><span class="line">                        message.getToken(), <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvalidProtocolBufferException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getCmd() == <span class="number">1002</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Login.MessageBufPro.MessageReq messageReq </span><br><span class="line">                    = Login.MessageBufPro.MessageReq.parseFrom(body);</span><br><span class="line">                <span class="keyword">if</span> (messageReq.getCmd().equals(Login.MessageBufPro.CMD.HEARTBEAT)) &#123;</span><br><span class="line">                    MessageBuf.JMTransfer.Builder resp = Protocol.generateHeartbeat();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> MessageWrapper(MessageWrapper.MessageProtocol.HEART_BEAT, </span><br><span class="line">                        message.getToken(), resp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvalidProtocolBufferException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="输入参数"><a href="#输入参数" class="headerlink" title="输入参数"></a>输入参数</h4><p>SystemMessage：TcpServer 构建的参数，包括远端地址，本地地址等</p>
<p>MessageBuf.JMTransfer：这个很重要，这是由 Protobuf 创建的，它包括 header 和 body，header 是系统及参数，你可以从项目中看到具体参数，body 是 protobuf 序列化的字节码，也是有 protobuf 类生成</p>
<h4 id="输出参数"><a href="#输出参数" class="headerlink" title="输出参数"></a>输出参数</h4><p>MessageWrapper：这是一个消息响应的包装类，它包括 protocol，sessionId 和 body。body 是一个 bytes，它和 protobuf 对应。</p>
<h4 id="例子2-发送通知到客户端"><a href="#例子2-发送通知到客户端" class="headerlink" title="例子2 发送通知到客户端"></a>例子2 发送通知到客户端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> NotifyProxy notify;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> timeout = <span class="number">10</span> * <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> NOTIFY = <span class="number">3</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">send</span><span class="params">(<span class="keyword">long</span> seq, String sessionId, <span class="keyword">int</span> cmd, ByteString body)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">    MessageBuf.JMTransfer.Builder builder = generateNotify(sessionId, seq, cmd, body);</span><br><span class="line">    <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">        MessageWrapper wrapper = <span class="keyword">new</span> MessageWrapper(MessageWrapper.MessageProtocol.NOTIFY, sessionId, builder);</span><br><span class="line">        <span class="keyword">int</span> ret = notify.notify(seq, wrapper, timeout);</span><br><span class="line">        <span class="keyword">if</span> (ret == Constants.NOTIFY_SUCCESS) &#123;</span><br><span class="line">            success = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == Constants.NOTIFY_NO_SESSION) &#123;</span><br><span class="line">            <span class="comment">/** no session on this machine **/</span></span><br><span class="line">            success = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/** no session in the cache **/</span></span><br><span class="line">        success = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * session</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> String VERSION = <span class="string">"version"</span>;</span><br><span class="line"><span class="keyword">final</span> String DEVICE_ID = <span class="string">"deviceId"</span>;</span><br><span class="line"><span class="keyword">final</span> String PLATFORM = <span class="string">"platform"</span>;</span><br><span class="line"><span class="keyword">final</span> String PLATFORM_VERSION = <span class="string">"platformVersion"</span>;</span><br><span class="line"><span class="keyword">final</span> String TOKEN = <span class="string">"token"</span>;</span><br><span class="line"><span class="keyword">final</span> String APP_KEY = <span class="string">"appKey"</span>;</span><br><span class="line"><span class="keyword">final</span> String TIMESTAMP = <span class="string">"timestamp"</span>;</span><br><span class="line"><span class="keyword">final</span> String SIGN = <span class="string">"sign"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * need session into redis, then when you notify you can get info from redis by session</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;String, Map&lt;String, Object&gt;&gt; testSessionMap = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">protected</span> MessageBuf.JMTransfer.<span class="function">Builder <span class="title">generateNotify</span><span class="params">(String sessionId, <span class="keyword">long</span> seq, <span class="keyword">int</span> cmd, ByteString body)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = testSessionMap.get(sessionId);</span><br><span class="line"> </span><br><span class="line">    MessageBuf.JMTransfer.Builder builder = MessageBuf.JMTransfer.newBuilder();</span><br><span class="line">    builder.setVersion(String.valueOf(map.get(VERSION)));</span><br><span class="line">    builder.setDeviceId(String.valueOf(map.get(DEVICE_ID)));</span><br><span class="line">    builder.setCmd(cmd);</span><br><span class="line">    builder.setSeq(seq);</span><br><span class="line">    builder.setFormat(NOTIFY);</span><br><span class="line">    builder.setFlag(<span class="number">0</span>);</span><br><span class="line">    builder.setPlatform(String.valueOf(map.get(PLATFORM)));</span><br><span class="line">    builder.setPlatformVersion(String.valueOf(map.get(PLATFORM_VERSION)));</span><br><span class="line">    builder.setToken(String.valueOf(map.get(TOKEN)));</span><br><span class="line">    builder.setAppKey(String.valueOf(map.get(APP_KEY)));</span><br><span class="line">    builder.setTimeStamp(String.valueOf(map.get(TIMESTAMP)));</span><br><span class="line">    builder.setSign(String.valueOf(map.get(SIGN)));</span><br><span class="line">    builder.setBody(body);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> builder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-创建-TCP-客户端"><a href="#2-创建-TCP-客户端" class="headerlink" title="2. 创建 TCP 客户端"></a>2. 创建 TCP 客户端</h4><p>支持 iOS，Android，C++ 等语言构建的客户端</p>
<h4 id="3-序列化-Protobuf"><a href="#3-序列化-Protobuf" class="headerlink" title="3. 序列化 Protobuf"></a>3. 序列化 Protobuf</h4><p>Java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/protobuf/protoc --proto_path=/protobuf/ --java_out=/protobuf/MessageBuf.proto</span><br></pre></td></tr></table></figure>
<p>Object-C</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --plugin=/protobuf/protoc-gen-objc MessageBuf.proto --object_out=&quot;/protobuf/&quot;</span><br></pre></td></tr></table></figure>
<p>附件：</p>
<p>你可以点击 <a href="http://linkedkeeper-misc.oss-cn-beijing.aliyuncs.com/misc/download/protoc.zip" target="_blank" rel="external">下载</a> protobuf 编译器</p>
<p>来源：<a href="http://www.linkedkeeper.com/detail/blog.action?bid=1026" target="_blank" rel="external">http://www.linkedkeeper.com/detail/blog.action?bid=1026</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2018/03/04/transformer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/04/transformer/" itemprop="url">
                  简易220V转12V开关电源电路图
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-04 23:22:08 / 修改时间：23:24:12" itemprop="dateCreated datePublished" datetime="2018-03-04T23:22:08+08:00">2018-03-04</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/嵌入式/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>简易220V转12V开关电源电路图 调整C3和R5使振荡频率在30KHz-45KH. 输出电压需要稳压. 输出电流可达约500mA </p>
<p><img src="/2018/03/04/transformer/1.gif" alt=""></p>
<p>简易220V转12V开关电源电路图 调整C3和R5使振荡频率在30KHz-45KH. 输出电压需要稳压. 输出电流可达约500mA </p>
<p><img src="/2018/03/04/transformer/2.gif" alt=""></p>
<p>来源：<a href="http://tech.hqew.com/circuit_1495269" target="_blank" rel="external">http://tech.hqew.com/circuit_1495269</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2018/03/04/relay/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/04/relay/" itemprop="url">
                  中间继电器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-04 22:41:49 / 修改时间：23:18:08" itemprop="dateCreated datePublished" datetime="2018-03-04T22:41:49+08:00">2018-03-04</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/嵌入式/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>中间继电器是一种继电保护元件，他和时间继电器一样，其主要用于继电保护与自动控制系统中，中间继电器和时间继电器及一些其他类型的继电器是有所区别的，它一般是没有主触点的，因为过载能力比较小。所以它用的全部都是辅助触头，数量比较多。</p>
<p><img src="/2018/03/04/relay/1.jpg" alt=""></p>
<h4 id="中间继电器的作用："><a href="#中间继电器的作用：" class="headerlink" title="中间继电器的作用："></a>中间继电器的作用：</h4><p>　　</p>
<h4 id="1、隔离"><a href="#1、隔离" class="headerlink" title="1、隔离"></a>1、隔离</h4><p>控制系统的输出信号与负载端电气隔离；</p>
<h4 id="2、转换"><a href="#2、转换" class="headerlink" title="2、转换"></a>2、转换</h4><p>比如控制系统输出信号为DC24V，但负载使用AC220V供电，对于输入，可逆；</p>
<h4 id="3、“放大”"><a href="#3、“放大”" class="headerlink" title="3、“放大”"></a>3、“放大”</h4><p>控制器输出的信号的带负载的能力往往有限，在mA或者数A的级别，如果有需要更大电流的负载，只能通过中间继电器来转换。</p>
<h4 id="中间继电器的工作原理"><a href="#中间继电器的工作原理" class="headerlink" title="中间继电器的工作原理"></a>中间继电器的工作原理</h4><p>　　中间继电器工作原理和交流接触器一样，都是由固定铁芯、动铁芯、弹簧、动触点、静触点、线圈、接线端子和外壳组成。线圈通电，动铁芯在电磁力作用下动作吸合，带动动触点动作，使常闭触点分开，常开触点闭合；线圈断电，动铁芯在弹簧的作用下带动动触点复位。</p>
<p><img src="/2018/03/04/relay/2.jpg" alt=""></p>
<h4 id="中间继电器的分类"><a href="#中间继电器的分类" class="headerlink" title="中间继电器的分类"></a>中间继电器的分类</h4><h4 id="1、电磁型中间继电器"><a href="#1、电磁型中间继电器" class="headerlink" title="1、电磁型中间继电器"></a>1、电磁型中间继电器</h4><p>当继电器线圈施加激励量等于或大于其动作值时，衔铁被吸向导磁体，同时衔铁压动触点弹片，使触点接通、断开或切换被控制的电路。当继电器的线圈被断电或激励量降低到小于其返回值时，衔铁和接触片返回到原来位置。</p>
<h4 id="2、延时中间继电器"><a href="#2、延时中间继电器" class="headerlink" title="2、延时中间继电器"></a>2、延时中间继电器</h4><p>延时中间继电器分为通电延时（即上电延时）和断电延时两种，实际操作中也成为可调延时动作和可调延时返回；延时中间继电器带瞬动触点，延时范围一般为0.02-9.99S。</p>
<h4 id="3、静态中间继电器"><a href="#3、静态中间继电器" class="headerlink" title="3、静态中间继电器"></a>3、静态中间继电器</h4><p>　　静态中间继电器，集成电路型，作为老式DZ-200系列电磁式中间继电器的替代产品，其稳定性，动作速度均优于老式电磁继电器；现多用于大型柜体的新建和改造项目中；其安装方式分为板前和板后两种形式，柜体开孔，则需采用板后安装的方式。</p>
<h4 id="中间继电器如何接线-中间继电器接线图图解"><a href="#中间继电器如何接线-中间继电器接线图图解" class="headerlink" title="中间继电器如何接线_中间继电器接线图图解"></a>中间继电器如何接线_中间继电器接线图图解</h4><p>　　中间继电器型号众多，型号不同接线也不相同。</p>
<p><img src="/2018/03/04/relay/3.jpg" alt=""></p>
<p><code>继电器（Relay）通俗来说就是用小电流控制大电流。由控制回路和负载回路组成在自动控制电路中，相当于自动开关。用于控制电路，保护电路，转换电路。</code></p>
<p><img src="/2018/03/04/relay/4.jpg" alt=""></p>
<p>　　继电器主要分为一般继电器和固态继电器。一般继电器把控制信号转换成机械式动作的电磁铁和开关电气的开关构成。而中间继电器是最基本的继电器。</p>
<p><img src="/2018/03/04/relay/5.jpg" alt=""></p>
<p><img src="/2018/03/04/relay/6.jpg" alt=""></p>
<h4 id="中间继电器接线步骤教程"><a href="#中间继电器接线步骤教程" class="headerlink" title="中间继电器接线步骤教程"></a>中间继电器接线步骤教程</h4><p>　　1、在没有万用表的情况下，我们要如何确认好继电器的供电线圈，这里有小技巧，在继电器底座上有指示，有箭头的方向就是控制方向，没有箭头的方向就是线圈方向；</p>
<p><img src="/2018/03/04/relay/7.jpg" alt=""></p>
<p>　　2、还有一个技巧就是在弹簧卡位方向就是线圈供电！这样辨别后，我们开始通根据继电器规格要求的电压开始通电，判断正确就可以听到塔塔的吸合声，正负极接对里面的LED还会亮！</p>
<p><img src="/2018/03/04/relay/8.jpg" alt=""></p>
<p>　　3、确认好线圈后，我们开始进行开关脚位分辨！如图所示！</p>
<p><img src="/2018/03/04/relay/9.jpg" alt=""></p>
<p>　　4、继电器对好脚位插上去，位置就如图所示！非常简单！</p>
<p><img src="/2018/03/04/relay/10.jpg" alt=""></p>
<p>　　5、由于继电器是透明的，很容易就分辨出常开常闭！</p>
<p><img src="/2018/03/04/relay/11.jpg" alt=""></p>
<p>　　6、当线圈正负极接对，里面的LED就会亮，同时继电器吸合！</p>
<p><img src="/2018/03/04/relay/12.jpg" alt=""></p>
<p>来源：<a href="http://m.elecfans.com/article/623170.html" target="_blank" rel="external">http://m.elecfans.com/article/623170.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2018/01/03/sql-inject/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/sql-inject/" itemprop="url">
                  SQL注入原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-03 08:48:15" itemprop="dateCreated datePublished" datetime="2018-01-03T08:48:15+08:00">2018-01-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-01-04 22:49:27" itemprop="dateModified" datetime="2018-01-04T22:49:27+08:00">2018-01-04</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/安全/" itemprop="url" rel="index"><span itemprop="name">安全</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="1-1-1-摘要"><a href="#1-1-1-摘要" class="headerlink" title="1.1.1 摘要"></a>1.1.1 摘要</h4><p>日前，国内最大的程序员社区CSDN网站的用户数据库被黑客公开发布，600万用户的登录名及密码被公开泄露，随后又有多家网站的用户密码被流传于网络，连日来引发众多网民对自己账号、密码等互联网信息被盗取的普遍担忧。</p>
<p>网络安全成为了现在互联网的焦点，这也恰恰触动了每一位用户的神经，由于设计的漏洞导致了不可收拾的恶果，验证了一句话“出来混的，迟早是要还的”，所以我想通过专题博文介绍一些常用的攻击技术和防范策略。</p>
<p>SQL Injection也许很多人都知道或者使用过，如果没有了解或完全没有听过也没有关系，因为接下来我们将介绍SQL Injection。</p>
<h4 id="1-1-2-正文"><a href="#1-1-2-正文" class="headerlink" title="1.1.2 正文"></a>1.1.2 正文</h4><p>SQL Injection：就是通过把SQL命令插入到Web表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。</p>
<p>具体来说，它是利用现有应用程序，将（恶意）的SQL命令注入到后台数据库引擎执行的能力，它可以通过在Web表单中输入（恶意）SQL语句得到一个存在安全漏洞的网站上的数据库，而不是按照设计者意图去执行SQL语句。</p>
<p>首先让我们了解什么时候可能发生SQL Injection。</p>
<p>假设我们在浏览器中输入URL <code>www.sample.com</code>，由于它只是对页面的简单请求无需对数据库动进行动态请求，所以它不存在SQL Injection，当我们输入 <code>www.sample.com?testid=23</code> 时，我们在URL中传递变量testid，并且提供值为23，由于它是对数据库进行动态查询的请求（其中?testid＝23表示数据库查询变量），所以我们可以该URL中嵌入恶意SQL语句。</p>
<p>现在我们知道SQL Injection适用场合，接下来我们将通过具体的例子来说明SQL Injection的应用，这里我们以pubs数据库作为例子。</p>
<p>我们通过Web页面查询job表中的招聘信息，job表的设计如下：</p>
<p><img src="/2018/01/03/sql-inject/1.png" alt=""></p>
<p>图1 jobs表</p>
<p>接着让我们实现Web程序，它根据工作Id（job_id）来查询相应的招聘信息，示意代码如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Handles the Load event of the Page control.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name="sender"&gt;The source of the event.&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name="e"&gt;The &lt;see cref="System.EventArgs"/&gt; instance containing the event data.&lt;/param&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span><span class="params">(object sender, EventArgs e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!IsPostBack)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Gets departmentId from http request.</span></span><br><span class="line">        <span class="built_in">string</span> queryString = Request.QueryString[<span class="string">"departmentID"</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(queryString))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Gets data from database.</span></span><br><span class="line">            gdvData.DataSource = GetData(queryString.Trim());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Binds data to gridview.</span></span><br><span class="line">            gdvData.DataBind();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在我们已经完成了Web程序，接下来让我们查询相应招聘信息吧。</p>
<p><img src="/2018/01/03/sql-inject/2.png" alt=""></p>
<p>图2 job表查询结果</p>
<p>如图所示，我们要查询数据库中工作Id值为1的工作信息，而且在页面显示了该工作的Id，Description，Min Lvl和Max Lvl等信息。</p>
<p>现在要求我们实现根据工作Id查询相应工作信息的功能，想必大家很快可以给出解决方案，SQL示意代码如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>     job_id, job_desc, min_lvl, max_lvl</span><br><span class="line"><span class="keyword">FROM</span>         jobs</span><br><span class="line"><span class="keyword">WHERE</span>     (job_id = <span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>假设现在要求我们获取Department表中的所有数据，而且必须保留WHERE语句，那我们只要确保WHERE恒真就OK了，SQL示意代码如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>     job_id, job_desc, min_lvl, max_lvl</span><br><span class="line"><span class="keyword">FROM</span>         jobs</span><br><span class="line"><span class="keyword">WHERE</span>     (job_id = <span class="number">1</span>) <span class="keyword">OR</span> <span class="number">1</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>上面我们使得WHERE恒真，所以该查询中WHERE已经不起作用了，其查询结果等同于以下SQL语句。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>     job_id, job_desc, min_lvl, max_lvl</span><br><span class="line"><span class="keyword">FROM</span>         jobs</span><br></pre></td></tr></table></figure></p>
<p>SQL查询代码实现如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> sql1 = <span class="built_in">string</span>.Format(</span><br><span class="line">    <span class="string">"SELECT job_id, job_desc, min_lvl, max_lvl FROM jobs WHERE job_id='&#123;0&#125;'"</span>, jobId);</span><br></pre></td></tr></table></figure></p>
<p>现在我们要通过页面请求的方式，让数据库执行我们的SQL语句，我们要在URL中嵌入恶意表达式1=1（或2=2等等），如下URL所示：</p>
<p><code>http://localhost:3452/ExcelUsingXSLT/Default.aspx?jobid=1&#39;or&#39;1&#39;=&#39;1</code></p>
<p>等效SQL语句如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>     job_id, job_desc, min_lvl, max_lvl</span><br><span class="line"><span class="keyword">FROM</span>         jobs</span><br><span class="line"><span class="keyword">WHERE</span>     job_id = <span class="string">'1'</span> <span class="keyword">OR</span> <span class="string">'1'</span> = <span class="number">1</span><span class="string">'</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/01/03/sql-inject/3.png" alt=""></p>
<p>图3 job表查询结果</p>
<p>现在我们把job表中的所有数据都查询出来了，仅仅通过一个简单的恒真表达式就可以进行了一次简单的攻击。</p>
<p>虽然我们把job表的数据都查询出来了，但数据并没有太大的价值，由于我们把该表临时命名为job表，所以接着我们要找出该表真正表名。</p>
<p>首先我们假设表名就是job，然后输入以下URL：</p>
<p><code>http://localhost:3452/ExcelUsingXSLT/Default.aspx?jobid=1&#39;or 1=(select count(*) from job)--</code></p>
<p>等效SQL语句如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>       job_id, job_desc, min_lvl, max_lvl </span><br><span class="line"><span class="keyword">FROM</span>         jobs </span><br><span class="line"><span class="keyword">WHERE</span>      job_id=<span class="string">'1'</span><span class="keyword">or</span> <span class="number">1</span>=(<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> job) <span class="comment">--'</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/01/03/sql-inject/4.png" alt=""></p>
<p>图4 job表查询结果</p>
<p>当我们输入了以上URL后，结果服务器返回我们错误信息，这证明了我们的假设是错误的，那我们该感觉到挫败吗？不，其实这里返回了很多信息，首先它证明了该表名不是job，而且它还告诉我们后台数据库是SQL Server，不是MySQL或Oracle，这也设计一个漏洞把错误信息直接返回给了用户。</p>
<p>接下假定表名是jobs，然后输入以下URL：</p>
<p><code>http://localhost:3452/ExcelUsingXSLT/Default.aspx?jobid=1&#39;or1=(select count(*) from jobs) --</code></p>
<p>等效SQL语句如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>       job_id, job_desc, min_lvl, max_lvl </span><br><span class="line"><span class="keyword">FROM</span>         jobs </span><br><span class="line"><span class="keyword">WHERE</span>      job_id=<span class="string">'1'</span><span class="keyword">or</span> <span class="number">1</span>=(<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> jobs) <span class="comment">--'</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/01/03/sql-inject/5.png" alt=""></p>
<p>图5 job表查询结果</p>
<p>现在证明了该表名是jobs，这可以迈向成功的一大步，由于我们知道了表名就可以对该表进行增删改操作了，而且我们还可以猜测出更多的表对它们作出修改，一旦修改成功那么这将是一场灾难。</p>
<p>现在大家已经对SQL Injection的攻击有了初步的了解了，接下让我们学习如何防止SQL Injection。</p>
<h4 id="总的来说有以下几点："><a href="#总的来说有以下几点：" class="headerlink" title="总的来说有以下几点："></a>总的来说有以下几点：</h4><ul>
<li><p>1.永远不要信任用户的输入，要对用户的输入进行校验，可以通过正则表达式，或限制长度，对单引号和双”-“进行转换等。</p>
</li>
<li><p>2.永远不要使用动态拼装SQL，可以使用参数化的SQL或者直接使用存储过程进行数据查询存取。</p>
</li>
<li><p>3.永远不要使用管理员权限的数据库连接，为每个应用使用单独的权限有限的数据库连接。</p>
</li>
<li><p>4.不要把机密信息明文存放，请加密或者hash掉密码和敏感的信息。</p>
</li>
<li><p>5.应用的异常信息应该给出尽可能少的提示，最好使用自定义的错误信息对原始错误信息进行包装，把异常信息存放在独立的表中。</p>
</li>
</ul>
<h4 id="通过正则表达校验用户输入"><a href="#通过正则表达校验用户输入" class="headerlink" title="通过正则表达校验用户输入"></a>通过正则表达校验用户输入</h4><p>首先我们可以通过正则表达式校验用户输入数据中是包含：对单引号和双”-“进行转换等字符。</p>
<p>然后继续校验输入数据中是否包含SQL语句的保留字，如：WHERE，EXEC，DROP等。</p>
<p>现在让我们编写正则表达式来校验用户的输入吧，正则表达式定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> readonly Regex RegSystemThreats =</span><br><span class="line">        <span class="keyword">new</span> Regex(@<span class="string">"\s?or\s*|\s?;\s?|\s?drop\s|\s?grant\s|^'|\s?--|\s?union\s|\s?delete\s|\s?truncate\s|"</span> +</span><br><span class="line">            @<span class="string">"\s?sysobjects\s?|\s?xp_.*?|\s?syslogins\s?|\s?sysremote\s?|\s?sysusers\s?|\s?sysxlogins\s?|\s?sysdatabases\s?|\s?aspnet_.*?|\s?exec\s?"</span>,</span><br><span class="line">            RegexOptions.Compiled | RegexOptions.IgnoreCase);</span><br></pre></td></tr></table></figure></p>
<p>上面我们定义了一个正则表达式对象RegSystemThreats，并且给它传递了校验用户输入的正则表达式。</p>
<p>由于我们已经完成了对用户输入校验的正则表达式了，接下来就是通过该正则表达式来校验用户输入是否合法了，由于.NET已经帮我们实现了判断字符串是否匹配正则表达式的方法——IsMatch()，所以我们这里只需给传递要匹配的字符串就OK了。</p>
<p>示意代码如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// A helper method to attempt to discover [known] SqlInjection attacks.  </span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name="whereClause"&gt;string of the whereClause to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;true if found, false if not found &lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">DetectSqlInjection</span><span class="params">(<span class="built_in">string</span> whereClause)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RegSystemThreats.IsMatch(whereClause);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// A helper method to attempt to discover [known] SqlInjection attacks.  </span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name="whereClause"&gt;string of the whereClause to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name="orderBy"&gt;string of the orderBy clause to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;true if found, false if not found &lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">DetectSqlInjection</span><span class="params">(<span class="built_in">string</span> whereClause, <span class="built_in">string</span> orderBy)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RegSystemThreats.IsMatch(whereClause) || RegSystemThreats.IsMatch(orderBy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在我们完成了校验用的正则表达式，接下来让我们需要在页面中添加校验功能。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Handles the Load event of the Page control.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name="sender"&gt;The source of the event.&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name="e"&gt;The &lt;see cref="System.EventArgs"/&gt; instance containing the event data.&lt;/param&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span><span class="params">(object sender, EventArgs e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!IsPostBack)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Gets departmentId from http request.</span></span><br><span class="line">        <span class="built_in">string</span> queryString = Request.QueryString[<span class="string">"jobId"</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(queryString))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!DetectSqlInjection(queryString) &amp;&amp; !DetectSqlInjection(queryString, queryString))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Gets data from database.</span></span><br><span class="line">                gdvData.DataSource = GetData(queryString.Trim());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Binds data to gridview.</span></span><br><span class="line">                gdvData.DataBind();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Please enter correct field"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当我们再次执行以下URL时，被嵌入的恶意语句被校验出来了，从而在一定程度上防止了SQL Injection。</p>
<p><code>http://localhost:3452/ExcelUsingXSLT/Default.aspx?jobid=1&#39;or&#39;1&#39;=&#39;1</code></p>
<p><img src="/2018/01/03/sql-inject/6.png" alt=""></p>
<p>图6 添加校验查询结果</p>
<p>但使用正则表达式只能防范一些常见或已知SQL Injection方式，而且每当发现有新的攻击方式时，都要对正则表达式进行修改，这可是吃力不讨好的工作。</p>
<h4 id="通过参数化存储过程进行数据查询存取"><a href="#通过参数化存储过程进行数据查询存取" class="headerlink" title="通过参数化存储过程进行数据查询存取"></a>通过参数化存储过程进行数据查询存取</h4><p>首先我们定义一个存储过程根据jobId来查找jobs表中的数据。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- =============================================</span></span><br><span class="line"><span class="comment">-- Author:        JKhuang</span></span><br><span class="line"><span class="comment">-- Create date: 12/31/2011</span></span><br><span class="line"><span class="comment">-- Description:    Get data from jobs table by specified jobId.</span></span><br><span class="line"><span class="comment">-- =============================================</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> [dbo].[GetJobs]</span><br><span class="line">    <span class="comment">-- ensure that the id type is int</span></span><br><span class="line">    @jobId <span class="built_in">INT</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">--    SET NOCOUNT ON;</span></span><br><span class="line">    <span class="keyword">SELECT</span> job_id, job_desc, min_lvl, max_lvl</span><br><span class="line">    <span class="keyword">FROM</span> dbo.jobs</span><br><span class="line">    <span class="keyword">WHERE</span> job_id = @jobId</span><br><span class="line">    <span class="keyword">GRANT</span> <span class="keyword">EXECUTE</span> <span class="keyword">ON</span> GetJobs <span class="keyword">TO</span> pubs </span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure></p>
<p>接着修改我们的Web程序使用参数化的存储过程进行数据查询。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">using (var com = new SqlCommand("GetJobs", con))</span><br><span class="line">&#123;</span><br><span class="line">    // Uses store procedure.</span><br><span class="line">    com.CommandType = CommandType.StoredProcedure;</span><br><span class="line"></span><br><span class="line">    // Pass jobId to store procedure.</span><br><span class="line">    com.Parameters.Add("@jobId", SqlDbType.Int).Value = jobId;</span><br><span class="line">    com.Connection.Open();</span><br><span class="line">    gdvData.DataSource = com.ExecuteScalar();</span><br><span class="line">    gdvData.DataBind(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在我们通过参数化存储过程进行数据库查询，这里我们把之前添加的正则表达式校验注释掉。</p>
<p><img src="/2018/01/03/sql-inject/7.png" alt=""></p>
<p>图7 存储过程查询结果</p>
<p>大家看到当我们试图在URL中嵌入恶意的SQL语句时，参数化存储过程已经帮我们校验出传递给数据库的变量不是整形，而且使用存储过程的好处是我们还可以很方便地控制用户权限，我们可以给用户分配只读或可读写权限。</p>
<p>但我们想想真的有必要每个数据库操作都定义成存储过程吗？而且那么多的存储过程也不利于日常的维护。</p>
<h4 id="参数化SQL语句"><a href="#参数化SQL语句" class="headerlink" title="参数化SQL语句"></a>参数化SQL语句</h4><p>还是回到之前动态拼接SQL基础上，我们知道一旦有恶意SQL代码传递过来，而且被拼接到SQL语句中就会被数据库执行，那么我们是否可以在拼接之前进行判断呢？——命名SQL参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">string sql1 = string.Format(<span class="string">"SELECT job_id, job_desc, min_lvl, max_lvl FROM jobs WHERE job_id = @jobId"</span>);</span><br><span class="line">using (var con = <span class="keyword">new</span> SqlConnection(ConfigurationManager.ConnectionStrings[<span class="string">"SQLCONN1"</span>].ToString()))</span><br><span class="line">using (var com = <span class="keyword">new</span> SqlCommand(sql1, con))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Pass jobId to sql statement.</span></span><br><span class="line">    com.Parameters.Add(<span class="string">"@jobId"</span>, SqlDbType.Int).Value = jobId;</span><br><span class="line">    com.Connection.Open();</span><br><span class="line">    gdvData.DataSource = com.ExecuteReader();</span><br><span class="line">    gdvData.DataBind(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/01/03/sql-inject/8.png" alt=""></p>
<p>图8 参数化SQL查询结果</p>
<p>这样我们就可以避免每个数据库操作（尤其一些简单数据库操作）都编写存储过程了，而且当用户具有数据库中jobs表的读权限才可以执行该SQL语句。</p>
<h4 id="添加新架构"><a href="#添加新架构" class="headerlink" title="添加新架构"></a>添加新架构</h4><p>数据库架构是一个独立于数据库用户的非重复命名空间，您可以将架构视为对象的容器（类似于.NET中的命名空间）。</p>
<p>首先我们右击架构文件夹，然后新建架构。</p>
<p><img src="/2018/01/03/sql-inject/9.png" alt=""></p>
<p><img src="/2018/01/03/sql-inject/10.png" alt=""></p>
<p>图9 添加HumanResource架构</p>
<p>上面我们完成了在pubs数据库中添加HumanResource架构，接着把jobs表放到HumanResource架构中。</p>
<p><img src="/2018/01/03/sql-inject/11.png" alt=""></p>
<p><img src="/2018/01/03/sql-inject/12.png" alt=""></p>
<p>图 10 修改jobs表所属的架构</p>
<p>当我们再次执行以下SQL语句时，SQL Server提示jobs无效，这是究竟什么原因呢？之前还运行的好好的。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> job_id, job_desc, min_lvl, max_lvl <span class="keyword">FROM</span> jobs</span><br><span class="line"> sqlinjection14</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/01/03/sql-inject/13.png" alt=""><br>图 11 查询输出</p>
<p>当我们输入完整的表名“架构名.对象名”（HumanResource.jobs）时，SQL语句执行成功。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> job_id, job_desc, min_lvl, max_lvl <span class="keyword">FROM</span> HumanResource.jobs</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/01/03/sql-inject/14.png" alt=""></p>
<p>为什么之前我们执行SQL语句时不用输入完整表名dbo.jobs也可以执行呢？</p>
<p>这是因为默认的架构（default schema）是dbo，当只输入表名时，Sql Server会自动加上当前登录用户的默认的架构（default schema）——dbo。</p>
<p>由于我们使用自定义架构，这也降低了数据库表名被猜测出来的可能性。</p>
<h4 id="LINQ-to-SQL"><a href="#LINQ-to-SQL" class="headerlink" title="LINQ to SQL"></a>LINQ to SQL</h4><p>前面使用了存储过程和参数化查询，这两种方法都是非常常用的，而针对于.NET Framework的ORM框架也有很多，如：NHibernate，Castle和Entity Framework，这里我们使用比较简单LINQ to SQL。</p>
<p><img src="/2018/01/03/sql-inject/15.png" alt=""></p>
<p>图 12 添加jobs.dbml文件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dc = <span class="keyword">new</span> pubsDataContext();</span><br><span class="line">int result;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Validates jobId is int or not.</span></span><br><span class="line"><span class="keyword">if</span> (int.TryParse(jobId, out result))</span><br><span class="line">&#123;</span><br><span class="line">    gdvData.DataSource = dc.jobs.Where(<span class="function"><span class="params">p</span> =&gt;</span> p.job_id == result);</span><br><span class="line">    gdvData.DataBind();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>相比存储过程和参数化查询，LINQ to SQL我们只需添加jobs.dbml，然后使用LINQ对表进行查询就OK了。</p>
<h4 id="1-1-3-总结"><a href="#1-1-3-总结" class="headerlink" title="1.1.3 总结"></a>1.1.3 总结</h4><p>我们在本文中介绍了SQL Injection的基本原理，通过介绍什么是SQL Injection，怎样进行SQL Injection和如何防范SQL Injection。通过一些程序源码对SQL的攻击进行了细致的分析，使我们对SQL Injection机理有了一个深入的认识，作为一名Web应用开发人员，一定不要盲目相信用户的输入，而要对用户输入的数据进行严格的校验处理，否则的话，SQL Injection将会不期而至。</p>
<p><a href="http://blog.jobbole.com/85683/" target="_blank" rel="external">关于SQL注入，你应该知道的那些事</a></p>
<p><a href="https://www.aliyun.com/zixun/content/3_15_245099.html" target="_blank" rel="external">谈谈六个防止SQL注入式攻击的建议</a></p>
<p>来源：<a href="http://blog.csdn.net/stilling2006/article/details/8526458" target="_blank" rel="external">http://blog.csdn.net/stilling2006/article/details/8526458</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2018/01/02/fm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/fm/" itemprop="url">
                  特征点检测与图像匹配
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-02 08:41:19 / 修改时间：09:34:07" itemprop="dateCreated datePublished" datetime="2018-01-02T08:41:19+08:00">2018-01-02</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/OpenCV/" itemprop="url" rel="index"><span itemprop="name">OpenCV</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>特征点又称兴趣点、关键点，它是在图像中突出且具有代表意义的一些点，通过这些点我们可以用来识别图像、进行图像配准、进行3D重建等。本文主要介绍OpenCV中几种定位与表示关键点的函数。</p>
<h4 id="一、Harris角点"><a href="#一、Harris角点" class="headerlink" title="一、Harris角点"></a>一、Harris角点</h4><p>角点是图像中最基本的一种关键点，它是由图像中一些几何结构的关节点构成，很多都是线条之间产生的交点。Harris角点是一类比较经典的角点类型，它的基本原理是计算图像中每点与周围点变化率的平均值。</p>
<p>（1）<img src="/2018/01/02/fm/1.png" alt=""></p>
<p>（2）<img src="/2018/01/02/fm/1-2.jpg" alt=""></p>
<p>其中I(x+u,y+u)代表了点(x,y)邻域点的灰度值。通过变换可以将上式变化为一个协方差矩阵求特征值的问题(2)，具体数学原理本文不过多描述。</p>
<p>OpenCV的Hairrs角点检测的函数为cornerHairrs()，但是它的输出是一幅浮点值图像，浮点值越高，表明越可能是特征角点，我们需要对图像进行阈值化。我们使用一张建筑图像来显示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mat image=imread(<span class="string">"../buliding.png"</span>);</span><br><span class="line">    Mat gray;</span><br><span class="line">    cvtColor(image,gray,CV_BGR2GRAY);</span><br><span class="line"></span><br><span class="line">    Mat cornerStrength;</span><br><span class="line">    cornerHarris(gray,cornerStrength,<span class="number">3</span>,<span class="number">3</span>,<span class="number">0.01</span>);</span><br><span class="line">    threshold(cornerStrength,cornerStrength,<span class="number">0.001</span>,<span class="number">255</span>,THRESH_BINARY);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/01/02/fm/2.png" alt=""><img src="/2018/01/02/fm/3.png" alt=""></p>
<p>首先我们来说明一下cornerHairrs()这个函数参数的意思：</p>
<p>前2参数是输入与输出，输入是一个灰度图像，输出是一个浮点图像，第三个参数指定角点分析的邻域，第4个参数实际上在角点求取过程中计算梯度图像的核窗口大小，第5个参数是它原理公式(2)中的一个系数。</p>
<p>从上面的例子的结果我们可以看到，有很多角点都是粘连在一起的，我们下面通过加入非极大值抑制来进一步去除一些粘在一起的角点。</p>
<p>非极大值抑制原理是，在一个窗口内，如果有多个角点则用值最大的那个角点，其他的角点都删除，窗口大小这里我们用3*3，程序中通过图像的膨胀运算来达到检测极大值的目的，因为默认参数的膨胀运算就是用窗口内的最大值替代当前的灰度值。程序的最后使用了一个画角点的函数将角点显示在图像中，这个函数与本系列第5篇中画角点的函数是一致的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mat image=imread(<span class="string">"../buliding.png"</span>);</span><br><span class="line">    Mat gray;</span><br><span class="line">    cvtColor(image,gray,CV_BGR2GRAY);</span><br><span class="line"></span><br><span class="line">    Mat cornerStrength;</span><br><span class="line">    cornerHarris(gray,cornerStrength,<span class="number">3</span>,<span class="number">3</span>,<span class="number">0.01</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> maxStrength;</span><br><span class="line">    <span class="keyword">double</span> minStrength;</span><br><span class="line">    <span class="comment">// 找到图像中的最大、最小值</span></span><br><span class="line">    minMaxLoc(cornerStrength,&amp;minStrength,&amp;maxStrength);</span><br><span class="line"></span><br><span class="line">    Mat dilated;</span><br><span class="line">    Mat locaMax;</span><br><span class="line">    <span class="comment">// 膨胀图像，最找出图像中全部的局部最大值点</span></span><br><span class="line">    dilate(cornerStrength,dilated,Mat());</span><br><span class="line">    <span class="comment">// compare是一个逻辑比较函数，返回两幅图像中对应点相同的二值图像</span></span><br><span class="line">    compare(cornerStrength,dilated,locaMax,CMP_EQ);</span><br><span class="line"></span><br><span class="line">    Mat cornerMap;</span><br><span class="line">    <span class="keyword">double</span> qualityLevel=<span class="number">0.01</span>;</span><br><span class="line">    <span class="keyword">double</span> th=qualityLevel*maxStrength; <span class="comment">// 阈值计算</span></span><br><span class="line">    threshold(cornerStrength,cornerMap,th,<span class="number">255</span>,THRESH_BINARY);</span><br><span class="line">    cornerMap.convertTo(cornerMap,CV_8U);</span><br><span class="line">    <span class="comment">// 逐点的位运算</span></span><br><span class="line">    bitwise_and(cornerMap,locaMax,cornerMap);</span><br><span class="line"></span><br><span class="line">    drawCornerOnImage(image,cornerMap);</span><br><span class="line">    namedWindow(<span class="string">"result"</span>);</span><br><span class="line">    imshow(<span class="string">"result"</span>,image);</span><br><span class="line">    waitKey();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">drawCornerOnImage</span><span class="params">(Mat&amp; image,<span class="keyword">const</span> Mat&amp;binary)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mat_&lt;uchar&gt;::const_iterator it=binary.begin&lt;uchar&gt;();</span><br><span class="line">    Mat_&lt;uchar&gt;::const_iterator itd=binary.end&lt;uchar&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;it!=itd;it++,i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(*it)</span><br><span class="line">            circle(image,Point(i%image.cols,i/image.cols),<span class="number">3</span>,Scalar(<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>),<span class="number">1</span>);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们得到的效果就比默认的函数得到的结果有相当的改善。</p>
<p><img src="/2018/01/02/fm/4.png" alt=""></p>
<p>由于cornerHarris的一些缺点，OpenCV提供了另一个相似的函数GoodFeaturesToTrack()它用角点间的距离限制来防止角点粘连在一起。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">goodFeaturesToTrack(image,corner,</span><br><span class="line">                  <span class="number">500</span>,    <span class="comment">// 最多检测到的角点数</span></span><br><span class="line">                     <span class="number">0.01</span>,    <span class="comment">// 阈值系数</span></span><br><span class="line">                     <span class="number">10</span>);    <span class="comment">// 角点间的最小距离</span></span><br></pre></td></tr></table></figure>
<p>它可以得到与上面基本一致的结果。</p>
<h4 id="二、FAST特征点"><a href="#二、FAST特征点" class="headerlink" title="二、FAST特征点"></a>二、FAST特征点</h4><p>harris特征在算法复杂性上比较高，在大的复杂的目标识别或匹配应用上效率不能满足要求，OpenCV提供了一个快速检测角点的类FastFeatureDetector，而实际上FAST并不是快的意思，而是Features from Accelerated Segment Test，但这个算法效率确实比较高，下面我们来看看这个类的用法。</p>
<p>OpenCV里为角点检测提供了统一的接口，通过类下面的detect方法来检测对应的角点，而输出格式都是vector<keypoint>。</keypoint></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints; </span><br><span class="line"><span class="function">FastFeatureDetector <span class="title">fast</span><span class="params">( <span class="comment">// 定义检测类</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="number">40</span>)</span></span>; <span class="comment">//40是检测的阈值</span></span><br><span class="line">fast.detect(image,keypoints);</span><br><span class="line"></span><br><span class="line">drawKeypoints(image,keypoints,image,Scalar(<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">    DrawMatchesFlags::DRAW_OVER_OUTIMG);</span><br></pre></td></tr></table></figure>
<p>其中drawKeypoints是OpenCV提供的在图像上画角点的函数。它的参数可以让我们选择用不同的方式标记出特征点。</p>
<h4 id="三、尺度不变的SURF特征"><a href="#三、尺度不变的SURF特征" class="headerlink" title="三、尺度不变的SURF特征"></a>三、尺度不变的SURF特征</h4><p>surf特征是类似于SIFT特征的一种尺度不变的特征点，它的优点在于比SIFT效率要高，在实际运算中可以达到实时性的要求，关于SURF的原理这里就不过多的介绍，网络上这类的文章很多。</p>
<p>类似于FAST特征点的求法，SURF也可以使用通用接口求得，而SURF特征的类为SurfFeatureDetector，类似的SIFT特征点的检测类为SiftFeatureDetector。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/nonfree/features2d.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mat image=imread(<span class="string">"../buliding.png"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints; </span><br><span class="line"></span><br><span class="line">    <span class="function">SurfFeatureDetector <span class="title">surf</span><span class="params">(<span class="number">2500.</span>)</span></span>;</span><br><span class="line">    surf.detect(image,keypoints);</span><br><span class="line"></span><br><span class="line">    drawKeypoints(image,keypoints,image,Scalar(<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">        DrawMatchesFlags::DRAW_RICH_KEYPOINTS);</span><br><span class="line">    namedWindow(<span class="string">"result"</span>);</span><br><span class="line">    imshow(<span class="string">"result"</span>,image);</span><br><span class="line">    waitKey();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个值得说明的问题是：OpenCV2.4版本后好像把SurfFeatureDetector这个类的定义移到了头文件nonfree/features2d.hpp</p>
<p>中，所以头文件中要加入该文件，并且要把opencv_nonfree24xd.lib加入属性表的链接器熟悉的输入中，其中x换成你当前opencv的版本号。</p>
<p>最终的显示效果如下：</p>
<p><img src="/2018/01/02/fm/5.png" alt=""></p>
<h4 id="四、SURF特征的描述"><a href="#四、SURF特征的描述" class="headerlink" title="四、SURF特征的描述"></a>四、SURF特征的描述</h4><p>在图像配准中，特征点的描述往往不是位置这么简单，而是使用了一个N维向量来描述一个特征点，这些描述子之间可以通过定义距离公式来比较相近程度。</p>
<p>SurfDescriptorExtractor 是一个提取SURF特征点以及其描述的类。</p>
<p>下面是一个宽景图像的拼接配准的例子：</p>
<p><img src="/2018/01/02/fm/6.png" alt=""><img src="/2018/01/02/fm/7.png" alt=""></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> &amp;lt;opencv2/core/core.hpp&amp;gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> &amp;lt;opencv2/highgui/highgui.hpp&amp;gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> &amp;lt;opencv2/nonfree/features2d.hpp&amp;gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> &amp;lt;opencv2/legacy/legacy.hpp&amp;gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mat image1=imread(&amp;quot;../b1.png&amp;quot;);</span><br><span class="line">    Mat image2=imread(&amp;quot;../b2.png&amp;quot;);</span><br><span class="line">    <span class="comment">// 检测surf特征点</span></span><br><span class="line">    <span class="built_in">vector</span>&amp;lt;KeyPoint&amp;gt; keypoints1,keypoints2;     </span><br><span class="line">    <span class="function">SurfFeatureDetector <span class="title">detector</span><span class="params">(<span class="number">400</span>)</span></span>;</span><br><span class="line">    detector.detect(image1, keypoints1);</span><br><span class="line">    detector.detect(image2, keypoints2);</span><br><span class="line">    <span class="comment">// 描述surf特征点</span></span><br><span class="line">    SurfDescriptorExtractor surfDesc;</span><br><span class="line">    Mat descriptros1,descriptros2;</span><br><span class="line">    surfDesc.compute(image1,keypoints1,descriptros1);</span><br><span class="line">    surfDesc.compute(image2,keypoints2,descriptros2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算匹配点数</span></span><br><span class="line">    BruteForceMatcher&amp;lt;L2&amp;lt;<span class="keyword">float</span>&amp;gt;&amp;gt;matcher;</span><br><span class="line">    <span class="built_in">vector</span>&amp;lt;DMatch&amp;gt; matches;</span><br><span class="line">    matcher.match(descriptros1,descriptros2,matches);</span><br><span class="line">    <span class="built_in">std</span>::nth_element(matches.begin(),matches.begin()+<span class="number">24</span>,matches.end());</span><br><span class="line">    matches.erase(matches.begin()+<span class="number">25</span>,matches.end());</span><br><span class="line">    <span class="comment">// 画出匹配图</span></span><br><span class="line">    Mat imageMatches;</span><br><span class="line">    drawMatches(image1,keypoints1,image2,keypoints2,matches,</span><br><span class="line">        imageMatches,Scalar(<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    namedWindow(&amp;quot;image2&amp;quot;);</span><br><span class="line">    imshow(&amp;quot;image2&amp;quot;,image2);</span><br><span class="line">    waitKey();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序中我们选择了25个配准点，得到最后的匹配如下：</p>
<p><img src="/2018/01/02/fm/8.png" alt=""></p>
<p>来源：<a href="http://www.cnblogs.com/ronny/p/opencv_road_9.html" target="_blank" rel="external">http://www.cnblogs.com/ronny/p/opencv_road_9.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/12/14/iot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/14/iot/" itemprop="url">
                  物联网平台
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-14 07:49:28 / 修改时间：08:04:33" itemprop="dateCreated datePublished" datetime="2017-12-14T07:49:28+08:00">2017-12-14</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/行业/" itemprop="url" rel="index"><span itemprop="name">行业</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.cnblogs.com/ibrahim/p/iot-platform-outline.html" target="_blank" rel="external">《国内物联网平台初探》和《国外物联网平台初探》系列文章</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/12/10/drawtext/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/drawtext/" itemprop="url">
                  Android drawText获取text宽度的三种方式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-10 22:13:24 / 修改时间：22:17:03" itemprop="dateCreated datePublished" datetime="2017-12-10T22:13:24+08:00">2017-12-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">"Hello"</span>;</span><br><span class="line">canvas.drawText( str , x , y , paint);</span><br><span class="line"></span><br><span class="line"><span class="comment">//1. 粗略计算文字宽度</span></span><br><span class="line">Log.d(TAG, <span class="string">"measureText="</span> + paint.measureText(str));</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 计算文字所在矩形，可以得到宽高</span></span><br><span class="line">Rect rect = <span class="keyword">new</span> Rect();</span><br><span class="line">paint.getTextBounds(str, <span class="number">0</span>, str.length(), rect);</span><br><span class="line"><span class="keyword">int</span> w = rect.width();</span><br><span class="line"><span class="keyword">int</span> h = rect.height();</span><br><span class="line">Log.d(TAG, <span class="string">"w="</span> +w+<span class="string">"  h="</span>+h);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 精确计算文字宽度</span></span><br><span class="line"><span class="keyword">int</span> textWidth = getTextWidth(paint, str);</span><br><span class="line">Log.d(TAG, <span class="string">"textWidth="</span> + textWidth);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTextWidth</span><span class="params">(Paint paint, String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> iRet = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> len = str.length();</span><br><span class="line">            <span class="keyword">float</span>[] widths = <span class="keyword">new</span> <span class="keyword">float</span>[len];</span><br><span class="line">            paint.getTextWidths(str, widths);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">                iRet += (<span class="keyword">int</span>) Math.ceil(widths[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> iRet;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>备注：如果要测量一段文字，要整体测量，不要单个字测量而后叠加，因为字与字有间距</p>
<p>来源：<a href="http://blog.csdn.net/chuekup/article/details/7518239" target="_blank" rel="external">http://blog.csdn.net/chuekup/article/details/7518239</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/11/26/jvm-mem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/26/jvm-mem/" itemprop="url">
                  JVM之内存结构详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-11-26 18:47:51 / 修改时间：18:55:07" itemprop="dateCreated datePublished" datetime="2017-11-26T18:47:51+08:00">2017-11-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>相信大多数Javaer对Java的内存结构都有一定的了解，但如果对于Java的内存结构只停留的”堆”，”栈”中显然是不够的。今天来给大家详细谈一谈Java的内存区域结构，本文基于 JDK7 的内存结构做讲解，JDK8的内存结构加上了metaspace,有些许变动，想详细了解的同学请自行翻阅相关资料。</p>
<p>文章结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">内存结构图</span><br><span class="line"></span><br><span class="line">根据内存结构图各个区域做详细讲解</span><br></pre></td></tr></table></figure></p>
<h3 id="1-内存结构图"><a href="#1-内存结构图" class="headerlink" title="1 . 内存结构图"></a>1 . 内存结构图</h3><p><img src="/2017/11/26/jvm-mem/1.png" alt=""></p>
<p>图片说明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">方法区,堆区(标绿)为所有线程共享的内存区域,虚拟机栈,本地方法栈,程序计数器(标蓝)为线程私有的内存区域，即线程隔离的。</span><br></pre></td></tr></table></figure></p>
<h3 id="2-各个区域详解"><a href="#2-各个区域详解" class="headerlink" title="2 . 各个区域详解"></a>2 . 各个区域详解</h3><h4 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h4><p>代码的运行是有顺序的，但当CPU在多线程间切换时，当从A线程切换到B线程，再切回到A线程时，CPU如何知道该从A线程的哪里继续执行呢？CPU工作时就是根据每个线程的程序计数器的值来选取下一条需要执行的字节码指令，即”找到它离开时的位置来继续执行”。需要提示的是，当CPU执行的是一个Java方法时，程序计数器记录的是正在执行的虚拟机字节码指令的地址。如果执行的是Native方法，这个计数器值为Undefined，即不发挥作用。</p>
<h4 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h4><p>虚拟机栈描述的是Java方法执行的内存模型:每个方法在执行的同时都会创建一个栈帧用于存储局部变量表，操作数栈，动态链接，方法出口等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈和出栈的过程。局部变量表存放了编译期间可以知道大小的各种类型变量，它所需要的内存空间大小在编译期间就已经分配，当一个方法被调用时，栈帧进入虚拟机栈，在运行期间，局部变量表大小是不会变化的。</p>
<h4 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h4><p>本地方法栈与虚拟机栈锁发挥的作用是非常相似的，它们之间的区别不过是虚拟机栈为虚拟机执行Java方法服务，而本地方法栈为虚拟机执行Native方法服务。需要注意的是，由于虚拟机规范对于本地方法栈的具体实现没有做强制要求，所以Sun HotSpot直接把本地方法栈和虚拟机栈合二为一。</p>
<h4 id="Java堆"><a href="#Java堆" class="headerlink" title="Java堆"></a>Java堆</h4><p>Java堆是Javaer需要重点关注的一块区域，因为涉及到内存的分配(new关键字，反射等)与回收(回收算法，收集器等)，这里不做太多详细的介绍内存的分配与回收，后期有时间专门出博客讲解。在Java虚拟机规范中的描述是:所有对象实例以及数组都要在堆上分配。需要特别注意的是，线程共享的Java堆中可能分出多个线程私有的分配缓冲区(TLAB,这是为了并发分配内存时的脏分配问题，需要使用相关参数来开启。虚拟机默认使用CAS加上失败重试机制解决脏分配问题)。此外，Java堆在HotSpot中的实现是可扩展的。参数-Xmx/-Xms来控制。</p>
<h4 id="方法区-永久代"><a href="#方法区-永久代" class="headerlink" title="方法区(永久代)"></a>方法区(永久代)</h4><p>方法区用于存储已经被虚拟机加载的类信息，常量(“zdy”,”123”等)，静态变量(static变量)等数据。方法区有一个别名叫永久代(Permanent Generation),这是因为HotSpot设计团队把GC分代收集扩展至方法区，这样HotSpot的垃圾收集器可以像管理Java堆一样管理这部分内存，能够省钱专门为方法区编写内存管理代码的工作。对于其他虚拟机(J9)等，是没有永久代这个概念的。永久代的配置参数: -XX:MaxPermSize</p>
<h4 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h4><p>运行时常量池是方法区的一部分，用于存放编译期生成的各种字面量(“zdy”,”123”等)和符号引用。运行时常量池具有动态性，并非只有Class文件中的内容才能进入运行时常量池，运行期间也能将新的常量放入池中。如String.intern（）方法。</p>
<h4 id="附加–直接内存"><a href="#附加–直接内存" class="headerlink" title="附加–直接内存"></a>附加–直接内存</h4><p>直接内存不是Java虚拟机规范的内存区域。但是这部分也被Javaer频繁使用，而且也会导致OutOfMember异常。所以这里顺带提一提。在JDK4中加入的NIO，使用了Native函数库直接分配堆外内存，然后通过一个缓存在Java堆中的Buffer来指向这块地址进行操作。这样能够避免Java堆和Native堆来回复制数据，在某些场景可以显著提高性能。直接内存不受任何虚拟机参数控制，但很明显，你不能大于物理内存大小。</p>
<p>结语</p>
<p>JDK7的内存模型就大致介绍完了，JVM系列博客后期将带给大家更加深入的内容，下期预告:<a href="https://link.juejin.im/?target=https%3A%2F%2Fjuejin.im%2Fpost%2F5a162f16f265da432c23839a" target="_blank" rel="external">JVM系列之实战内存溢出异常</a></p>
<p>来源：<a href="https://juejin.im/post/5a14de6751882555cc417df7" target="_blank" rel="external">https://juejin.im/post/5a14de6751882555cc417df7</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">107</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.4.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
