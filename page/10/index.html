<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Codes Online">
<meta property="og:url" content="http://51codes.top/page/10/index.html">
<meta property="og:site_name" content="Codes Online">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Codes Online">






  <link rel="canonical" href="http://51codes.top/page/10/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Codes Online</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Codes Online</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _enjoying</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/20/ssm-study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/20/ssm-study/" itemprop="url">
                  SSM教程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-20 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-20T23:47:44+08:00">2017-10-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 05:33:02" itemprop="dateModified" datetime="2017-11-11T05:33:02+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>SSM: Spring + SpringMVC + Mybatis ( + MySQL )</strong></p>
<p><strong>视频教程地址：</strong></p>
<p><a href="https://ke.qq.com/course/203446" target="_blank" rel="external">https://ke.qq.com/course/203446</a></p>
<p><strong>项目效果图地址：</strong></p>
<p><a href="http://duoqux.com/ssm-crud/" target="_blank" rel="external">http://duoqux.com/ssm-crud/</a></p>
<p><strong>Spring Cloud &lt;- Spring Boot &lt;- SpringMVC</strong></p>
<p>(SSH或者SSM选一种入门, SSH-&gt;Spring + Struct2 + Hibernate)</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/19/canvas-bitmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/19/canvas-bitmap/" itemprop="url">
                  Android中使用Canvas绘制Bitmap模糊问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-19 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-19T23:47:44+08:00">2017-10-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 05:30:04" itemprop="dateModified" datetime="2017-11-11T05:30:04+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="描述："><a href="#描述：" class="headerlink" title="描述："></a>描述：</h3><p>这两天排查公司一个作图软件Android客户端的bug，代码中使用了canvas绘制bitmap，并保存为单位元图, 通过单位元图再使用canvas绘制出一张平铺效果的大图，最后获得的大图始终都很模糊。</p>
<h3 id="可能原因分析："><a href="#可能原因分析：" class="headerlink" title="可能原因分析："></a>可能原因分析：</h3><p>1-Paint未设置抗锯齿属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">paint.setAntiAlias(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>2-保存单位元图到sdcard时候使用了压缩</p>
<p>3-读取单位元图文件，用canvas绘制时候，对单位元图做了矩阵缩放，导致最终的大图模糊</p>
<p>4-保存最终大图的bitmap到sdcard时被压缩了</p>
<h3 id="问题解决："><a href="#问题解决：" class="headerlink" title="问题解决："></a>问题解决：</h3><p>1-&gt;4各检查一遍原因，发现单位元图加载到内存时候被做了矩阵缩放，导致元图本身就模糊了，修改了这个问题后，大图较之前清晰很多但依然不够清晰，最后从海量资料中，<strong>发现对canvas设置抗锯齿属性后，图片明显清晰。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.setDrawFilter(<span class="keyword">new</span> PaintFlagsDrawFilter(<span class="number">0</span>, Paint.ANTI_ALIAS_FLAG|Paint.FILTER_BITMAP_FLAG));</span><br></pre></td></tr></table></figure>
<hr>
<p>附：搜集资料中，发现一篇html5 canvas绘制图片模糊的问题</p>
<h2 id="解决canvas画图模糊的问题"><a href="#解决canvas画图模糊的问题" class="headerlink" title="解决canvas画图模糊的问题"></a>解决canvas画图模糊的问题</h2><p>canvas 画图经常发现他是模糊的。解决这个问题主要从两个方面下手。</p>
<h3 id="1、改变canvas渲染的像素"><a href="#1、改变canvas渲染的像素" class="headerlink" title="1、改变canvas渲染的像素"></a>1、改变canvas渲染的像素</h3><p>情况：画1像素的线条看起来模糊不清，好像更宽的样子。</p>
<p><img src="/2017/10/19/canvas-bitmap/1.jpeg" alt=""></p>
<p>解决方案</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var ctx = canvas.getContext(&apos;2d&apos;);</span><br><span class="line">ctx.translate(0.5, 0.5);</span><br></pre></td></tr></table></figure>
<p>原理：大家都知道屏幕最小单位就是像素。假如把canvas放的足够大，我能看到下面样子。</p>
<p><img src="/2017/10/19/canvas-bitmap/2.png" alt=""></p>
<p>每一个方格就是长和宽都为1px。当我们画1px线条时遵循像素的起止范围，我们能得到标准的细线。</p>
<p><img src="/2017/10/19/canvas-bitmap/3.png" alt=""></p>
<p>但遗憾的是canvas的画法不一样。canvas的每条线都有一条无限细的“中线”，线条的宽度是从中线向两侧延伸的。如果我们还是从第2个像素点画一条线，那么线条的中线就会靠齐到第2个像素的起点，然后我们开始画了，问题也就来了：Canvas 的线条以中线向两侧延伸，而不是向某一边延伸(比如这里，如果只是往右侧延伸，那么我们的问题就不再是问题了)，延伸过后我们的线条实际上是这样的：</p>
<p><img src="/2017/10/19/canvas-bitmap/4.png" alt=""></p>
<p>但是计算机不允许出现&lt;1px的图形。所以会做个折中，把两个像素都绘制了。如此一来，本来1px的线条，就成了看起来2px宽的线条。<br>如何解决这个问题，就是把线条中线和和像素中间点对齐就行了。</p>
<p>中间点位置很好找，向后移动0.5px。所以你们画线时可以这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx.moveTo(100.5,100.5);</span><br><span class="line">ctx.lineTo(200.5,100.5);</span><br><span class="line">ctx.lineTo(200.5,200.5);</span><br><span class="line">ctx.lineTo(100.5,200.5);</span><br><span class="line">ctx.lineTo(100.5,100.5);</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.translate(0.5, 0.5);</span><br></pre></td></tr></table></figure>
<h3 id="2-设置显示比例"><a href="#2-设置显示比例" class="headerlink" title="2.设置显示比例"></a>2.设置显示比例</h3><p>在浏览器的window变量中有一个devicePixelRatio的属性，该属性决定了浏览器会用几个（通常是2个）像素点来渲染1个像素，举例来说，假设某个屏幕的devicePixelRatio的值为2，一张100x100像素大小的图片，在此屏幕下，会用2个像素点的宽度去渲染图片的1个像素点，因此该图片在此屏幕上实际会占据200x200像素的空间，相当于图片被放大了一倍，因此图片会变得模糊。<br>**其实方案很简单，也很容易明白。我们可以创建一个两倍于实际大小的canvas，然后用css样式把canvas限定在实际的大小。<br>下面是实现具体代码例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">var canvas = document.getElementById(&quot;canvas&quot;)</span><br><span class="line">context= canvas.getContext(&quot;2d&quot;);  </span><br><span class="line">var devicePixelRatio = window.devicePixelRatio || 1;</span><br><span class="line">var backingStoreRatio = context.webkitBackingStorePixelRatio ||</span><br><span class="line">        context.mozBackingStorePixelRatio ||</span><br><span class="line">        context.msBackingStorePixelRatio ||</span><br><span class="line">        context.oBackingStorePixelRatio ||</span><br><span class="line">        context.backingStorePixelRatio || 1;</span><br><span class="line">var ratio = devicePixelRatio / backingStoreRatio;</span><br><span class="line">canvas.width = canvas.width * ratio;</span><br><span class="line">canvas.width = canvas.height* ratio;</span><br><span class="line">context.scale(ratio, ratio);</span><br><span class="line">ctx.translate(0.5, 0.5);</span><br><span class="line">ctx.lineWidth = 1;</span><br><span class="line">ctx.moveTo(2.5, 2);</span><br><span class="line">ctx.lineTo(98.5, 2);</span><br><span class="line">ctx.lineTo(98.5, 98);</span><br><span class="line">ctx.lineTo(2.5, 98);</span><br><span class="line">ctx.lineTo(2.5, 2);</span><br><span class="line">ctx.stroke();</span><br></pre></td></tr></table></figure>
<p>如果css限定了诸如width: 100%;<br>请使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var oldWidth = parseInt(window.getComputedStyle(canvas).width);</span><br><span class="line">canvas.width = oldWidth * ratio;</span><br></pre></td></tr></table></figure>
<p>之后再</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.style.width = oldWidth + &apos;px&apos;;</span><br></pre></td></tr></table></figure>
<p>不然会有超出问题</p>
<p>来源：<a href="https://segmentfault.com/a/1190000004505090" target="_blank" rel="external">https://segmentfault.com/a/1190000004505090</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/19/hive-hbase/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/19/hive-hbase/" itemprop="url">
                  Hbase和Hive的差别
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-19 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-19T23:47:44+08:00">2017-10-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 05:07:11" itemprop="dateModified" datetime="2017-11-11T05:07:11+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>Hbase和Hive在大数据架构中处在不同位置，Hbase主要解决实时数据查询问题，Hive主要解决数据处理和计算问题，一般是配合使用。</strong></p>
<h3 id="一、区别："><a href="#一、区别：" class="headerlink" title="一、区别："></a>一、区别：</h3><p>Hbase： Hadoop database 的简称，也就是基于Hadoop数据库，是一种NoSQL数据库，主要适用于海量明细数据（十亿、百亿）的随机实时查询，如日志明细、交易清单、轨迹行为等。Hive：Hive是Hadoop数据仓库，严格来说，不是数据库，主要是让开发人员能够通过SQL来计算和处理HDFS上的结构化数据，适用于离线的批量数据计算。</p>
<p>通过元数据来描述Hdfs上的结构化文本数据，通俗点来说，就是定义一张表来描述HDFS上的结构化文本，包括各列数据名称，数据类型是什么等，方便我们处理数据，当前很多SQL ON Hadoop的计算引擎均用的是hive的元数据，如Spark SQL、Impala等；</p>
<p>基于第一点，通过SQL来处理和计算HDFS的数据，Hive会将SQL翻译为Mapreduce来处理数据；</p>
<h3 id="二、关系"><a href="#二、关系" class="headerlink" title="二、关系"></a>二、关系</h3><p>在大数据架构中，Hive和HBase是协作关系，数据流一般如下图：</p>
<p><img src="/2017/10/19/hive-hbase/1.jpg" alt=""></p>
<p>1-通过ETL工具将数据源抽取到HDFS存储；</p>
<p>2-通过Hive清洗、处理和计算原始数据；</p>
<p>3-HIve清洗处理后的结果，如果是面向海量数据随机查询场景的可存入Hbase</p>
<p>4-数据应用从HBase查询数据；</p>
<p>来源：<a href="https://www.zhihu.com/question/21677041/answer/185664626" target="_blank" rel="external">https://www.zhihu.com/question/21677041/answer/185664626</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/16/tomcat-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/16/tomcat-intro/" itemprop="url">
                  Tomcat工作原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-16 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-16T23:47:44+08:00">2017-10-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 04:43:44" itemprop="dateModified" datetime="2017-11-11T04:43:44+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>基于Java的Web 应用程序是 servlet、JSP 页面、静态页面、类和其他资源的集合，它们可以用标准方式打包，并运行在来自多个供应商的多个容器。Web 应用程序存在于结构化层次结构的目录中，该层次结构是由 Java Servlet 规范定义的。Web 应用程序的根目录包含直接存储或存储在子文件夹中的所有公共资源，比如图像、HTML 页面等。构成：Web应用由Web组件(一组Java类库)、html文件，静态资源文件（如图像）、帮助类和库组成。</p>
<h3 id="1-–-Tomcat-Server的组成部分"><a href="#1-–-Tomcat-Server的组成部分" class="headerlink" title="1 – Tomcat Server的组成部分"></a>1 – Tomcat Server的组成部分</h3><h3 id="1-1-–-Server"><a href="#1-1-–-Server" class="headerlink" title="1.1 – Server"></a>1.1 – Server</h3><p>A Server element represents the entire Catalina servlet container. (Singleton)</p>
<h3 id="1-2-–-Service"><a href="#1-2-–-Service" class="headerlink" title="1.2 – Service"></a>1.2 – Service</h3><p>A Service element represents the combination of one or more Connector components that share a single Engine</p>
<p>Service是这样一个集合：它由一个或者多个Connector组成，以及一个Engine，负责处理所有Connector所获得的客户请求</p>
<h3 id="1-3-–-Connector"><a href="#1-3-–-Connector" class="headerlink" title="1.3 – Connector"></a>1.3 – Connector</h3><p>一个Connector将在某个指定端口上侦听客户请求，并将获得的请求交给Engine来处理，从Engine处获得回应并返回客户</p>
<p>TOMCAT有两个典型的Connector，一个直接侦听来自browser的http请求，一个侦听来自其它WebServer的请求</p>
<p>Coyote Http/1.1 Connector 在端口8080处侦听来自客户browser的http请求</p>
<p>Coyote JK2 Connector 在端口8009处侦听来自其它WebServer(Apache)的servlet/jsp代理请求</p>
<h3 id="1-4-–-Engine"><a href="#1-4-–-Engine" class="headerlink" title="1.4 – Engine"></a>1.4 – Engine</h3><p>The Engine element represents the entire request processing machinery associated with a particular Service<br>It receives and processes all requests from one or more Connectors<br>and returns the completed response to the Connector for ultimate transmission back to the client</p>
<p>Engine下可以配置多个虚拟主机Virtual Host，每个虚拟主机都有一个域名<br>当Engine获得一个请求时，它把该请求匹配到某个Host上，然后把该请求交给该Host来处理</p>
<p>Engine有一个默认虚拟主机，当请求无法匹配到任何一个Host上的时候，将交给该默认Host来处理</p>
<h3 id="1-5-–-Host"><a href="#1-5-–-Host" class="headerlink" title="1.5 – Host"></a>1.5 – Host</h3><p>代表一个Virtual Host，虚拟主机，每个虚拟主机和某个网络域名Domain Name相匹配</p>
<p>每个虚拟主机下都可以部署(deploy)一个或者多个Web App，每个Web App对应于一个Context，有一个Context path</p>
<p>当Host获得一个请求时，将把该请求匹配到某个Context上，然后把该请求交给该Context来处理</p>
<p>匹配的方法是“最长匹配”，所以一个path==””的Context将成为该Host的默认Context</p>
<p>所有无法和其它Context的路径名匹配的请求都将最终和该默认Context匹配</p>
<h3 id="1-6-–-Context"><a href="#1-6-–-Context" class="headerlink" title="1.6 – Context"></a>1.6 – Context</h3><p>一个Context对应于一个Web Application，一个Web Application由一个或者多个Servlet组成</p>
<p>Context在创建的时候将根据配置文件$CATALINA_HOME/conf/web.xml和$WEBAPP_HOME/WEB-INF/web.xml载入Servlet类</p>
<p>当Context获得请求时，将在自己的映射表(mapping table)中寻找相匹配的Servlet类</p>
<p>如果找到，则执行该类，获得请求的回应，并返回</p>
<h3 id="2-–-Tomcat-Server的结构图"><a href="#2-–-Tomcat-Server的结构图" class="headerlink" title="2 – Tomcat Server的结构图"></a>2 – Tomcat Server的结构图</h3><p><img src="/2017/10/16/tomcat-intro/1.png" alt=""></p>
<h3 id="3-–-配置文件-CATALINA-HOME-conf-server-xml的说明"><a href="#3-–-配置文件-CATALINA-HOME-conf-server-xml的说明" class="headerlink" title="3 – 配置文件$CATALINA_HOME/conf/server.xml的说明"></a>3 – 配置文件$CATALINA_HOME/conf/server.xml的说明</h3><p>该文件描述了如何启动Tomcat Server</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!-----------------------------------------------------------------------------------------------&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 启动Server 在端口8005处等待关闭命令 如果接受到"SHUTDOWN"字符串则关闭服务器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span> <span class="attr">debug</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Listener ??? 目前没有看到这里 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.ServerLifecycleListener"</span> <span class="attr">debug</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> <span class="attr">debug</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Global JNDI resources ??? 目前没有看到这里，先略去 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line"> ... ... ... ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Tomcat的Standalone Service Service是一组Connector的集合 它们共用一个Engine来处理所有Connector收到的请求 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Tomcat-Standalone"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Coyote HTTP/1.1 Connector className : 该Connector的实现类是org.apache.coyote.tomcat4.CoyoteConnector port :</span></span><br><span class="line"><span class="comment">在端口号8080处侦听来自客户browser的HTTP1.1请求 minProcessors : 该Connector先创建5个线程等待客户请求，</span></span><br><span class="line"><span class="comment">每个请求由一个线程负责 maxProcessors : 当现有的线程不够服务客户请求时，若线程总数不足75个，则创建新线程来处理请求</span></span><br><span class="line"><span class="comment">acceptCount : 当现有线程已经达到最大数75时，为客户请求排队 当队列中请求数超过100时，后来的请求返回Connection refused</span></span><br><span class="line"><span class="comment">错误 redirectport : 当客户请求是https时，把该请求转发到端口8443去 其它属性略 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">className</span>=<span class="string">"org.apache.coyote.tomcat4.CoyoteConnector"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">port</span>=<span class="string">"8080"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">minProcessors</span>=<span class="string">"5"</span> <span class="attr">maxProcessors</span>=<span class="string">"75"</span> <span class="attr">acceptCount</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">enableLookups</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">redirectPort</span>=<span class="string">"8443"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">debug</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">useURIValidationHack</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">disableUploadTimeout</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Engine用来处理Connector收到的Http请求 它将匹配请求和自己的虚拟主机，</span></span><br><span class="line"><span class="comment">并把请求转交给对应的Host来处理默认虚拟主机是localhost --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Standalone"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span> <span class="attr">debug</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 日志类，目前没有看到，略去先 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Logger</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.logger.FileLogger"</span> <span class="attr">...</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Realm，目前没有看到，略去先 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span> <span class="attr">...</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 虚拟主机localhost appBase : 该虚拟主机的根目录是webapps/ 它将匹配请求和</span></span><br><span class="line"><span class="comment">自己的Context的路径，并把请求转交给对应的Context来处理 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 日志类，目前没有看到，略去先 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Logger</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.logger.FileLogger"</span> <span class="attr">...</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Context，对应于一个Web App path : 该Context的路径名是""，故该Context是该Host的</span></span><br><span class="line"><span class="comment">默认Context docBase : 该Context的根目录是webapps/mycontext/ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"mycontext"</span> <span class="attr">debug</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 另外一个Context，路径名是/wsota --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">"/wsota"</span> <span class="attr">docBase</span>=<span class="string">"wsotaProject"</span> <span class="attr">debug</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-----------------------------------------------------------------------------------------------&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-–-Context的部署配置文件web-xml的说明"><a href="#4-–-Context的部署配置文件web-xml的说明" class="headerlink" title="4 – Context的部署配置文件web.xml的说明"></a>4 – Context的部署配置文件web.xml的说明</h3><p>一个Context对应于一个Web App，每个Web App是由一个或者多个servlet组成的</p>
<p>当一个Web App被初始化的时候，它将用自己的ClassLoader对象载入“部署配置文件web.xml”中定义的每个servlet类</p>
<p>它首先载入在$CATALINA_HOME/conf/web.xml中部署的servlet类</p>
<p>然后载入在自己的Web App根目录下的WEB-INF/web.xml中部署的servlet类<br>web.xml文件有两部分：servlet类定义和servlet映射定义</p>
<p>每个被载入的servlet类都有一个名字，且被填入该Context的映射表(mapping table)中，和某种URL PATTERN对应</p>
<p>当该Context获得请求时，将查询mapping table，找到被请求的servlet，并执行以获得请求回应</p>
<p>分析一下所有的Context共享的web.xml文件，在其中定义的servlet被所有的Web App载入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!-----------------------------------------------------------------------------------------------&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 概述： 该文件是所有的WEB APP共用的部署配置文件， 每当一个WEB APP</span></span><br><span class="line"><span class="comment">被DEPLOY，该文件都将先被处理，然后才是WEB APP自己的/WEB-INF/web.xml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- +-------------------------+ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- | servlet类定义部分 | --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- +-------------------------+ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- DefaultServlet</span></span><br><span class="line"><span class="comment">当用户的HTTP请求无法匹配任何一个servlet的时候，该servlet被执行</span></span><br><span class="line"><span class="comment">URL PATTERN MAPPING : / --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">org.apache.catalina.servlets.DefaultServlet</span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>0<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>listings<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- InvokerServlet</span></span><br><span class="line"><span class="comment">处理一个WEB APP中的匿名servlet 当一个servlet被编写并编译放入</span></span><br><span class="line"><span class="comment">/WEB-INF/classes/中，却没有在/WEB-INF/web.xml中定义的时候</span></span><br><span class="line"><span class="comment">该servlet被调用，把匿名servlet映射成/servlet/ClassName的形式</span></span><br><span class="line"><span class="comment">URL PATTERN MAPPING : /servlet/* --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>invoker<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.catalina.servlets.InvokerServlet <span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>0<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>2<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- JspServlet</span></span><br><span class="line"><span class="comment">当请求的是一个JSP页面的时候（*.jsp）该servlet被调用</span></span><br><span class="line"><span class="comment">它是一个JSP编译器，将请求的JSP页面编译成为servlet再执行</span></span><br><span class="line"><span class="comment">URL PATTERN MAPPING : *.jsp --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.jasper.servlet.JspServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>logVerbosityLevel<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>WARNING<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>3<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- +---------------------------+ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- | servlet映射定义部分 | --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- +---------------------------+ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>invoker<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/servlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- +------------------------+ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- | 其它部分，略去先 | --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- +------------------------+ --&gt;</span></span><br><span class="line">... ... ... ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-----------------------------------------------------------------------------------------------&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-–-Tomcat-Server处理一个http请求的过程"><a href="#5-–-Tomcat-Server处理一个http请求的过程" class="headerlink" title="5 – Tomcat Server处理一个http请求的过程"></a>5 – Tomcat Server处理一个http请求的过程</h3><p>假设来自客户的请求为：</p>
<p><a href="http://localhost:8080/wsota/wsota_index.jsp" target="_blank" rel="external">http://localhost:8080/wsota/wsota_index.jsp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1) 请求被发送到本机端口8080，被在那里侦听的Coyote HTTP/1.1 Connector获得</span><br><span class="line">2) Connector把该请求交给它所在的Service的Engine来处理，并等待来自Engine的回应</span><br><span class="line">3) Engine获得请求localhost/wsota/wsota_index.jsp，匹配它所拥有的所有虚拟主机Host</span><br><span class="line">4) Engine匹配到名为localhost的Host（即使匹配不到也把请求交给该Host处理，因为该Host被定义为该Engine的默认主机）</span><br><span class="line">5) localhost Host获得请求/wsota/wsota_index.jsp，匹配它所拥有的所有Context</span><br><span class="line">6) Host匹配到路径为/wsota的Context（如果匹配不到就把该请求交给路径名为”&quot;的Context去处理）</span><br><span class="line">7) path=”/wsota”的Context获得请求/wsota_index.jsp，在它的mapping table中寻找对应的servlet</span><br><span class="line">8) Context匹配到URL PATTERN为*.jsp的servlet，对应于JspServlet类</span><br><span class="line">9) 构造HttpServletRequest对象和HttpServletResponse对象，作为参数调用JspServlet的doGet或doPost方法</span><br><span class="line">10)Context把执行完了之后的HttpServletResponse对象返回给Host</span><br><span class="line">11)Host把HttpServletResponse对象返回给Engine</span><br><span class="line">12)Engine把HttpServletResponse对象返回给Connector</span><br><span class="line">13)Connector把HttpServletResponse对象返回给客户browser</span><br></pre></td></tr></table></figure>
<p>来源：<a href="http://www.cnblogs.com/boblogsbo/p/5207205.html" target="_blank" rel="external">http://www.cnblogs.com/boblogsbo/p/5207205.html</a></p>
<hr>
<h2 id="tomcat配置多个虚拟主机"><a href="#tomcat配置多个虚拟主机" class="headerlink" title="tomcat配置多个虚拟主机"></a>tomcat配置多个虚拟主机</h2><p>先修改默认端口（8080），http的默认端口是80，我们将8080改成80，这样域名就不用带上端口了</p>
<p>修改conf文件夹下的server.xml文件</p>
<p>添加多个主机(以下三个主机对应三个域名，三个域名对应同一个ip地址)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">appBase</span>=<span class="string">"D:"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">name</span>=<span class="string">"wap.test.com"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">"D:\wap"</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> <span class="attr">crossContext</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">appBase</span>=<span class="string">"D:"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">name</span>=<span class="string">"web.test.com"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">"D:\web"</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> <span class="attr">crossContext</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">appBase</span>=<span class="string">"D:"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">name</span>=<span class="string">"manage.test.com"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">"D:\manage"</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> <span class="attr">crossContext</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>&lt;host&gt;</code>中的元素：appBase–&gt;项目文件夹的父目录 name–&gt;该主机对应的域名，其他元素自己百度</p>
<p><code>&lt;context&gt;</code>中的元素：docBase–&gt;对应项目文件夹或者项目的.war包（如果是war包，就需要把unpackWARs设置为true）</p>
<p>path–&gt;访问时如果要带上项目名就添加项目名，不需要（直接域名访问）就为空。</p>
<p>我们在windows中测试：修改C:\Windows\System32\drivers\etc下的hosts文件。添加三个模拟的域名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1       wap.test.com</span><br><span class="line">127.0.0.1       web.test.com</span><br><span class="line">127.0.0.1       manage.test.com</span><br></pre></td></tr></table></figure></p>
<p>三个域名对应的是同一个ip地址，即本地的ip地址。</p>
<p>来源: <a href="http://www.cnblogs.com/LvLoveYuForever/p/5886788.html" target="_blank" rel="external">http://www.cnblogs.com/LvLoveYuForever/p/5886788.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/16/spring-web-xml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/16/spring-web-xml/" itemprop="url">
                  web.xml中定义的Spring的XML配置文件启动顺序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-16 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-16T23:47:44+08:00">2017-10-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 04:52:19" itemprop="dateModified" datetime="2017-11-11T04:52:19+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="启动顺序"><a href="#启动顺序" class="headerlink" title="启动顺序"></a>启动顺序</h3><p>在web.xml中定义的Spring的配置文件一般有两个：<br>1、Spring上下文环境的配置文件：applicationContext.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">        classpath:applicationContext.xml</span><br><span class="line">    <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、SpringMVC配置文件：spring-servlet.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-servlet.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>加载顺序是：首先加载Spring上下文环境配置文件，然后加载SpringMVC配置文件，并且如果配置了相同的内容，SpringMVC配置文件会被优先使用。<br>所以这里需要注意一个问题，一定要注意SpringMVC配置文件内容不要把Spring上下文环境配置文件内容覆盖掉。</strong></p>
<p>比如在Spring上下文环境配置文件中先引入service层，然后又加入了事务：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.acms.service"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- define the transaction manager --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManagerOracle"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSourceOracle"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManagerOracle"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是在SpringMVC配置文件中却默认引入所有类（当然也包括service层），但是没有加入事务</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.acms"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>那么这时事务功能是无法起作用的，也就是代码中加入@Transactional注解是无效的。</p>
<p>所以为了防止这种问题一般是在Spring上下文配置文件中引入所有的类，并且加上事务：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.acms"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- define the transaction manager --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManagerOracle"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSourceOracle"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManagerOracle"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>而在SpringMVC配置文件中只引入controller层：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.acms.controller"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.acms.*.controller"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>来源：<a href="http://blog.csdn.net/trigl/article/details/52073457" target="_blank" rel="external">http://blog.csdn.net/trigl/article/details/52073457</a></p>
<hr>
<h2 id="Spring-MVC的web-xml配置详解"><a href="#Spring-MVC的web-xml配置详解" class="headerlink" title="Spring MVC的web.xml配置详解"></a>Spring MVC的web.xml配置详解</h2><p>1、Spring 框架解决字符串编码问题：过滤器 CharacterEncodingFilter（filter-name）</p>
<p>2、在web.xml配置监听器ContextLoaderListener（listener-class）<br>ContextLoaderListener的作用就是启动Web容器时，自动装配ApplicationContext的配置信息。因为它实现了ServletContextListener这个接口，在web.xml配置这个监听器，启动容器时，就会默认执行它实现的方法。</p>
<p>3、部署applicationContext的xml文件：contextConfigLocation（context-param下的param-name）</p>
<p>4、DispatcherServlet是前置控制器，配置在web.xml文件中的。拦截匹配的请求，Servlet拦截匹配规则要自已定义，把拦截下来的请求，依据某某规则分发到目标Controller(我们写的Action)来处理。</p>
<p>DispatcherServlet（servlet-name、servlet-class、init-param、param-name(contextConfigLocation)、param-value）在DispatcherServlet的初始化过程中，框架会在web应用的 WEB-INF文件夹下寻找名为[servlet-name]-servlet.xml 的配置文件，生成文件中定义的bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;  </span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">"3.0"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- 在Spring框架中是如何解决从页面传来的字符串的编码问题的呢？</span></span><br><span class="line"><span class="comment">    下面我们来看看Spring框架给我们提供过滤器CharacterEncodingFilter  </span></span><br><span class="line"><span class="comment">     这个过滤器就是针对于每次浏览器请求进行过滤的，然后再其之上添加了父类没有的功能即处理字符编码。  </span></span><br><span class="line"><span class="comment">      其中encoding用来设置编码格式，forceEncoding用来设置是否理会 request.getCharacterEncoding()方法，设置为true则强制覆盖之前的编码格式。--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- 项目中使用Spring 时，applicationContext.xml配置文件中并没有BeanFactory，要想在业务层中的class 文件中直接引用Spring容器管理的bean可通过以下方式--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--1、在web.xml配置监听器ContextLoaderListener--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--ContextLoaderListener的作用就是启动Web容器时，自动装配ApplicationContext的配置信息。因为它实现了ServletContextListener这个接口，在web.xml配置这个监听器，启动容器时，就会默认执行它实现的方法。  </span></span><br><span class="line"><span class="comment">    在ContextLoaderListener中关联了ContextLoader这个类，所以整个加载配置过程由ContextLoader来完成。  </span></span><br><span class="line"><span class="comment">    它的API说明  </span></span><br><span class="line"><span class="comment">    第一段说明ContextLoader可以由 ContextLoaderListener和ContextLoaderServlet生成。  </span></span><br><span class="line"><span class="comment">    如果查看ContextLoaderServlet的API，可以看到它也关联了ContextLoader这个类而且它实现了HttpServlet这个接口  </span></span><br><span class="line"><span class="comment">    第二段，ContextLoader创建的是 XmlWebApplicationContext这样一个类，它实现的接口是WebApplicationContext-&gt;ConfigurableWebApplicationContext-&gt;ApplicationContext-&gt;  </span></span><br><span class="line"><span class="comment">    BeanFactory这样一来spring中的所有bean都由这个类来创建  </span></span><br><span class="line"><span class="comment">     IUploaddatafileManager uploadmanager = (IUploaddatafileManager)    ContextLoaderListener.getCurrentWebApplicationContext().getBean("uploadManager");</span></span><br><span class="line"><span class="comment">     --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--2、部署applicationContext的xml文件--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--如果在web.xml中不写任何参数配置信息，默认的路径是"/WEB-INF/applicationContext.xml，  </span></span><br><span class="line"><span class="comment">    在WEB-INF目录下创建的xml文件的名称必须是applicationContext.xml。  </span></span><br><span class="line"><span class="comment">    如果是要自定义文件名可以在web.xml里加入contextConfigLocation这个context参数：  </span></span><br><span class="line"><span class="comment">    在&lt;param-value&gt; &lt;/param-value&gt;里指定相应的xml文件名，如果有多个xml文件，可以写在一起并以“,”号分隔。  </span></span><br><span class="line"><span class="comment">    也可以这样applicationContext-*.xml采用通配符，比如这那个目录下有applicationContext-ibatis-base.xml，  </span></span><br><span class="line"><span class="comment">    applicationContext-action.xml，applicationContext-ibatis-dao.xml等文件，都会一同被载入。  </span></span><br><span class="line"><span class="comment">    在ContextLoaderListener中关联了ContextLoader这个类，所以整个加载配置过程由ContextLoader来完成。--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--如果你的DispatcherServlet拦截"/"，为了实现REST风格，拦截了所有的请求，那么同时对*.js,*.jpg等静态文件的访问也就被拦截了。--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--方案一：激活Tomcat的defaultServlet来处理静态文件--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--要写在DispatcherServlet的前面， 让 defaultServlet先拦截请求，这样请求就不会进入Spring了，我想性能是最好的吧。--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.css<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.swf<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.gif<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jpg<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.png<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.js<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.html<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.xml<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.json<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.map<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--使用Spring MVC,配置DispatcherServlet是第一步。DispatcherServlet是一个Servlet,,所以可以配置多个DispatcherServlet--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--DispatcherServlet是前置控制器，配置在web.xml文件中的。拦截匹配的请求，Servlet拦截匹配规则要自已定义，把拦截下来的请求，依据某某规则分发到目标Controller(我们写的Action)来处理。--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span><span class="comment">&lt;!--在DispatcherServlet的初始化过程中，框架会在web应用的 WEB-INF文件夹下寻找名为[servlet-name]-servlet.xml 的配置文件，生成文件中定义的bean。--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--指明了配置文件的文件名，不使用默认配置文件名，而使用dispatcher-servlet.xml配置文件。--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--其中&lt;param-value&gt;**.xml&lt;/param-value&gt; 这里可以使用多种写法--&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--1、不写,使用默认值:/WEB-INF/&lt;servlet-name&gt;-servlet.xml--&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--2、&lt;param-value&gt;/WEB-INF/classes/dispatcher-servlet.xml&lt;/param-value&gt;--&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--3、&lt;param-value&gt;classpath*:dispatcher-servlet.xml&lt;/param-value&gt;--&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--4、多个值用逗号分隔--&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/dispatcher-servlet.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span><span class="comment">&lt;!--是启动顺序，让这个Servlet随Servletp容器一起启动。--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--这个Servlet的名字是dispatcher，可以有多个DispatcherServlet，是通过名字来区分的。每一个DispatcherServlet有自己的WebApplicationContext上下文对象。同时保存的ServletContext中和Request对象中.--&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--ApplicationContext是Spring的核心，Context我们通常解释为上下文环境，我想用“容器”来表述它更容易理解一些，ApplicationContext则是“应用的容器”了:P，Spring把Bean放在这个容器中，在需要的时候，用getBean方法取出--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--Servlet拦截匹配规则可以自已定义，当映射为@RequestMapping("/user/add")时，为例,拦截哪种URL合适？--&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--1、拦截*.do、*.htm， 例如：/user/add.do,这是最传统的方式，最简单也最实用。不会导致静态文件（jpg,js,css）被拦截。--&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--2、拦截/，例如：/user/add,可以实现现在很流行的REST风格。很多互联网类型的应用很喜欢这种风格的URL。弊端：会导致静态文件（jpg,js,css）被拦截后不能正常显示。 --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span> <span class="comment">&lt;!--会拦截URL中带“/”的请求。--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span><span class="comment">&lt;!--指定欢迎页面--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>login.html<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span> <span class="comment">&lt;!--当系统出现404错误，跳转到页面nopage.html--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/nopage.html<span class="tag">&lt;/<span class="name">location</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span> <span class="comment">&lt;!--当系统出现java.lang.NullPointerException，跳转到页面error.html--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">exception-type</span>&gt;</span>java.lang.NullPointerException<span class="tag">&lt;/<span class="name">exception-type</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/error.html<span class="tag">&lt;/<span class="name">location</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">session-config</span>&gt;</span><span class="comment">&lt;!--会话超时配置，单位分钟--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>360<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">session-config</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>来源：<a href="http://blog.csdn.net/u010796790/article/details/52098258" target="_blank" rel="external">http://blog.csdn.net/u010796790/article/details/52098258</a></p>
<hr>
<h2 id="listener、-filter、servlet-加载顺序"><a href="#listener、-filter、servlet-加载顺序" class="headerlink" title="listener、 filter、servlet 加载顺序"></a>listener、 filter、servlet 加载顺序</h2><p>context-param -&gt; listener -&gt; filter -&gt; servlet</p>
<p>对于某类配置节而言，与它们出现的顺序是有关的。以 filter 为例，web.xml 中当然可以定义多个 filter，与 filter 相关的一个配置节是 filter-mapping，这里一定要注意，对于拥有相同 filter-name 的 filter 和 filter-mapping 配置节而言，filter-mapping 必须出现在 filter 之后，否则当解析到 filter-mapping 时，它所对应的 filter-name 还未定义。web 容器启动时初始化每个 filter 时，是按照 filter 配置节出现的顺序来初始化的，当请求资源匹配多个filter-mapping 时，filter 拦截资源是按照 filter-mapping 配置节出现的顺序来依次调用 doFilter() 方法的。servlet 同 filter 类似 ，此处不再赘述。</p>
<p>如果要指定serverlet拦截“/”根目录处理欢迎页，必须加入下面这一项</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span><span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span>  <span class="comment">&lt;!--有值则指定欢迎页路径 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Spring-MVC-去掉静态资源的拦截"><a href="#Spring-MVC-去掉静态资源的拦截" class="headerlink" title="Spring MVC 去掉静态资源的拦截"></a>Spring MVC 去掉静态资源的拦截</h2><p>当springMVC配置前端控制器拦截的所有请求时，去掉静态资源的拦截</p>
<h3 id="1、前端控制器的配置"><a href="#1、前端控制器的配置" class="headerlink" title="1、前端控制器的配置"></a>1、前端控制器的配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- springmvc的前端控制器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMVC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- contextConfigLocation不是必须的</span></span><br><span class="line"><span class="comment">    如果不配置contextConfigLocation</span></span><br><span class="line"><span class="comment">    springmvc的配置文件默认在：WEB-INF/servlet的name+"-servlet.xml" --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMVC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>/ 表示拦截所有的请求，包括静态资源</p>
<p><code>&lt;url-pattern&gt;/&lt;/url-pattern&gt;</code> 表示拦截所有的请求，包括静态资源</p>
<h3 id="2、去静态资源拦截有三种方式"><a href="#2、去静态资源拦截有三种方式" class="headerlink" title="2、去静态资源拦截有三种方式"></a>2、去静态资源拦截有三种方式</h3><p>1、在web.xml中配置映射<br>2、在springMVC.xml中配置映射<br>3、在springMVC.xml中添加静态资源默认Servlet处理</p>
<p>方式一</p>
<p>在web.xml中配置映射</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 对静态资源的配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.js<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.css<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.ico<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/img/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/fonts/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/font/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以根据自身情况，来配置映射</p>
<p><strong>注意： 请将它放在所有Servlet的最前面（为了让它最先匹配），这样的话性能上应该比较好</strong></p>
<p>方式二</p>
<p><strong>在springMVC.xml中添加静态资源的映射</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 资源映射 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">"/WEB-INF/css/"</span> <span class="attr">mapping</span>=<span class="string">"/css/**"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">"/WEB-INF/js/"</span> <span class="attr">mapping</span>=<span class="string">"/js/**"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>根据实际情况自行配置</p>
<p>方式三</p>
<p><strong>在springMVC.xml中添加静态资源默认Servlet处理</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 也可以自行手动配置，自定义servlet --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span> <span class="attr">default-servlet-name</span>=<span class="string">"myDefaultServlet"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>注意： 这种方式对spring版本必须要求3.0.5及以上</strong></p>
<p>来源：<a href="http://blog.csdn.net/mybook201314/article/details/73484686" target="_blank" rel="external">http://blog.csdn.net/mybook201314/article/details/73484686</a></p>
<hr>
<h2 id="SpringMVC上传图片以及-nginx-tomcat-动静分离"><a href="#SpringMVC上传图片以及-nginx-tomcat-动静分离" class="headerlink" title="SpringMVC上传图片以及 nginx + tomcat 动静分离"></a>SpringMVC上传图片以及 nginx + tomcat 动静分离</h2><p>nginx作为web服务器不能解析jsp等页面，只能处理js、css、html等静态资源。所以可以使用nginx反向代理来找到图片来显示(后面会写)，图片在数据库就保存为反向代理所指定的路径。</p>
<p>前台–使用kindeditor富编辑器来完成图片上传的前台代码以及回显（href一个图片地址，比如 image.xxx.com）。</p>
<p>后台–使用springmvc处理：</p>
<p>1、</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &lt;!-- 上传解析器 --&gt;</span><br><span class="line">&lt;bean id=&quot;multipartResolver&quot; class=&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;&gt;</span><br><span class="line">&lt;!-- 5MB,它的单位是byte --&gt;</span><br><span class="line">&lt;property name=&quot;maxUploadSize&quot; value=&quot;5242880&quot;&gt;&lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>3、写一个controller，有@ResponseBody，返回一个由ObjectMapper将一个对象转为可以被kindeditor识别的json字符串。另外，由于kindeditor的缘故，这个controller的响应头要用text/json,而不是常用的application/json。使用</p>
<p>@RequestMapping(value = “/upload”, method = RequestMethod.POST, produces = MediaType.TEXT_PLAIN_VALUE)解决。参数是@RequestParam(“uploadFile”) MultipartFile uploadFile</p>
<p>4、对图片进行校验：从文件名、大小、内容三方面考虑。内容是在图片写到磁盘后，使用BufferedImage来校验宽高</p>
<p>5、指定图片存放的真实路径，可以DateTime来根据时间创建文件夹和重新定义文件名。比如E:\xxx\upload\image\2017\07\20\xxxxxx.jpg</p>
<p>6、返回到前台一个引用地址，用来保存到数据库（前台最终使用提交来保存所有信息），比如<a href="http://image.xxx.com/image/2017/07/20/xxxxxx.jpg" target="_blank" rel="external">http://image.xxx.com/image/2017/07/20/xxxxxx.jpg</a></p>
<p>7、使用uploadFile.transferTo(newFile)将图片写到磁盘，校验图片内容，如果不符合则newFile.delete();</p>
<p>8、mapper.writeValueAsString(fileUploadResult)返回。fileUploadResult对象里面封装的内容就是kindeditor要求的。</p>
<p>9、nginx配置：<br>除了使用连接tomcat的server，再加一个指定本地文件的server：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  image.xxx.com;</span><br><span class="line">        location / &#123;# /表示port后第一个反斜杠，即这个反斜杠前面的东西，会被下面替代</span><br><span class="line">            root  E:\\xxx\\upload;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当访问<a href="http://image.xxx.com/image/2017/07/20/xxxxxx.jpg时，" target="_blank" rel="external">http://image.xxx.com/image/2017/07/20/xxxxxx.jpg时，</a></p>
<p>反向代理到E:\xxx\upload\image\2017\07\20\xxxxxx.jpg这个地址</p>
<p>来源：<a href="http://blog.csdn.net/u011302734/article/details/75453878" target="_blank" rel="external">http://blog.csdn.net/u011302734/article/details/75453878</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/15/distributed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/15/distributed/" itemprop="url">
                  分布式与集群的区别是什么
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-15 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-15T23:47:44+08:00">2017-10-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 04:36:07" itemprop="dateModified" datetime="2017-11-11T04:36:07+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/架构/" itemprop="url" rel="index"><span itemprop="name">架构</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在IDF05（Intel Developer Forum 2005）上，Intel首席执行官Craig Barrett就取消4GHz芯片计划一事，半开玩笑当众单膝下跪致歉，给广大软件开发者一个明显的信号，单纯依靠垂直提升硬件性能来提高系统性能的时代已结束，分布式开发的时代实际上早已悄悄地成为了时代的主流，吵得很热的云计算实际上只是包装在分布式之外的商业概念，很多开发者（包括我）都想加入研究云计算这个潮流，在google上通过“云计算”这个关键词来查询资料，查到的都是些概念性或商业性的宣传资料，其实真正需要深入的还是那个早以被人熟知的概念——分布式。</p>
<p><strong>分布式可繁也可以简，最简单的分布式就是大家最常用的，在负载均衡服务器后加一堆web服务器，然后在上面搞一个缓存服务器来保存临时状态，后面共享一个数据库，其实很多号称分布式专家的人也就停留于此</strong>，大致结构如下图所示：</p>
<p><img src="/2017/10/15/distributed/1.jpeg" alt=""></p>
<p>这种环境下真正进行分布式的只是web server而已，并且web server之间没有任何联系，所以结构和实现都非常简单。</p>
<p>有些情况下，对分布式的需求就没这么简单，在每个环节上都有分布式的需求，比如Load Balance、DB、Cache和文件等等，并且当分布式节点之间有关联时，还得考虑之间的通讯，另外，节点非常多的时候，得有监控和管理来支撑。这样看起来，分布式是一个非常庞大的体系，只不过你可以根据具体需求进行适当地裁剪。按照最完备的分布式体系来看，可以由以下模块组成：</p>
<p><img src="/2017/10/15/distributed/2.jpeg" alt=""></p>
<p><strong>分布式任务处理服务：负责具体的业务逻辑处理</strong></p>
<p><strong>分布式节点注册和查询：负责管理所有分布式节点的命名和物理信息的注册与查询，是节点之间联系的桥梁</strong></p>
<p><strong>分布式DB：分布式结构化数据存取</strong></p>
<p><strong>分布式Cache：分布式缓存数据（非持久化）存取</strong></p>
<p><strong>分布式文件：分布式文件存取</strong></p>
<p><strong>网络通信：节点之间的网络数据通信</strong></p>
<p><strong>监控管理：搜集、监控和诊断所有节点运行状态</strong></p>
<p><strong>分布式编程语言：用于分布式环境下的专有编程语言，比如Elang、Scala</strong></p>
<p><strong>分布式算法：为解决分布式环境下一些特有问题的算法，比如解决一致性问题的Paxos算法</strong></p>
<p>因此，若要深入研究云计算和分布式，就得深入研究以上领域，而这些领域每一块的水都很深，都需要很底层的知识和技术来支撑，所以说，对于想提升技术的开发者来说，以分布式来作为切入点是非常好的，可以以此为线索，探索计算机世界的各个角落。</p>
<h3 id="集群是个物理形态，分布式是个工作方式。"><a href="#集群是个物理形态，分布式是个工作方式。" class="headerlink" title="集群是个物理形态，分布式是个工作方式。"></a>集群是个物理形态，分布式是个工作方式。</h3><p>只要是一堆机器，就可以叫集群，他们是不是一起协作着干活，这个谁也不知道；一个程序或系统，只要运行在不同的机器上，就可以叫分布式，嗯，C/S架构也可以叫分布式。</p>
<p>集群一般是物理集中、统一管理的，而分布式系统则不强调这一点。</p>
<p>所以，集群可能运行着一个或多个分布式系统，也可能根本没有运行分布式系统；分布式系统可能运行在一个集群上，也可能运行在不属于一个集群的多台（2台也算多台）机器上。</p>
<p>分布式是相对中心化而来，强调的是任务在多个物理隔离的节点上进行。中心化带来的主要问题是可靠性，若中心节点宕机则整个系统不可用，分布式除了解决部分中心化问题，也倾向于分散负载，但分布式会带来很多的其他问题，最主要的就是一致性。</p>
<p>集群就是逻辑上处理同一任务的机器集合，可以属于同一机房，也可分属不同的机房。分布式这个概念可以运行在某个集群里面，某个集群也可作为分布式概念的一个节点。</p>
<p><strong>一句话，就是：“分头做事”与“一堆人”的区别</strong></p>
<p><strong>分布式是指将不同的业务分布在不同的地方。 而集群指的是将几台服务器集中在一起，实现同一业务。</strong></p>
<p><strong>分布式中的每一个节点，都可以做集群。 而集群并不一定就是分布式的。</strong></p>
<p>举例：就比如新浪网，访问的人多了，他可以做一个群集，前面放一个响应服务器，后面几台服务器完成同一业务，如果有业务访问的时候，响应服务器看哪台服务器的负载不是很重，就将给哪一台去完成。</p>
<p>而分布式，从窄意上理解，也跟集群差不多， 但是它的组织比较松散，不像集群，有一个组织性，一台服务器垮了，其它的服务器可以顶上来。</p>
<p>分布式的每一个节点，都完成不同的业务，一个节点垮了，哪这个业务就不可访问了。</p>
<p>简单说，分布式是以缩短单个任务的执行时间来提升效率的，而集群则是通过提高单位时间内执行的任务数来提升效率。</p>
<p>例如：</p>
<p>如果一个任务由10个子任务组成，每个子任务单独执行需1小时，则在一台服务器上执行该任务需10小时。</p>
<p>采用分布式方案，提供10台服务器，每台服务器只负责处理一个子任务，不考虑子任务间的依赖关系，执行完这个任务只需一个小时。(这种工作模式的一个典型代表就是Hadoop的Map/Reduce分布式计算模型）</p>
<p>而采用集群方案，同样提供10台服务器，每台服务器都能独立处理这个任务。假设有10个任务同时到达，10个服务器将同时工作，1小时后，10个任务同时完成，这样，整身来看，还是1小时内完成一个任务！</p>
<p>集群一般被分为三种类型，高可用集群如RHCS、LifeKeeper等，负载均衡集群如LVS等、高性能运算集群;分布式应该是高性能运算集群范畴内。</p>
<p>分布式：不同的业务模块部署在不同的服务器上或者同一个业务模块分拆多个子业务，部署在不同的服务器上，解决高并发的问题<br>集群：同一个业务部署在多台机器上，提高系统可用性</p>
<hr>
<p>小饭店原来只有一个厨师，切菜洗菜备料炒菜全干。后来客人多了，厨房一个厨师忙不过来，又请了个厨师，两个厨师都能炒一样的菜，这两个厨师的关系是集群。为了让厨师专心炒菜，把菜做到极致，又请了个配菜师负责切菜，备菜，备料，厨师和配菜师的关系是分布式，一个配菜师也忙不过来了，又请了个配菜师，两个配菜师关系是集群</p>
<hr>
<p>来源：<a href="http://www.cnblogs.com/aspirant/p/5697807.html" target="_blank" rel="external">http://www.cnblogs.com/aspirant/p/5697807.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/14/thymeleaf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/14/thymeleaf/" itemprop="url">
                  Java模板引擎Thymeleaf
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-14 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-14T23:47:44+08:00">2017-10-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 04:28:57" itemprop="dateModified" datetime="2017-11-11T04:28:57+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Thymeleaf是一款用于渲染XML/XHTML/HTML5内容的模板引擎。类似JSP，Velocity，FreeMaker等，它也可以轻易的与Spring MVC等Web框架进行集成作为Web应用的模板引擎。与其它模板引擎相比，Thymeleaf最大的特点是能够直接在浏览器中打开并正确显示模板页面，而不需要启动整个Web应用。</p>
<h3 id="Thymeleaf初探"><a href="#Thymeleaf初探" class="headerlink" title="Thymeleaf初探"></a>Thymeleaf初探</h3><p>相比于其他的模板引擎，Thymeleaf最大的特点是通过HTML的标签属性渲染标签内容，以下是一个Thymeleaf模板例子：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Good Thymes Virtual Grocery<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">media</span>=<span class="string">"all"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"../../css/gtvg.css"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/css/gtvg.css&#125;"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"#&#123;home.welcome&#125;"</span>&gt;</span>Welcome to our grocery store!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是一段标准的HTML代码，这也就意味着通过浏览器直接打开它是可以正确解析它的结构并看到页面的样子。相比去其他的模板引擎在指定的位置通过${}等表达式进行渲染，Thymeleaf则是一种针对HTML/XML定制的模板语言（当然它可以被扩展），它通过标签中的th:text属性来填充该标签的一段内容。上例中，<code>&lt;p th:text=&quot;#{home.welcome}&quot;&gt;Welcome to our grocery store!&lt;/p&gt;</code>意味着<code>&lt;p&gt;</code>标签中的内容会被表达式<code>#{home.welcome}</code>的值所替代，无论模板中它的内容是什么，之所以在模板中“多此一举“地填充它的内容，完全是为了它能够作为原型在浏览器中直接显示出来。</p>
<h3 id="标准表达式语法"><a href="#标准表达式语法" class="headerlink" title="标准表达式语法"></a>标准表达式语法</h3><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>Thymeleaf模板引擎在进行模板渲染时，还会附带一个Context存放进行模板渲染的变量，在模板中定义的表达式本质上就是从Context中获取对应的变量的值：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Today is: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">"$&#123;today&#125;"</span>&gt;</span>13 february 2011<span class="tag">&lt;/<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>假设today的值为2015年8月14日，那么渲染结果为：<code>&lt;p&gt;Today is: 2015年8月14日.&lt;/p&gt;</code>。可见Thymeleaf的基本变量和JSP一样，都使用<code>${.}</code>表示获取变量的值。</p>
<h3 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h3><p>URL在Web应用模板中占据着十分重要的地位，需要特别注意的是Thymeleaf对于URL的处理是通过语法<code>@{...}</code>来处理的。Thymeleaf支持绝对路径URL：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;http://www.thymeleaf.org&#125;"</span>&gt;</span>Thymeleaf<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>同时也能够支持相对路径URL：</p>
<p>当前页面相对路径URL——user/login.html，通常不推荐这样写。<br>Context相关URL——/static/css/style.css<br>另外，如果需要Thymeleaf对URL进行渲染，那么务必使用<code>th:href，th:src</code>等属性，下面是一个例子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Will produce 'http://localhost:8080/gtvg/order/details?orderId=3' (plus rewriting) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"details.html"</span> </span></span><br><span class="line"><span class="tag">   <span class="attr">th:href</span>=<span class="string">"@&#123;http://localhost:8080/gtvg/order/details(orderId=$&#123;o.id&#125;)&#125;"</span>&gt;</span>view<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Will produce '/gtvg/order/details?orderId=3' (plus rewriting) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"details.html"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/order/details(orderId=$&#123;o.id&#125;)&#125;"</span>&gt;</span>view<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Will produce '/gtvg/order/3/details' (plus rewriting) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"details.html"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/order/&#123;orderId&#125;/details(orderId=$&#123;o.id&#125;)&#125;"</span>&gt;</span>view<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>几点说明：</p>
<p>上例中URL最后的(orderId=${o.id})表示将括号内的内容作为URL参数处理，该语法避免使用字符串拼接，大大提高了可读性<code>@{...}</code>表达式中可以通过<code>{orderId}</code>访问Context中的orderId变量<br><code>@{/order}</code>是Context相关的相对路径，在渲染时会自动添加上当前Web应用的Context名字，假设context名字为app，那么结果应该是/app/order</p>
<h3 id="字符串替换"><a href="#字符串替换" class="headerlink" title="字符串替换"></a>字符串替换</h3><p>很多时候可能我们只需要对一大段文字中的某一处地方进行替换，可以通过字符串拼接操作完成：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">"'Welcome to our application, ' + $&#123;user.name&#125; + '!'"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>一种更简洁的方式是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">"|Welcome to our application, $&#123;user.name&#125;!|"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然这种形式限制比较多，<code>|...|</code>中只能包含变量表达式<code>${...}</code>，不能包含其他常量、条件表达式等。</p>
<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p>在表达式中可以使用各类算术运算符，例如+, -, *, /, %</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">th:with="isEven=($&#123;prodStat.count&#125; % 2 == 0)"</span><br></pre></td></tr></table></figure>
<p>逻辑运算符&gt;, &lt;, &lt;=,&gt;=，==,!=都可以使用，唯一需要注意的是使用&lt;,&gt;时需要用它的HTML转义符：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">th:if="$&#123;prodStat.count&#125; &amp;gt; 1"</span><br><span class="line">th:text="'Execution mode is ' + ( ($&#123;execMode&#125; == 'dev')? 'Development' : 'Production')"</span><br></pre></td></tr></table></figure>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>渲染列表数据是一种非常常见的场景，例如现在有n条记录需要渲染成一个表格<code>&lt;table&gt;</code>，该数据集合必须是可以遍历的，使用th:each标签：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Product list<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span>&gt;</span>NAME<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span>&gt;</span>PRICE<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span>&gt;</span>IN STOCK<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">"prod : $&#123;prods&#125;"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">"$&#123;prod.name&#125;"</span>&gt;</span>Onions<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">"$&#123;prod.price&#125;"</span>&gt;</span>2.41<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">"$&#123;prod.inStock&#125;? #&#123;true&#125; : #&#123;false&#125;"</span>&gt;</span>yes<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"../home.html"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/&#125;"</span>&gt;</span>Return to home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到，需要在被循环渲染的元素（这里是<code>&lt;tr&gt;</code>）中加入<code>th:each</code>标签，其中<code>th:each=&quot;prod : ${prods}&quot;</code>意味着对集合变量prods进行遍历，循环变量是prod在循环体中可以通过表达式访问。</p>
<h3 id="条件求值"><a href="#条件求值" class="headerlink" title="条件求值"></a>条件求值</h3><h3 id="If-Unless"><a href="#If-Unless" class="headerlink" title="If/Unless"></a>If/Unless</h3><p>Thymeleaf中使用<code>th:if</code>和<code>th:unless</code>属性进行条件判断，下面的例子中，<code>&lt;a&gt;</code>标签只有在<code>th:if</code>中条件成立时才显示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/login&#125;"</span> <span class="attr">th:unless</span>=<span class="string">$&#123;session.user</span> != <span class="string">null&#125;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>th:unless</code>于<code>th:if</code>恰好相反，只有表达式中的条件不成立，才会显示其内容。</p>
<h3 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h3><p>Thymeleaf同样支持多路选择Switch结构：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:switch</span>=<span class="string">"$&#123;user.role&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">"'admin'"</span>&gt;</span>User is an administrator<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">"#&#123;roles.manager&#125;"</span>&gt;</span>User is a manager<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>默认属性default可以用*表示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:switch</span>=<span class="string">"$&#123;user.role&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">"'admin'"</span>&gt;</span>User is an administrator<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">"#&#123;roles.manager&#125;"</span>&gt;</span>User is a manager<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">"*"</span>&gt;</span>User is some other thing<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Utilities"><a href="#Utilities" class="headerlink" title="Utilities"></a>Utilities</h3><p>为了模板更加易用，Thymeleaf还提供了一系列Utility对象（内置于Context中），可以通过#直接访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#dates</span><br><span class="line">#calendars</span><br><span class="line">#numbers</span><br><span class="line">#strings</span><br><span class="line">arrays</span><br><span class="line">lists</span><br><span class="line">sets</span><br><span class="line">maps</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>下面用一段代码来举例一些常用的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#dates</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Format date with the specified pattern</span><br><span class="line"> * Also works with arrays, lists or sets</span><br><span class="line"> */</span><br><span class="line">$&#123;#dates.format(date, &apos;dd/MMM/yyyy HH:mm&apos;)&#125;</span><br><span class="line">$&#123;#dates.arrayFormat(datesArray, &apos;dd/MMM/yyyy HH:mm&apos;)&#125;</span><br><span class="line">$&#123;#dates.listFormat(datesList, &apos;dd/MMM/yyyy HH:mm&apos;)&#125;</span><br><span class="line">$&#123;#dates.setFormat(datesSet, &apos;dd/MMM/yyyy HH:mm&apos;)&#125;</span><br><span class="line">/*</span><br><span class="line"> * Create a date (java.util.Date) object for the current date and time</span><br><span class="line"> */</span><br><span class="line">$&#123;#dates.createNow()&#125;</span><br><span class="line">/*</span><br><span class="line"> * Create a date (java.util.Date) object for the current date (time set to 00:00)</span><br><span class="line"> */</span><br><span class="line">$&#123;#dates.createToday()&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#strings</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Check whether a String is empty (or null). Performs a trim() operation before check</span><br><span class="line"> * Also works with arrays, lists or sets</span><br><span class="line"> */</span><br><span class="line">$&#123;#strings.isEmpty(name)&#125;</span><br><span class="line">$&#123;#strings.arrayIsEmpty(nameArr)&#125;</span><br><span class="line">$&#123;#strings.listIsEmpty(nameList)&#125;</span><br><span class="line">$&#123;#strings.setIsEmpty(nameSet)&#125;</span><br><span class="line">/*</span><br><span class="line"> * Check whether a String starts or ends with a fragment</span><br><span class="line"> * Also works with arrays, lists or sets</span><br><span class="line"> */</span><br><span class="line">$&#123;#strings.startsWith(name,&apos;Don&apos;)&#125;                  // also array*, list* and set*</span><br><span class="line">$&#123;#strings.endsWith(name,endingFragment)&#125;           // also array*, list* and set*</span><br><span class="line">/*</span><br><span class="line"> * Compute length</span><br><span class="line"> * Also works with arrays, lists or sets</span><br><span class="line"> */</span><br><span class="line">$&#123;#strings.length(str)&#125;</span><br><span class="line">/*</span><br><span class="line"> * Null-safe comparison and concatenation</span><br><span class="line"> */</span><br><span class="line">$&#123;#strings.equals(str)&#125;</span><br><span class="line">$&#123;#strings.equalsIgnoreCase(str)&#125;</span><br><span class="line">$&#123;#strings.concat(str)&#125;</span><br><span class="line">$&#123;#strings.concatReplaceNulls(str)&#125;</span><br><span class="line">/*</span><br><span class="line"> * Random</span><br><span class="line"> */</span><br><span class="line">$&#123;#strings.randomAlphanumeric(count)&#125;</span><br></pre></td></tr></table></figure>
<h3 id="页面即原型"><a href="#页面即原型" class="headerlink" title="页面即原型"></a>页面即原型</h3><p>在Web开发过程中一个绕不开的话题就是前端工程师与后端工程师的协作，在传统Java Web开发过程中，前端工程师和后端工程师一样，也需要安装一套完整的开发环境，然后各类Java IDE中修改模板、静态资源文件，启动/重启/重新加载应用服务器，刷新页面查看最终效果。</p>
<p>但实际上前端工程师的职责更多应该关注于页面本身而非后端，使用JSP，Velocity等传统的Java模板引擎很难做到这一点，因为它们必须在应用服务器中渲染完成后才能在浏览器中看到结果，而Thymeleaf从根本上颠覆了这一过程，通过属性进行模板渲染不会引入任何新的浏览器不能识别的标签，例如JSP中的<code>&lt;form:input&gt;</code>，不会在Tag内部写表达式。整个页面直接作为HTML文件用浏览器打开，几乎就可以看到最终的效果，这大大解放了前端工程师的生产力，它们的最终交付物就是纯的HTML/CSS/JavaScript文件。</p>
<h2 id="进一步阅读"><a href="#进一步阅读" class="headerlink" title="进一步阅读"></a>进一步阅读</h2><p><a href="https://course.tianmaying.com/spring-mvc" target="_blank" rel="external">Spring MVC实战入门训练</a></p>
<p><a href="https://course.tianmaying.com/spring-mvc-mybatis-qa" target="_blank" rel="external">开发问答网站：基于MyBatis和Spring MVC</a></p>
<p><a href="https://www.tianmaying.com/tutorial/spring-mvc-quickstart" target="_blank" rel="external">Spring MVC快速入门</a></p>
<p><a href="https://www.tianmaying.com/tutorial/spring-mvc-DispatcherServlet" target="_blank" rel="external">Spring MVC DispatcherServlet详解</a></p>
<p><a href="https://www.tianmaying.com/tutorial/websocket-chatroom" target="_blank" rel="external">基于Spring MVC的 Websocket在线聊天室</a></p>
<p><a href="https://www.tianmaying.com/tutorial/spring-jpa-page-sort" target="_blank" rel="external">整合Spring Data JPA与Spring MVC: 分页和排序</a></p>
<p><a href="https://www.tianmaying.com/tutorial/spring-jpa-query" target="_blank" rel="external">整合Spring Data JPA与Spring MVC：使用@Query标注自定义查询语句</a></p>
<p><a href="https://www.tianmaying.com/tutorial/cross-origin-rest-service" target="_blank" rel="external">基于Spring和Spring MVC实现可跨域访问的REST服务</a></p>
<p><a href="https://www.tianmaying.com/tutorial/spring-mvc-interceptor" target="_blank" rel="external">Spring MVC拦截器</a></p>
<p><a href="https://www.tianmaying.com/tutorial/spring-mvc-thymeleaf" target="_blank" rel="external">Spring MVC中使用Thymeleaf模板引擎</a></p>
<p>来源： <a href="https://www.tianmaying.com/tutorial/using-thymeleaf" target="_blank" rel="external">https://www.tianmaying.com/tutorial/using-thymeleaf</a></p>
<p>天狼 2017-10-15：(<a href="https://github.com/jreijn/spring-comparing-template-engines/issues/19?from=timeline&amp;isappinstalled=0" target="_blank" rel="external">点击查看几个模板引擎评测文章</a>)</p>
<p>相关评测显示thymeleaf效率不高，个人认为使用模板应该是根据自身的项目特点来选择， 就如当前流行使用nodejs搭建前后端分离的架构，不代表所有的java框架都没有优势。架构是灵活的，采用springMVC一样可以做到前后端分离，同一个后端可以提供服务给web前端、Android客户端、IOS客户端、微信小程序。</p>
<p>SpringMVC+thymeleaf最终生成静态的html到浏览器，并非站点前后端分离的思路，而当前流行的js模板引擎都是直接在html页面通过ajax技术动态跟后端交互而后使用js更新页面，达到前后端分离而快速渲染的目的。<br>是否需要整个项目翻盘重构到这种架构模式，取决于实际业务。<font color="red">大多情况下，不存在所谓过时的技术，过时的主体一般是{人}的因素，造成过时的原因往往都是陈旧的思路。</font></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/13/android-daemon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/13/android-daemon/" itemprop="url">
                  Android 通过JNI实现守护进程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-13 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-13T23:47:44+08:00">2017-10-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 04:15:12" itemprop="dateModified" datetime="2017-11-11T04:15:12+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>开发一个需要常住后台的App其实是一件非常头疼的事情，不仅要应对国内各大厂商的ROM，还需要应对各类的安全管家… 虽然不断的研究各式各样的方法，但是效果并不好，比如任务管理器把App干掉，服务就起不来了…网上搜寻一番后，<br><strong>主要的方法有以下几种方法，但其实也都治标不治本:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1、提高Service的优先级：这个，也只能说在系统内存不足需要回收资源的时候，优先级较高，不容易被回收，然并卵...  </span><br><span class="line"></span><br><span class="line">2、提高Service所在进程的优先级：效果不是很明显  </span><br><span class="line"></span><br><span class="line">3、在onDestroy方法里重启service：这个倒还算挺有效的一个方法，但是，直接干掉进程的时候，onDestroy()方法都进不来，更别想重启了  </span><br><span class="line"></span><br><span class="line">4、broadcast广播：和第3种一样，没进入onDestroy()，就不知道什么时候发广播了，另外，在Android4.4以上，程序完全退出后，就不好接收广播了，需要在发广播的地方特定处理  </span><br><span class="line"></span><br><span class="line">5、放到System/app底下作为系统应用：这个也就是平时玩玩，没多大的实际意义。  </span><br><span class="line"></span><br><span class="line">6、Service的onStartCommand()方法，返回START_STICKY，这个主要是针对系统资源不足而导致的服务被关闭，还是有一定的道理的。</span><br></pre></td></tr></table></figure>
<p>在这里推荐一篇文章：【腾讯Bugly】Android 进程保活招式大全<br>应对的方法是有，实现起来都比较繁琐，而且稳定性也不好。如果你自己可以定制ROM，那就有很多种办法了，比如把你的应用加入白名单，或是多安装一个没有图标的app作为守护进程… 不过这个思想大部分程序都不适用。</p>
<p>那么，有没有办法在一个APP里面，开启一个子线程，在主线程被干掉了之后，子线程通过监听、轮询等方式去判断服务是否存在，不存在的话则开启服务。答案自然是肯定的，<strong>通过JNI的方式，fork()出一个子线程作为守护进程，轮询监听服务状态。守护进程（Daemon）是运行在后台的一种特殊进程。它独立于控制终端并且周期性地执行某种任务或等待处理某些发生的事件。而守护进程的会话组和当前目录，文件描述符都是独立的。后台运行只是终端进行了一次fork，让程序在后台执行，这些都没有改变</strong>。</p>
<p>那么我们先来看看Android4.4的源码，ActivityManagerService（源码/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java）是如何关闭在应用退出后清理内存的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process.killProcessQuiet(pid);</span><br></pre></td></tr></table></figure>
<p>应用退出后，ActivityManagerService就把主进程给杀死了，但是，在Android5.0中，ActivityManagerService却是这样处理的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Process.killProcessQuiet(app.pid);  </span><br><span class="line">Process.killProcessGroup(app.info.uid, app.pid);</span><br></pre></td></tr></table></figure>
<p><strong>虽只差了一句代码，差别却很大。Android5.0在应用退出后，ActivityManagerService不仅把主进程给杀死，另外把主进程所属的进程组一并杀死，这样一来，由于子进程和主进程在同一进程组，子进程在做的事情，也就停止了</strong>…要不怎么说Android5.0在安全方面做了很多更新呢…</p>
<p>那么，有没有办法让子进程脱离出来，不要受到主进程的影响，当然也是可以的。那么，在C/C++层是如何实现的呢？先上关键代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * srvname  进程名 </span></span><br><span class="line"><span class="comment"> * sd 之前创建子进程的pid写入的文件路径 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* srvname, <span class="keyword">char</span>* sd)</span> </span>&#123;  </span><br><span class="line">    pthread_t id;  </span><br><span class="line">    <span class="keyword">int</span> ret;  </span><br><span class="line">    struct rlimit r;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> pid = fork();  </span><br><span class="line">    LOGI(<span class="string">"fork pid: %d"</span>, pid);  </span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">        LOGI(<span class="string">"first fork() error pid %d,so exit"</span>, pid);  </span><br><span class="line">        exit(<span class="number">0</span>);  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">0</span>) &#123;  </span><br><span class="line">        LOGI(<span class="string">"first fork(): I'am father pid=%d"</span>, getpid());  </span><br><span class="line">        <span class="comment">//exit(0);  </span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//  第一个子进程  </span></span><br><span class="line">        LOGI(<span class="string">"first fork(): I'am child pid=%d"</span>, getpid());  </span><br><span class="line">        setsid();  </span><br><span class="line">        LOGI(<span class="string">"first fork(): setsid=%d"</span>, setsid());  </span><br><span class="line">        umask(<span class="number">0</span>); <span class="comment">//为文件赋予更多的权限，因为继承来的文件可能某些权限被屏蔽  </span></span><br><span class="line">  </span><br><span class="line">        <span class="keyword">int</span> pid = fork();  </span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">// 第二个子进程  </span></span><br><span class="line">            <span class="comment">// 这里实际上为了防止重复开启线程，应该要有相应处理  </span></span><br><span class="line">  </span><br><span class="line">            LOGI(<span class="string">"I'am child-child pid=%d"</span>, getpid());  </span><br><span class="line">            chdir(<span class="string">"/"</span>); <span class="comment">//&lt;span style="font-family: Arial, Helvetica, sans-serif;"&gt;修改进程工作目录为根目录，chdir(“/”)&lt;/span&gt;  </span></span><br><span class="line">            <span class="comment">//关闭不需要的从父进程继承过来的文件描述符。  </span></span><br><span class="line">            <span class="keyword">if</span> (r.rlim_max == RLIM_INFINITY) &#123;  </span><br><span class="line">                r.rlim_max = <span class="number">1024</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">int</span> i;  </span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; r.rlim_max; i++) &#123;  </span><br><span class="line">                close(i);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            umask(<span class="number">0</span>);  </span><br><span class="line">            ret = pthread_create(&amp;id, NULL, (<span class="keyword">void</span> *) thread, srvname); <span class="comment">// 开启线程，轮询去监听启动服务  </span></span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;  </span><br><span class="line">                printf(<span class="string">"Create pthread error!\n"</span>);  </span><br><span class="line">                exit(<span class="number">1</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">int</span> stdfd = open (<span class="string">"/dev/null"</span>, O_RDWR);  </span><br><span class="line">            dup2(stdfd, STDOUT_FILENO);  </span><br><span class="line">            dup2(stdfd, STDERR_FILENO);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            exit(<span class="number">0</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 启动Service </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Java_com_yyh_fork_NativeRuntime_startService</span><span class="params">(JNIEnv* env, jobject thiz,  </span></span></span><br><span class="line"><span class="function"><span class="params">        jstring cchrptr_ProcessName, jstring sdpath)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">char</span> * rtn = jstringTostring(env, cchrptr_ProcessName); <span class="comment">// 得到进程名称  </span></span><br><span class="line">    <span class="keyword">char</span> * sd = jstringTostring(env, sdpath);  </span><br><span class="line">    LOGI(<span class="string">"Java_com_yyh_fork_NativeRuntime_startService run....ProcessName:%s"</span>, rtn);  </span><br><span class="line">    a = rtn;  </span><br><span class="line">    start(<span class="number">1</span>, rtn, sd);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这里有几个重点需要理解一下：</strong></p>
<p>1、为什么要fork两次？第一次fork的作用是为后面setsid服务。setsid的调用者不能是进程组组长(group leader)，而第一次调用的时候父进程是进程组组长。第二次调用后，把前面一次fork出来的子进程退出，这样第二次fork出来的子进程，就和他们脱离了关系。</p>
<p>2、setsid()作用是什么？setsid() 使得第二个子进程是会话组长(sid==pid)，也是进程组组长(pgid == pid)，并且脱离了原来控制终端。故不管控制终端怎么操作，新的进程正常情况下不会收到他发出来的这些信号。</p>
<p>3、umask(0)的作用：由于子进程从父进程继承下来的一些东西，可能并未把权限继承下来，所以要赋予他更高的权限，便于子进程操作。</p>
<p>4、chdir (“/“);作用：进程活动时，其工作目录所在的文件系统不能卸下，一般需要将工作目录改变到根目录。</p>
<p>5、进程从创建它的父进程那里继承了打开的文件描述符。如不关闭，将会浪费系统资源，造成进程所在的文件系统无法卸下以及引起无法预料的错误。所以在最后，记得关闭掉从父进程继承过来的文件描述符。<br>然后，在上面的代码中开启线程后做的事，就是循环去startService()，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">thread</span><span class="params">(<span class="keyword">char</span>* srvname)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;  </span><br><span class="line">        check_and_restart_service(srvname); <span class="comment">// 应该要去判断service状态，这里一直restart 是不足之处  </span></span><br><span class="line">        sleep(<span class="number">4</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 检测服务，如果不存在服务则启动. </span></span><br><span class="line"><span class="comment"> * 通过am命令启动一个laucher服务,由laucher服务负责进行主服务的检测,laucher服务在检测后自动退出 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">check_and_restart_service</span><span class="params">(<span class="keyword">char</span>* service)</span> </span>&#123;  </span><br><span class="line">    LOGI(<span class="string">"当前所在的进程pid="</span>,getpid());  </span><br><span class="line">    <span class="keyword">char</span> cmdline[<span class="number">200</span>];  </span><br><span class="line">    sprintf(cmdline, <span class="string">"am startservice --user 0 -n %s"</span>, service);  </span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">200</span>];  </span><br><span class="line">    sprintf(tmp, <span class="string">"cmd=%s"</span>, cmdline);  </span><br><span class="line">    ExecuteCommandWithPopen(cmdline, tmp, <span class="number">200</span>);  </span><br><span class="line">    LOGI( tmp, LOG);  </span><br><span class="line">&#125;       </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 执行命令 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ExecuteCommandWithPopen</span><span class="params">(<span class="keyword">char</span>* command, <span class="keyword">char</span>* out_result,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> resultBufferSize)</span> </span>&#123;  </span><br><span class="line">    FILE * fp;  </span><br><span class="line">    out_result[resultBufferSize - <span class="number">1</span>] = <span class="string">'\0'</span>;  </span><br><span class="line">    fp = popen(command, <span class="string">"r"</span>);  </span><br><span class="line">    <span class="keyword">if</span> (fp) &#123;  </span><br><span class="line">        fgets(out_result, resultBufferSize - <span class="number">1</span>, fp);  </span><br><span class="line">        out_result[resultBufferSize - <span class="number">1</span>] = <span class="string">'\0'</span>;  </span><br><span class="line">        pclose(fp);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        LOGI(<span class="string">"popen null,so exit"</span>);  </span><br><span class="line">        exit(<span class="number">0</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这两个启动服务的函数，里面就涉及到一些Android和linux的命令了，这里我就不细说了。特别是am，挺强大的功能的，不仅可以开启服务，也可以开启广播等等…然后调用ndk-build命令进行编译，生成so库。</p>
<p>C/C++端关键的部分主要是以上这些，接下来就是Java端调用。<br>首先来看一下so库的加载类，以及C++函数的调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yyh.fork;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.DataInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.DataOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NativeRuntime</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NativeRuntime theInstance = <span class="keyword">null</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NativeRuntime</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NativeRuntime <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (theInstance == <span class="keyword">null</span>)  </span><br><span class="line">            theInstance = <span class="keyword">new</span> NativeRuntime();  </span><br><span class="line">        <span class="keyword">return</span> theInstance;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * RunExecutable 启动一个可自行的lib*.so文件 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2016-1-18 下午8:22:28 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pacaageName </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> alias 别名 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args 参数 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">RunExecutable</span><span class="params">(String pacaageName, String filename, String alias, String args)</span> </span>&#123;  </span><br><span class="line">        String path = <span class="string">"/data/data/"</span> + pacaageName;  </span><br><span class="line">        String cmd1 = path + <span class="string">"/lib/"</span> + filename;  </span><br><span class="line">        String cmd2 = path + <span class="string">"/"</span> + alias;  </span><br><span class="line">        String cmd2_a1 = path + <span class="string">"/"</span> + alias + <span class="string">" "</span> + args;  </span><br><span class="line">        String cmd3 = <span class="string">"chmod 777 "</span> + cmd2;  </span><br><span class="line">        String cmd4 = <span class="string">"dd if="</span> + cmd1 + <span class="string">" of="</span> + cmd2;  </span><br><span class="line">        StringBuffer sb_result = <span class="keyword">new</span> StringBuffer();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">new</span> File(<span class="string">"/data/data/"</span> + alias).exists()) &#123;  </span><br><span class="line">            RunLocalUserCommand(pacaageName, cmd4, sb_result); <span class="comment">// 拷贝lib/libtest.so到上一层目录,同时命名为test.  </span></span><br><span class="line">            sb_result.append(<span class="string">";"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        RunLocalUserCommand(pacaageName, cmd3, sb_result); <span class="comment">// 改变test的属性,让其变为可执行  </span></span><br><span class="line">        sb_result.append(<span class="string">";"</span>);  </span><br><span class="line">        RunLocalUserCommand(pacaageName, cmd2_a1, sb_result); <span class="comment">// 执行test程序.  </span></span><br><span class="line">        sb_result.append(<span class="string">";"</span>);  </span><br><span class="line">        <span class="keyword">return</span> sb_result.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 执行本地用户命令 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2016-1-18 下午8:23:01 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pacaageName </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sb_out_Result </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">RunLocalUserCommand</span><span class="params">(String pacaageName, String command, StringBuffer sb_out_Result)</span> </span>&#123;  </span><br><span class="line">        Process process = <span class="keyword">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            process = Runtime.getRuntime().exec(<span class="string">"sh"</span>); <span class="comment">// 获得shell进程  </span></span><br><span class="line">            DataInputStream inputStream = <span class="keyword">new</span> DataInputStream(process.getInputStream());  </span><br><span class="line">            DataOutputStream outputStream = <span class="keyword">new</span> DataOutputStream(process.getOutputStream());  </span><br><span class="line">            outputStream.writeBytes(<span class="string">"cd /data/data/"</span> + pacaageName + <span class="string">"\n"</span>); <span class="comment">// 保证在command在自己的数据目录里执行,才有权限写文件到当前目录  </span></span><br><span class="line">            outputStream.writeBytes(command + <span class="string">" &amp;\n"</span>); <span class="comment">// 让程序在后台运行，前台马上返回  </span></span><br><span class="line">            outputStream.writeBytes(<span class="string">"exit\n"</span>);  </span><br><span class="line">            outputStream.flush();  </span><br><span class="line">            process.waitFor();  </span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[inputStream.available()];  </span><br><span class="line">            inputStream.read(buffer);  </span><br><span class="line">            String s = <span class="keyword">new</span> String(buffer);  </span><br><span class="line">            <span class="keyword">if</span> (sb_out_Result != <span class="keyword">null</span>)  </span><br><span class="line">                sb_out_Result.append(<span class="string">"CMD Result:\n"</span> + s);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (sb_out_Result != <span class="keyword">null</span>)  </span><br><span class="line">                sb_out_Result.append(<span class="string">"Exception:"</span> + e.getMessage());  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(String compname)</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">startService</span><span class="params">(String srvname, String sdpath)</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">findProcess</span><span class="params">(String packname)</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">stopService</span><span class="params">()</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            System.loadLibrary(<span class="string">"helper"</span>); <span class="comment">// 加载so库  </span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们在收到开机广播后，启动该服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yyh.activity;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;  </span><br><span class="line"><span class="keyword">import</span> android.content.Context;  </span><br><span class="line"><span class="keyword">import</span> android.content.Intent;  </span><br><span class="line"><span class="keyword">import</span> android.util.Log;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.yyh.fork.NativeRuntime;  </span><br><span class="line"><span class="keyword">import</span> com.yyh.utils.FileUtils;  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneStatReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String TAG = <span class="string">"tag"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (Intent.ACTION_BOOT_COMPLETED.equals(intent.getAction())) &#123;  </span><br><span class="line">            Log.i(TAG, <span class="string">"手机开机了~~"</span>);  </span><br><span class="line">            NativeRuntime.getInstance().startService(context.getPackageName() + <span class="string">"/com.yyh.service.HostMonitor"</span>, FileUtils.createRootPath());  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_USER_PRESENT.equals(intent.getAction())) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Service服务里面，就可以做该做的事情。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yyh.service;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> android.app.Service;  </span><br><span class="line"><span class="keyword">import</span> android.content.Intent;  </span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;  </span><br><span class="line"><span class="keyword">import</span> android.util.Log;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostMonitor</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>.onCreate();  </span><br><span class="line">        Log.i(<span class="string">"daemon_java"</span>, <span class="string">"HostMonitor: onCreate! I can not be Killed!"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;  </span><br><span class="line">        Log.i(<span class="string">"daemon_java"</span>, <span class="string">"HostMonitor: onStartCommand! I can not be Killed!"</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent arg0)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当然，也不要忘记在Manifest.xml文件配置receiver和service：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"com.yyh.activity.PhoneStatReceiver"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:permission</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> &gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.BOOT_COMPLETED"</span> /&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.USER_PRESENT"</span> /&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span>  </span><br><span class="line">          </span><br><span class="line">        <span class="tag">&lt;<span class="name">service</span>  <span class="attr">android:name</span>=<span class="string">"com.yyh.service.HostMonitor"</span>  </span></span><br><span class="line"><span class="tag">                  <span class="attr">android:enabled</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">                  <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>run起来，在程序应用里面，结束掉这个进程，不一会了，又自动起来了~~~~跟流氓软件一个样，没错，就是这么贱…</p>
<p>这边是运行在谷歌的原生系统上，Android版本为5.0… 在其他系统下稳定性还远远不足，但是要真正做到杀不死服务几乎是不可能的。 总结一下就是：<strong>服务常驻要应对的不是各种难的技术，而是各大ROM。QQ为什么不会被杀死，是因为国内各大ROM不想让他死…</strong><br>本文主要提供的是一个思路，实现还有诸多不足之处，菜鸟之作，不喜勿喷。</p>
<p><strong>Android 通过JNI实现双守护进程可以用这个思路去实现。</strong></p>
<p>来源：<a href="http://blog.csdn.net/yyh352091626/article/details/50542554" target="_blank" rel="external">http://blog.csdn.net/yyh352091626/article/details/50542554</a></p>
<p>其他还有一些技术之外的措施，比如说<strong>应用内 Push 通道</strong>的选择：</p>
<p><strong>国外版应用：</strong></p>
<p>接入 Google 的 GCM。</p>
<p><strong>国内版应用：</strong></p>
<p>根据终端不同，在小米手机（包括 MIUI）接入小米推送、华为手机接入华为推送；其他手机可以考虑接入腾讯信鸽或极光推送与小米推送做 A/B Test。</p>
<p><a href="https://github.com/52im/MarsDaemon" target="_blank" rel="external">github开源进程保活项目</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/12/jvm-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/12/jvm-intro/" itemprop="url">
                  JVM原理讲解和调优
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-12 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-12T23:47:44+08:00">2017-10-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 04:06:19" itemprop="dateModified" datetime="2017-11-11T04:06:19+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、什么是JVM"><a href="#一、什么是JVM" class="headerlink" title="一、什么是JVM"></a>一、什么是JVM</h3><p>JVM是Java Virtual Machine（Java虚拟机）的缩写，JVM是一种用于计算设备的规范，它是一个虚构出来的计算机，是通过在实际的计算机上仿真模拟各种计算机功能来实现的。</p>
<p>Java语言的一个非常重要的特点就是与平台的无关性。而使用Java虚拟机是实现这一特点的关键。一般的高级语言如果要在不同的平台上运行，至少需要编译成不同的目标代码。而引入Java语言虚拟机后，Java语言在不同平台上运行时不需要重新编译。Java语言使用Java虚拟机屏蔽了与具体平台相关的信息，使得Java语言编译程序只需生成在Java虚拟机上运行的目标代码（字节码），就可以在多种平台上不加修改地运行。Java虚拟机在执行字节码时，把字节码解释成具体平台上的机器指令执行。这就是Java的能够“一次编译，到处运行”的原因。</p>
<p>从Java平台的逻辑结构上来看，我们可以从下图来了解JVM：</p>
<p><img src="/2017/10/12/jvm-intro/1.gif" alt=""></p>
<p>从上图能清晰看到Java平台包含的各个逻辑模块，也能了解到JDK与JRE的区别，对于JVM自身的物理结构，我们可以从下图鸟瞰一下：</p>
<p><img src="/2017/10/12/jvm-intro/2.gif" alt=""></p>
<h3 id="二、JAVA代码编译和执行过程"><a href="#二、JAVA代码编译和执行过程" class="headerlink" title="二、JAVA代码编译和执行过程"></a>二、JAVA代码编译和执行过程</h3><p>Java代码编译是由Java源码编译器来完成，流程图如下所示：</p>
<p><img src="/2017/10/12/jvm-intro/3.gif" alt=""></p>
<p>Java字节码的执行是由JVM执行引擎来完成，流程图如下所示：</p>
<p><img src="/2017/10/12/jvm-intro/4.gif" alt=""></p>
<p>Java代码编译和执行的整个过程包含了以下三个重要的机制：</p>
<p>Java源码编译机制</p>
<p>类加载机制</p>
<p>类执行机制</p>
<p>Java源码编译机制</p>
<p>Java 源码编译由以下三个过程组成：</p>
<p>分析和输入到符号表</p>
<p>注解处理</p>
<p>语义分析和生成class文件</p>
<p>流程图如下所示：</p>
<p><img src="/2017/10/12/jvm-intro/5.gif" alt=""></p>
<p>最后生成的class文件由以下部分组成：</p>
<p>结构信息。包括class文件格式版本号及各部分的数量与大小的信息</p>
<p>元数据。对应于Java源码中声明与常量的信息。包含类/继承的超类/实现的接口的声明信息、域与方法声明信息和常量池</p>
<p>方法信息。对应Java源码中语句和表达式对应的信息。包含字节码、异常处理器表、求值栈与局部变量区大小、求值栈的类型记录、调试符号信息</p>
<h3 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h3><p>JVM的类加载是通过ClassLoader及其子类来完成的，类的层次关系和加载顺序可以由下图来描述：</p>
<p><img src="/2017/10/12/jvm-intro/6.gif" alt=""></p>
<h4 id="1）Bootstrap-ClassLoader"><a href="#1）Bootstrap-ClassLoader" class="headerlink" title="1）Bootstrap ClassLoader"></a>1）Bootstrap ClassLoader</h4><p>负责加载$JAVA_HOME中jre/lib/rt.jar里所有的class，由C++实现，不是ClassLoader子类</p>
<h4 id="2）Extension-ClassLoader"><a href="#2）Extension-ClassLoader" class="headerlink" title="2）Extension ClassLoader"></a>2）Extension ClassLoader</h4><p>负责加载java平台中扩展功能的一些jar包，包括$JAVA_HOME中jre/lib/*.jar或-Djava.ext.dirs指定目录下的jar包</p>
<h4 id="3）App-ClassLoader"><a href="#3）App-ClassLoader" class="headerlink" title="3）App ClassLoader"></a>3）App ClassLoader</h4><p>负责记载classpath中指定的jar包及目录中class</p>
<h4 id="4）Custom-ClassLoader"><a href="#4）Custom-ClassLoader" class="headerlink" title="4）Custom ClassLoader"></a>4）Custom ClassLoader</h4><p>属于应用程序根据自身需要自定义的ClassLoader，如tomcat、jboss都会根据j2ee规范自行实现ClassLoader加载过程中会先检查类是否被已加载，检查顺序是自底向上，从Custom ClassLoader到BootStrap ClassLoader逐层检查，只要某个classloader已加载就视为已加载此类，保证此类只所有ClassLoader加载一次。而加载的顺序是自顶向下，也就是由上层来逐层尝试加载此类。</p>
<h3 id="类执行机制"><a href="#类执行机制" class="headerlink" title="类执行机制"></a>类执行机制</h3><p>JVM是基于栈的体系结构来执行class字节码的。线程创建后，都会产生程序计数器（PC）和栈（Stack），程序计数器存放下一条要执行的指令在方法内的偏移量，栈中存放一个个栈帧，每个栈帧对应着每个方法的每次调用，而栈帧又是有局部变量区和操作数栈两部分组成，局部变量区用于存放方法中的局部变量和参数，操作数栈中用于存放方法执行过程中产生的中间结果。栈的结构如下图所示：</p>
<p><img src="/2017/10/12/jvm-intro/7.gif" alt=""></p>
<h3 id="三、JVM内存管理和垃圾回收"><a href="#三、JVM内存管理和垃圾回收" class="headerlink" title="三、JVM内存管理和垃圾回收"></a>三、JVM内存管理和垃圾回收</h3><h3 id="JVM内存组成结构"><a href="#JVM内存组成结构" class="headerlink" title="JVM内存组成结构"></a>JVM内存组成结构</h3><p>JVM栈由堆、栈、本地方法栈、方法区等部分组成，结构图如下所示：</p>
<p><img src="/2017/10/12/jvm-intro/8.gif" alt=""></p>
<h4 id="1）堆"><a href="#1）堆" class="headerlink" title="1）堆"></a>1）堆</h4><p>所有通过new创建的对象的内存都在堆中分配，堆的大小可以通过-Xmx和-Xms来控制。堆被划分为新生代和旧生代，新生代又被进一步划分为Eden和Survivor区，最后Survivor由From Space和To Space组成，结构图如下所示：</p>
<p><img src="/2017/10/12/jvm-intro/9.gif" alt=""></p>
<p>新生代。新建的对象都是用新生代分配内存，Eden空间不足的时候，会把存活的对象转移到Survivor中，新生代大小可以由-Xmn来控制，也可以用-XX:SurvivorRatio来控制Eden和Survivor的比例</p>
<p>旧生代。用于存放新生代中经过多次垃圾回收仍然存活的对象</p>
<p>持久带（Permanent Space）实现方法区，主要存放所有已加载的类信息，方法信息，常量池等等。可通过-XX:PermSize和-XX:MaxPermSize来指定持久带初始化值和最大值。Permanent Space并不等同于方法区，只不过是Hotspot JVM用Permanent Space来实现方法区而已，有些虚拟机没有Permanent Space而用其他机制来实现方法区。</p>
<p><img src="/2017/10/12/jvm-intro/10.jpg" alt=""></p>
<p>-Xmx:最大堆内存,如：-Xmx512m</p>
<p>-Xms:初始时堆内存,如：-Xms256m</p>
<p>-XX:MaxNewSize:最大年轻区内存</p>
<p>-XX:NewSize:初始时年轻区内存.通常为 Xmx 的 1/3 或 1/4。新生代 = Eden + 2 个 Survivor 空间。实际可用空间为 = Eden + 1 个 Survivor，即 90%</p>
<p>-XX:MaxPermSize:最大持久带内存</p>
<p>-XX:PermSize:初始时持久带内存</p>
<p>-XX:+PrintGCDetails。打印 GC 信息</p>
<p>-XX:NewRatio 新生代与老年代的比例，如 –XX:NewRatio=2，则新生代占整个堆空间的1/3，老年代占2/3</p>
<p>-XX:SurvivorRatio 新生代中 Eden 与 Survivor 的比值。默认值为 8。即 Eden 占新生代空间的 8/10，另外两个 Survivor 各占 1/10</p>
<h4 id="2）栈"><a href="#2）栈" class="headerlink" title="2）栈"></a>2）栈</h4><p>每个线程执行每个方法的时候都会在栈中申请一个栈帧，每个栈帧包括局部变量区和操作数栈，用于存放此次方法调用过程中的临时变量、参数和中间结果。</p>
<p>-xss:设置每个线程的堆栈大小. JDK1.5+ 每个线程堆栈大小为 1M，一般来说如果栈不是很深的话， 1M 是绝对够用了的。</p>
<h4 id="3）本地方法栈"><a href="#3）本地方法栈" class="headerlink" title="3）本地方法栈"></a>3）本地方法栈</h4><p>用于支持native方法的执行，存储了每个native方法调用的状态</p>
<h4 id="4）方法区"><a href="#4）方法区" class="headerlink" title="4）方法区"></a>4）方法区</h4><p>存放了要加载的类信息、静态变量、final类型的常量、属性和方法信息。JVM用持久代（Permanet Generation）来存放方法区，可通过-XX:PermSize和-XX:MaxPermSize来指定最小值和最大值</p>
<h3 id="垃圾回收按照基本回收策略分"><a href="#垃圾回收按照基本回收策略分" class="headerlink" title="垃圾回收按照基本回收策略分"></a>垃圾回收按照基本回收策略分</h3><h3 id="引用计数（Reference-Counting）"><a href="#引用计数（Reference-Counting）" class="headerlink" title="引用计数（Reference Counting）:"></a>引用计数（Reference Counting）:</h3><p>比较古老的回收算法。原理是此对象有一个引用，即增加一个计数，删除一个引用则减少一个计数。垃圾回收时，只用收集计数为0的对象。此算法最致命的是无法处理循环引用的问题。</p>
<h4 id="标记-清除（Mark-Sweep）"><a href="#标记-清除（Mark-Sweep）" class="headerlink" title="标记-清除（Mark-Sweep）:"></a>标记-清除（Mark-Sweep）:</h4><p><img src="/2017/10/12/jvm-intro/11.jpg" alt=""></p>
<p>此算法执行分两阶段。第一阶段从引用根节点开始标记所有被引用的对象，第二阶段遍历整个堆，把未标记的对象清除。此算法需要暂停整个应用，同时，会产生内存碎片。</p>
<h4 id="复制（Copying）"><a href="#复制（Copying）" class="headerlink" title="复制（Copying）:"></a>复制（Copying）:</h4><p><img src="/2017/10/12/jvm-intro/12.jpg" alt=""></p>
<p>此算法把内存空间划为两个相等的区域，每次只使用其中一个区域。垃圾回收时，遍历当前使用区域，把正在使用中的对象复制到另外一个区域中。算法每次只处理正在使用中的对象，因此复制成本比较小，同时复制过去以后还能进行相应的内存整理，不会出现“碎片”问题。当然，此算法的缺点也是很明显的，就是需要两倍内存空间。</p>
<h4 id="标记-整理（Mark-Compact）"><a href="#标记-整理（Mark-Compact）" class="headerlink" title="标记-整理（Mark-Compact）:"></a>标记-整理（Mark-Compact）:</h4><p><img src="/2017/10/12/jvm-intro/13.jpg" alt=""></p>
<p>此算法结合了“标记-清除”和“复制”两个算法的优点。也是分两阶段，第一阶段从根节点开始标记所有被引用对象，第二阶段遍历整个堆，把清除未标记对象并且把存活对象“压缩”到堆的其中一块，按顺序排放。此算法避免了“标记-清除”的碎片问题，同时也避免了“复制”算法的空间问题。</p>
<h3 id="JVM分别对新生代和旧生代采用不同的垃圾回收机制"><a href="#JVM分别对新生代和旧生代采用不同的垃圾回收机制" class="headerlink" title="JVM分别对新生代和旧生代采用不同的垃圾回收机制"></a>JVM分别对新生代和旧生代采用不同的垃圾回收机制</h3><h3 id="新生代的GC："><a href="#新生代的GC：" class="headerlink" title="新生代的GC："></a>新生代的GC：</h3><p>新生代通常存活时间较短，因此基于Copying算法来进行回收，所谓Copying算法就是扫描出存活的对象，并复制到一块新的完全未使用的空间中，对应于新生代，就是在Eden和From Space或To Space之间copy。新生代采用空闲指针的方式来控制GC触发，指针保持最后一个分配的对象在新生代区间的位置，当有新的对象要分配内存时，用于检查空间是否足够，不够就触发GC。当连续分配对象时，对象会逐渐从eden到survivor，最后到旧生代。</p>
<h3 id="在执行机制上JVM提供了串行GC（Serial-GC）、并行回收GC（Parallel-Scavenge）和并行GC（ParNew）"><a href="#在执行机制上JVM提供了串行GC（Serial-GC）、并行回收GC（Parallel-Scavenge）和并行GC（ParNew）" class="headerlink" title="在执行机制上JVM提供了串行GC（Serial GC）、并行回收GC（Parallel Scavenge）和并行GC（ParNew）"></a>在执行机制上JVM提供了串行GC（Serial GC）、并行回收GC（Parallel Scavenge）和并行GC（ParNew）</h3><h4 id="1）串行GC"><a href="#1）串行GC" class="headerlink" title="1）串行GC"></a>1）串行GC</h4><p>在整个扫描和复制过程采用单线程的方式来进行，适用于单CPU、新生代空间较小及对暂停时间要求不是非常高的应用上，是client级别默认的GC方式，可以通过-XX:+UseSerialGC来强制指定</p>
<h4 id="2）并行回收GC"><a href="#2）并行回收GC" class="headerlink" title="2）并行回收GC"></a>2）并行回收GC</h4><p>在整个扫描和复制过程采用多线程的方式来进行，适用于多CPU、对暂停时间要求较短的应用上，是server级别默认采用的GC方式，可用-XX:+UseParallelGC来强制指定，用-XX:ParallelGCThreads=4来指定线程数</p>
<h4 id="3）并行GC"><a href="#3）并行GC" class="headerlink" title="3）并行GC"></a>3）并行GC</h4><p>与旧生代的并发GC配合使用</p>
<p>旧生代的GC：</p>
<p>旧生代与新生代不同，对象存活的时间比较长，比较稳定，因此采用标记（Mark）算法来进行回收，所谓标记就是扫描出存活的对象，然后再进行回收未被标记的对象，回收后对用空出的空间要么进行合并，要么标记出来便于下次进行分配，总之就是要减少内存碎片带来的效率损耗。在执行机制上JVM提供了串行GC（Serial MSC）、并行GC（parallel MSC）和并发GC（CMS），具体算法细节还有待进一步深入研究。</p>
<p>以上各种GC机制是需要组合使用的，指定方式由下表所示：</p>
<p>指定方式</p>
<p>新生代GC方式</p>
<p>旧生代GC方式</p>
<p>-XX:+UseSerialGC</p>
<p>串行GC</p>
<p>串行GC</p>
<p>-XX:+UseParallelGC</p>
<p>并行回收GC</p>
<p>并行GC</p>
<p>-XX:+UseConeMarkSweepGC</p>
<p>并行GC</p>
<p>并发GC</p>
<p>-XX:+UseParNewGC</p>
<p>并行GC</p>
<p>串行GC</p>
<p>-XX:+UseParallelOldGC</p>
<p>并行回收GC</p>
<p>并行GC</p>
<p>-XX:+ UseConeMarkSweepGC</p>
<p>-XX:+UseParNewGC</p>
<p>串行GC</p>
<p>并发GC</p>
<p>不支持的组合</p>
<p>1、-XX:+UseParNewGC -XX:+UseParallelOldGC</p>
<p>2、-XX:+UseParNewGC -XX:+UseSerialGC</p>
<h3 id="四、JVM内存调优"><a href="#四、JVM内存调优" class="headerlink" title="四、JVM内存调优"></a>四、JVM内存调优</h3><p>首先需要注意的是在对JVM内存调优的时候不能只看操作系统级别Java进程所占用的内存，这个数值不能准确的反应堆内存的真实占用情况，因为GC过后这个值是不会变化的，因此内存调优的时候要更多地使用JDK提供的内存查看工具，比如JConsole和Java VisualVM。</p>
<p>对JVM内存的系统级的调优主要的目的是减少GC的频率和Full GC的次数，过多的GC和Full GC是会占用很多的系统资源（主要是CPU），影响系统的吞吐量。特别要关注Full GC，因为它会对整个堆进行整理，导致Full GC一般由于以下几种情况：</p>
<h3 id="旧生代空间不足"><a href="#旧生代空间不足" class="headerlink" title="旧生代空间不足"></a>旧生代空间不足</h3><p>调优时尽量让对象在新生代GC时被回收、让对象在新生代多存活一段时间和不要创建过大的对象及数组避免直接在旧生代创建对象</p>
<h3 id="Pemanet-Generation空间不足"><a href="#Pemanet-Generation空间不足" class="headerlink" title="Pemanet Generation空间不足"></a>Pemanet Generation空间不足</h3><p>增大Perm Gen空间，避免太多静态对象</p>
<p>统计得到的GC后晋升到旧生代的平均大小大于旧生代剩余空间<br>控制好新生代和旧生代的比例</p>
<h3 id="System-gc-被显示调用"><a href="#System-gc-被显示调用" class="headerlink" title="System.gc()被显示调用"></a>System.gc()被显示调用</h3><p>垃圾回收不要手动触发，尽量依靠JVM自身的机制</p>
<p>调优手段主要是通过控制堆内存的各个部分的比例和GC策略来实现，下面来看看各部分比例不良设置会导致什么后果</p>
<h3 id="1）新生代设置过小"><a href="#1）新生代设置过小" class="headerlink" title="1）新生代设置过小"></a>1）新生代设置过小</h3><p>一是新生代GC次数非常频繁，增大系统消耗；二是导致大对象直接进入旧生代，占据了旧生代剩余空间，诱发Full GC</p>
<h3 id="2）新生代设置过大"><a href="#2）新生代设置过大" class="headerlink" title="2）新生代设置过大"></a>2）新生代设置过大</h3><p>一是新生代设置过大会导致旧生代过小（堆总量一定），从而诱发Full GC；二是新生代GC耗时大幅度增加</p>
<p>一般说来新生代占整个堆1/3比较合适</p>
<h3 id="3）Survivor设置过小"><a href="#3）Survivor设置过小" class="headerlink" title="3）Survivor设置过小"></a>3）Survivor设置过小</h3><p>导致对象从eden直接到达旧生代，降低了在新生代的存活时间</p>
<h3 id="4）Survivor设置过大"><a href="#4）Survivor设置过大" class="headerlink" title="4）Survivor设置过大"></a>4）Survivor设置过大</h3><p>导致eden过小，增加了GC频率</p>
<p>另外，通过-XX:MaxTenuringThreshold=n来控制新生代存活时间，尽量让对象在新生代被回收</p>
<p>由内存管理和垃圾回收可知新生代和旧生代都有多种GC策略和组合搭配，选择这些策略对于我们这些开发人员是个难题，JVM提供两种较为简单的GC策略的设置方式</p>
<h3 id="1）吞吐量优先"><a href="#1）吞吐量优先" class="headerlink" title="1）吞吐量优先"></a>1）吞吐量优先</h3><p>JVM以吞吐量为指标，自行选择相应的GC策略及控制新生代与旧生代的大小比例，来达到吞吐量指标。这个值可由-XX:GCTimeRatio=n来设置</p>
<h3 id="2）暂停时间优先"><a href="#2）暂停时间优先" class="headerlink" title="2）暂停时间优先"></a>2）暂停时间优先</h3><p>JVM以暂停时间为指标，自行选择相应的GC策略及控制新生代与旧生代的大小比例，尽量保证每次GC造成的应用停止时间都在指定的数值范围内完成。这个值可由-XX:MaxGCPauseRatio=n来设置</p>
<h3 id="最后汇总一下JVM常见配置"><a href="#最后汇总一下JVM常见配置" class="headerlink" title="最后汇总一下JVM常见配置"></a>最后汇总一下JVM常见配置</h3><h3 id="堆设置"><a href="#堆设置" class="headerlink" title="堆设置"></a>堆设置</h3><p>-Xms:初始堆大小</p>
<p>-Xmx:最大堆大小</p>
<p>-XX:NewSize=n:设置年轻代大小</p>
<p>-XX:NewRatio=n:设置年轻代和年老代的比值。如:为3，表示年轻代与年老代比值为1：3，年轻代占整个年轻代年老代和的1/4</p>
<p>-XX:SurvivorRatio=n:年轻代中Eden区与两个Survivor区的比值。注意Survivor区有两个。如：3，表示Eden：Survivor=3：2，一个Survivor区占整个年轻代的1/5</p>
<p>-XX:MaxPermSize=n:设置持久代大小</p>
<h3 id="收集器设置"><a href="#收集器设置" class="headerlink" title="收集器设置"></a>收集器设置</h3><p>-XX:+UseSerialGC:设置串行收集器</p>
<p>-XX:+UseParallelGC:设置并行收集器</p>
<p>-XX:+UseParalledlOldGC:设置并行年老代收集器</p>
<p>-XX:+UseConcMarkSweepGC:设置并发收集器</p>
<h3 id="垃圾回收统计信息"><a href="#垃圾回收统计信息" class="headerlink" title="垃圾回收统计信息"></a>垃圾回收统计信息</h3><p>-XX:+PrintGC</p>
<p>-XX:+PrintGCDetails</p>
<p>-XX:+PrintGCTimeStamps</p>
<p>-Xloggc:filename</p>
<h3 id="并行收集器设置"><a href="#并行收集器设置" class="headerlink" title="并行收集器设置"></a>并行收集器设置</h3><p>-XX:ParallelGCThreads=n:设置并行收集器收集时使用的CPU数。并行收集线程数。</p>
<p>-XX:MaxGCPauseMillis=n:设置并行收集最大暂停时间</p>
<p>-XX:GCTimeRatio=n:设置垃圾回收时间占程序运行时间的百分比。公式为1/(1+n)</p>
<h3 id="并发收集器设置"><a href="#并发收集器设置" class="headerlink" title="并发收集器设置"></a>并发收集器设置</h3><p>-XX:+CMSIncrementalMode:设置为增量模式。适用于单CPU情况。</p>
<p>-XX:ParallelGCThreads=n:设置并发收集器年轻代收集方式为并行收集时，使用的CPU数。并行收集线程数。</p>
<p>来源：<a href="http://www.mamicode.com/info-detail-1028149.html" target="_blank" rel="external">http://www.mamicode.com/info-detail-1028149.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://51codes.top/2017/10/11/java-object/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codes Online">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/11/java-object/" itemprop="url">
                  java.lang.Object
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-11 23:47:44" itemprop="dateCreated datePublished" datetime="2017-10-11T23:47:44+08:00">2017-10-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-11-11 03:53:04" itemprop="dateModified" datetime="2017-11-11T03:53:04+08:00">2017-11-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Java作为一个庞大的知识体系，涉及到的知识点繁多，本文将从Java中最基本的类java.lang.Object开始谈起。</p>
<p>Object类是Java中其他所有类的祖先，没有Object类Java面向对象无从谈起。作为其他所有类的基类，Object具有哪些属性和行为，是Java语言设计背后的思维体现。</p>
<p>Object类位于java.lang包中，java.lang包包含着Java最基础和核心的类，在编译时会自动导入。Object类没有定义属性，一共有13个方法，具体的类定义结构如下图：</p>
<p><img src="/2017/10/11/java-object/1.jpg" alt=""></p>
<h3 id="1-类构造器public-Object"><a href="#1-类构造器public-Object" class="headerlink" title="1.类构造器public Object();"></a>1.类构造器public Object();</h3><p><strong>大部分情况下</strong>，Java中通过形如 new A(args..)形式创建一个属于该类型的对象。其中A即是类名，A(args..)即此类定义中相对应的构造函数。通过此种形式创建的对象都是通过类中的构造函数完成。为体现此特性，Java中规定：在类定义过程中，对于未定义构造函数的类，默认会有一个无参数的构造函数，作为所有类的基类，Object类自然要反映出此特性，在源码中，未给出Object类构造函数定义，但实际上，此构造函数是存在的。</p>
<p>当然，并不是所有的类都是通过此种方式去构建，也自然的，<strong>并不是所有的类构造函数都是public</strong>。</p>
<h3 id="2-private-static-native-void-registerNatives"><a href="#2-private-static-native-void-registerNatives" class="headerlink" title="2.private static native void registerNatives();"></a>2.private static native void registerNatives();</h3><p>registerNatives函数前面有native关键字修饰，Java中，用native关键字修饰的函数表明该方法的实现并不是在Java中去完成，而是由C/C++去完成，并被编译成了.dll，由Java去调用。方法的具体实现体在dll文件中，对于不同平台，其具体实现应该有所不同。用native修饰，即表示操作系统，需要提供此方法，Java本身需要使用。具体到registerNatives()方法本身，其主要作用是将C/C++中的方法映射到Java中的native方法，实现方法命名的解耦。</p>
<p>既然如此，可能有人会问，registerNatives()修饰符为private，且并没有执行，作用何以达到？其实，在Java源码中，此方法的声明后有紧接着一段静态代码块：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">registerNatives</span><span class="params">()</span></span>;</span><br><span class="line"><span class="number">2</span> <span class="keyword">static</span> &#123;</span><br><span class="line"><span class="number">3</span>     registerNatives();</span><br><span class="line"><span class="number">4</span> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-protected-native-Object-clone-throws-CloneNotSupportedException"><a href="#3-protected-native-Object-clone-throws-CloneNotSupportedException" class="headerlink" title="3.protected native Object clone() throws CloneNotSupportedException;"></a>3.protected native Object clone() throws CloneNotSupportedException;</h3><p>看，clone()方法又是一个被声明为native的方法，因此，我们知道了clone()方法并不是Java的原生方法，具体的实现是有C/C++完成的。clone英文翻译为”克隆”，其目的是创建并返回此对象的一个副本。形象点理解，这有一辆科鲁兹，你看着不错，想要个一模一样的。你调用此方法即可像变魔术一样变出一辆一模一样的科鲁兹出来。配置一样，长相一样。但从此刻起，原来的那辆科鲁兹如果进行了新的装饰，与你克隆出来的这辆科鲁兹没有任何关系了。你克隆出来的对象变不变完全在于你对克隆出来的科鲁兹有没有进行过什么操作了。Java术语表述为：<strong>clone函数返回的是一个引用，指向的是新的clone出来的对象，此对象与原对象分别占用不同的堆空间</strong>。</p>
<p>明白了clone的含义后，接下来看看如果调用clone()函数对象进行此克隆操作。</p>
<p>首先看一下下面的这个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="keyword">package</span> com.corn.objectsummary;</span><br><span class="line"> <span class="number">2</span> </span><br><span class="line"> <span class="number">3</span> <span class="keyword">import</span> com.corn.Person;</span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectTest</span> </span>&#123;</span><br><span class="line"> <span class="number">6</span> </span><br><span class="line"> <span class="number">7</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> <span class="number">8</span> </span><br><span class="line"> <span class="number">9</span>         Object o1 = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="number">10</span>         <span class="comment">// The method clone() from the type Object is not visible</span></span><br><span class="line"><span class="number">11</span>         Object clone = o1.clone();</span><br><span class="line"><span class="number">12</span>     &#125;</span><br><span class="line"><span class="number">13</span> </span><br><span class="line"><span class="number">14</span> &#125;</span><br></pre></td></tr></table></figure>
<p>例子很简单，在main()方法中，new一个Oject对象后，想直接调用此对象的clone方法克隆一个对象，但是出现错误提示：”The method clone() from the type Object is not visible”</p>
<p>why? 根据提示，第一反应是ObjectTest类中定义的Oject对象无法访问其clone()方法。回到Object类中clone()方法的定义，可以看到其被声明为protected，估计问题就在这上面了，protected修饰的属性或方法表示：在同一个包内或者不同包的子类可以访问。显然，Object类与ObjectTest类在不同的包中，但是ObjectTest继承自Object，是Object类的子类，于是，现在却出现子类中通过Object引用不能访问protected方法，原因在于对”不同包中的子类可以访问”没有正确理解。</p>
<p>“不同包中的子类可以访问”，是指当两个类不在同一个包中的时候，继承自父类的子类内部且主调（调用者）为子类的引用时才能访问父类用protected修饰的成员（属性/方法）。 在子类内部，主调为父类的引用时并不能访问此protected修饰的成员。！（super关键字除外）</p>
<p>于是，上例改成如下形式，我们发现，可以正常编译：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="keyword">package</span> com.corn.objectsummary;</span><br><span class="line"> <span class="number">2</span> </span><br><span class="line"> <span class="number">3</span> </span><br><span class="line"> <span class="number">4</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectTest</span> </span>&#123;</span><br><span class="line"> <span class="number">5</span> </span><br><span class="line"> <span class="number">6</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> <span class="number">7</span>         ObjectTest ot1 = <span class="keyword">new</span> ObjectTest();</span><br><span class="line"> <span class="number">8</span> </span><br><span class="line"> <span class="number">9</span>         <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">10</span>             ObjectTest ot2 = (ObjectTest) ot1.clone();</span><br><span class="line"><span class="number">11</span>         &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line"><span class="number">12</span>             <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line"><span class="number">13</span>             e.printStackTrace();</span><br><span class="line"><span class="number">14</span>         &#125;</span><br><span class="line"><span class="number">15</span>     &#125;</span><br><span class="line"><span class="number">16</span> </span><br><span class="line"><span class="number">17</span> &#125;</span><br></pre></td></tr></table></figure>
<p>是的，因为此时的主调已经是子类的引用了。</p>
<p>上述代码在运行过程中会抛出”java.lang.CloneNotSupportedException”,表明clone()方法并未正确执行完毕，问题的原因在与Java中的语法规定：</p>
<p>clone()的正确调用是需要实现Cloneable接口，如果没有实现Cloneable接口，并且子类直接调用Object类的clone()方法，则会抛出CloneNotSupportedException异常。</p>
<p>Cloneable接口仅是一个表示接口，接口本身不包含任何方法，用来指示Object.clone()可以合法的被子类引用所调用。</p>
<p>于是，上述代码改成如下形式，即可正确指定clone()方法以实现克隆。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="keyword">package</span> com.corn.objectsummary;</span><br><span class="line"> <span class="number">2</span> </span><br><span class="line"> <span class="number">3</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectTest</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> <span class="number">6</span> </span><br><span class="line"> <span class="number">7</span>         ObjectTest ot1 = <span class="keyword">new</span> ObjectTest();</span><br><span class="line"> <span class="number">8</span> </span><br><span class="line"> <span class="number">9</span>         <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">10</span>             ObjectTest ot2 = (ObjectTest) ot1.clone();</span><br><span class="line"><span class="number">11</span>             System.out.println(<span class="string">"ot2:"</span> + ot2);</span><br><span class="line"><span class="number">12</span>         &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line"><span class="number">13</span>             <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line"><span class="number">14</span>             e.printStackTrace();</span><br><span class="line"><span class="number">15</span>         &#125;</span><br><span class="line"><span class="number">16</span>     &#125;</span><br><span class="line"><span class="number">17</span> </span><br><span class="line"><span class="number">18</span> &#125;</span><br></pre></td></tr></table></figure>
<p>更多的关于Java克隆/复制相关的知识以后会给出专门的博文。</p>
<h3 id="4-public-final-native-Class-lt-gt-getClass"><a href="#4-public-final-native-Class-lt-gt-getClass" class="headerlink" title="4.public final native Class&lt;?&gt; getClass();"></a>4.public final native Class&lt;?&gt; getClass();</h3><p><strong>getClass()也是一个native方法，返回的是此Object对象的类对象/运行时类对象Class&lt;?&gt;。效果与Object.class相同</strong>。</p>
<p>首先解释下”类对象”的概念：在Java中，类是是对具有一组相同特征或行为的实例的抽象并进行描述，对象则是此类所描述的特征或行为的具体实例。作为概念层次的类，其本身也具有某些共同的特性，如都具有类名称、由类加载器去加载，都具有包，具有父类，属性和方法等。于是，Java中有专门定义了一个类，Class，去描述其他类所具有的这些特性，因此，从此角度去看，类本身也都是属于Class类的对象。为与经常意义上的对象相区分，在此称之为”类对象”。</p>
<p>此处主要大量涉及到Java中的反射知识，关于反射相关知识后续也会给出相关博文。</p>
<h3 id="5-public-boolean-equals-Object-obj"><a href="#5-public-boolean-equals-Object-obj" class="headerlink" title="5.public boolean equals(Object obj);"></a>5.public boolean equals(Object obj);</h3><p>==与equals在Java中经常被使用，大家也都知道==与equals的区别：</p>
<p>==表示的是变量值完成相同（对于基础类型，地址中存储的是值，引用类型则存储指向实际对象的地址）；</p>
<p>equals表示的是对象的内容完全相同，此处的内容多指对象的特征/属性。</p>
<p>实际上，上面说法是不严谨的，更多的只是常见于String类中。首先看一下Object类中关于equals()方法的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line"><span class="number">2</span>     <span class="keyword">return</span> (<span class="keyword">this</span> == obj);</span><br><span class="line"><span class="number">3</span> &#125;</span><br></pre></td></tr></table></figure>
<p>由此可见，Object原生的equals()方法内部调用的正是==，与==具有相同的含义。既然如此，为什么还要定义此equals()方法？</p>
<p><strong>equlas()方法的正确理解应该是：判断两个对象是否相等。那么判断对象相等的标尺又是什么？</strong></p>
<p>如上，在object类中，此标尺即为==。当然，这个标尺不是固定的，其他类中可以按照实际的需要对此标尺含义进行重定义。如String类中则是依据字符串内容是否相等来重定义了此标尺含义。如此可以增加类的功能型和实际编码的灵活性。当然了，如果自定义的类没有重写equals()方法来重新定义此标尺，那么默认的将是其父类的equals()，直到object基类。</p>
<p>如下场景的实际业务需求，对于User bean，由实际的业务需求可知当属性uid相同时，表示的是同一个User，即两个User对象相等。则可以重写equals以重定义User对象相等的标尺。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="keyword">package</span> com.corn.objectsummary;</span><br><span class="line"> <span class="number">2</span> </span><br><span class="line"> <span class="number">3</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span>     <span class="keyword">private</span> <span class="keyword">int</span> uid;</span><br><span class="line"> <span class="number">6</span>     <span class="keyword">private</span> String name;</span><br><span class="line"> <span class="number">7</span>     <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"> <span class="number">8</span> </span><br><span class="line"> <span class="number">9</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">10</span>         <span class="keyword">return</span> uid;</span><br><span class="line"><span class="number">11</span>     &#125;</span><br><span class="line"><span class="number">12</span> </span><br><span class="line"><span class="number">13</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"><span class="number">14</span>         <span class="keyword">this</span>.uid = uid;</span><br><span class="line"><span class="number">15</span>     &#125;</span><br><span class="line"><span class="number">16</span> </span><br><span class="line"><span class="number">17</span>     <span class="function"><span class="keyword">protected</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">18</span>         <span class="keyword">return</span> name;</span><br><span class="line"><span class="number">19</span>     &#125;</span><br><span class="line"><span class="number">20</span> </span><br><span class="line"><span class="number">21</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"><span class="number">22</span>         <span class="keyword">this</span>.name = name;</span><br><span class="line"><span class="number">23</span>     &#125;</span><br><span class="line"><span class="number">24</span> </span><br><span class="line"><span class="number">25</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">26</span>         <span class="keyword">return</span> age;</span><br><span class="line"><span class="number">27</span>     &#125;</span><br><span class="line"><span class="number">28</span> </span><br><span class="line"><span class="number">29</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line"><span class="number">30</span>         <span class="keyword">this</span>.age = age;</span><br><span class="line"><span class="number">31</span>     &#125;</span><br><span class="line"><span class="number">32</span> </span><br><span class="line"><span class="number">33</span>     <span class="meta">@Override</span></span><br><span class="line"><span class="number">34</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line"><span class="number">35</span>         <span class="keyword">if</span> (obj == <span class="keyword">null</span> || !(obj <span class="keyword">instanceof</span> User)) &#123;</span><br><span class="line"><span class="number">36</span>             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">37</span>         &#125;</span><br><span class="line"><span class="number">38</span>         <span class="keyword">if</span> (((User) obj).getUid() == <span class="keyword">this</span>.getUid()) &#123;</span><br><span class="line"><span class="number">39</span>             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">40</span>         &#125;</span><br><span class="line"><span class="number">41</span>         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">42</span>     &#125;</span><br><span class="line"><span class="number">43</span> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="keyword">package</span> com.corn.objectsummary;</span><br><span class="line"> <span class="number">2</span> </span><br><span class="line"> <span class="number">3</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectTest</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> <span class="number">6</span>         User u1 = <span class="keyword">new</span> User();</span><br><span class="line"> <span class="number">7</span>         u1.setUid(<span class="number">111</span>);</span><br><span class="line"> <span class="number">8</span>         u1.setName(<span class="string">"张三"</span>);</span><br><span class="line"> <span class="number">9</span> </span><br><span class="line"><span class="number">10</span>         User u2 = <span class="keyword">new</span> User();</span><br><span class="line"><span class="number">11</span>         u2.setUid(<span class="number">111</span>);</span><br><span class="line"><span class="number">12</span>         u2.setName(<span class="string">"张三丰"</span>);</span><br><span class="line"><span class="number">13</span> </span><br><span class="line"><span class="number">14</span>         System.out.println(u1.equals(u2)); <span class="comment">//返回true</span></span><br><span class="line"><span class="number">15</span>     &#125;</span><br><span class="line"><span class="number">16</span> </span><br><span class="line"><span class="number">17</span> &#125;</span><br></pre></td></tr></table></figure>
<p>ObjectTest中打印出true，因为User类定义中重写了equals()方法，这很好理解，很可能张三是一个人小名，张三丰才是其大名，判断这两个人是不是同一个人，这时只用判断uid是否相同即可。</p>
<p>如上重写equals方法表面上看上去是可以了，实则不然。因为它破坏了Java中的约定：<strong>重写equals()方法必须重写hasCode()方法</strong>。</p>
<h3 id="6-public-native-int-hashCode"><a href="#6-public-native-int-hashCode" class="headerlink" title="6.public native int hashCode();"></a>6.public native int hashCode();</h3><p>hashCode()方法返回一个整形数值，表示该对象的哈希码值。</p>
<p>hashCode()具有如下约定：</p>
<p>1).在Java应用程序程序执行期间，对于同一对象多次调用hashCode()方法时，其返回的哈希码是相同的，前提是将对象进行equals比较时所用的标尺信息未做修改。在Java应用程序的一次执行到另外一次执行，同一对象的hashCode()返回的哈希码无须保持一致；</p>
<p>2).如果两个对象相等（依据：调用equals()方法），那么这两个对象调用hashCode()返回的哈希码也必须相等；</p>
<p>3).反之，两个对象调用hasCode()返回的哈希码相等，这两个对象不一定相等。</p>
<p><strong>即严格的数学逻辑表示为： 两个对象相等 &lt;=&gt; equals()相等 =&gt; hashCode()相等。因此，重写equlas()方法必须重写hashCode()方法，以保证此逻辑严格成立，同时可以推理出：hasCode()不相等 =&gt; equals（）不相等 &lt;=&gt; 两个对象不相等。</strong></p>
<p>可能有人在此产生疑问：<strong>既然比较两个对象是否相等的唯一条件（也是冲要条件）是equals</strong>，那么为什么还要弄出一个hashCode()，并且进行如此约定，弄得这么麻烦？</p>
<p>其实，这主要体现在hashCode()方法的作用上，其主要用于增强哈希表的性能。</p>
<p>以集合类中，以Set为例，当新加一个对象时，需要判断现有集合中是否已经存在与此对象相等的对象，如果没有hashCode()方法，需要将Set进行一次遍历，并逐一用equals()方法判断两个对象是否相等，此种算法时间复杂度为o(n)。通过借助于hasCode方法，先计算出即将新加入对象的哈希码，然后根据哈希算法计算出此对象的位置，直接判断此位置上是否已有对象即可。（注：Set的底层用的是Map的原理实现）</p>
<p><strong>在此需要纠正一个理解上的误区：对象的hashCode()返回的不是对象所在的物理内存地址。甚至也不一定是对象的逻辑地址，hashCode()相同的两个对象，不一定相等，换言之，不相等的两个对象，hashCode()返回的哈希码可能相同</strong>。</p>
<p>因此，在上述代码中，重写了equals()方法后，需要重写hashCode()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="keyword">package</span> com.corn.objectsummary;</span><br><span class="line"> <span class="number">2</span> </span><br><span class="line"> <span class="number">3</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span>     <span class="keyword">private</span> <span class="keyword">int</span> uid;</span><br><span class="line"> <span class="number">6</span>     <span class="keyword">private</span> String name;</span><br><span class="line"> <span class="number">7</span>     <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"> <span class="number">8</span> </span><br><span class="line"> <span class="number">9</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">10</span>         <span class="keyword">return</span> uid;</span><br><span class="line"><span class="number">11</span>     &#125;</span><br><span class="line"><span class="number">12</span> </span><br><span class="line"><span class="number">13</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"><span class="number">14</span>         <span class="keyword">this</span>.uid = uid;</span><br><span class="line"><span class="number">15</span>     &#125;</span><br><span class="line"><span class="number">16</span> </span><br><span class="line"><span class="number">17</span>     <span class="function"><span class="keyword">protected</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">18</span>         <span class="keyword">return</span> name;</span><br><span class="line"><span class="number">19</span>     &#125;</span><br><span class="line"><span class="number">20</span> </span><br><span class="line"><span class="number">21</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"><span class="number">22</span>         <span class="keyword">this</span>.name = name;</span><br><span class="line"><span class="number">23</span>     &#125;</span><br><span class="line"><span class="number">24</span> </span><br><span class="line"><span class="number">25</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">26</span>         <span class="keyword">return</span> age;</span><br><span class="line"><span class="number">27</span>     &#125;</span><br><span class="line"><span class="number">28</span> </span><br><span class="line"><span class="number">29</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line"><span class="number">30</span>         <span class="keyword">this</span>.age = age;</span><br><span class="line"><span class="number">31</span>     &#125;</span><br><span class="line"><span class="number">32</span> </span><br><span class="line"><span class="number">33</span>     <span class="meta">@Override</span></span><br><span class="line"><span class="number">34</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line"><span class="number">35</span>         <span class="keyword">if</span> (obj == <span class="keyword">null</span> || !(obj <span class="keyword">instanceof</span> User)) &#123;</span><br><span class="line"><span class="number">36</span>             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">37</span>         &#125;</span><br><span class="line"><span class="number">38</span>         <span class="keyword">if</span> (((User) obj).getUid() == <span class="keyword">this</span>.getUid()) &#123;</span><br><span class="line"><span class="number">39</span>             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">40</span>         &#125;</span><br><span class="line"><span class="number">41</span>         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">42</span>     &#125;</span><br><span class="line"><span class="number">43</span> </span><br><span class="line"><span class="number">44</span>     <span class="meta">@Override</span></span><br><span class="line"><span class="number">45</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">46</span>         <span class="keyword">int</span> result = <span class="number">17</span>;</span><br><span class="line"><span class="number">47</span>         result = <span class="number">31</span> * result + <span class="keyword">this</span>.getUid();</span><br><span class="line"><span class="number">48</span>         <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">49</span>     &#125;</span><br><span class="line"><span class="number">50</span> &#125;</span><br></pre></td></tr></table></figure>
<p>注：上述hashCode()的重写中出现了result31，是因为result31 = (result&lt;&lt;5) - result。之所以选择31，是因为左移运算和减运算计算效率远大于乘法运算。当然，也可以选择其他数字。</p>
<h3 id="7-public-String-toString"><a href="#7-public-String-toString" class="headerlink" title="7.public String toString();"></a>7.public String toString();</h3><p>toString()方法返回该对象的字符串表示。先看一下Object中的具体方法体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">2</span>    <span class="keyword">return</span> getClass().getName() + <span class="string">"@"</span> + Integer.toHexString(hashCode());</span><br><span class="line"><span class="number">3</span> &#125;</span><br></pre></td></tr></table></figure>
<p>toString()方法相信大家都经常用到，即使没有显式调用，但当我们使用System.out.println(obj)时，其内部也是通过toString()来实现的。</p>
<p>getClass()返回对象的类对象，getClassName()以String形式返回类对象的名称（含包名）。Integer.toHexString(hashCode())则是以对象的哈希码为实参，以16进制无符号整数形式返回此哈希码的字符串表示形式。</p>
<p>如上例中的u1的哈希码是638，则对应的16进制为27e，调用toString()方法返回的结果为：com.corn.objectsummary.User@27e。</p>
<p><strong>因此：toString()是由对象的类型和其哈希码唯一确定，同一类型但不相等的两个对象分别调用toString()方法返回的结果可能相同。</strong></p>
<p>8/9/10/11/12. wait(…) / notify() / notifyAll()</p>
<p>一说到wait(…) / notify() | notifyAll()几个方法，首先想到的是线程。确实，这几个方法主要用于java多线程之间的协作。先具体看下这几个方法的主要含义：</p>
<p>wait()：调用此方法所在的当前线程等待，直到在其他线程上调用此方法的主调（某一对象）的notify()/notifyAll()方法。</p>
<p>wait(long timeout)/wait(long timeout, int nanos)：调用此方法所在的当前线程等待，直到在其他线程上调用此方法的主调（某一对象）的notisfy()/notisfyAll()方法，或超过指定的超时时间量。</p>
<p>notify()/notifyAll()：唤醒在此对象监视器上等待的单个线程/所有线程。</p>
<p>wait(…) / notify() | notifyAll()一般情况下都是配套使用。下面来看一个简单的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="keyword">package</span> com.qqyumidi;</span><br><span class="line"> <span class="number">2</span> </span><br><span class="line"> <span class="number">3</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span>     <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 6      * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment"> 7      */</span></span><br><span class="line"> <span class="number">8</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> <span class="number">9</span>         <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"><span class="number">10</span>         MyRunnable r = <span class="keyword">new</span> MyRunnable();</span><br><span class="line"><span class="number">11</span>         Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line"><span class="number">12</span>         t.start();</span><br><span class="line"><span class="number">13</span>         <span class="keyword">synchronized</span> (r) &#123;</span><br><span class="line"><span class="number">14</span>             <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">15</span>                 System.out.println(<span class="string">"main thread 等待t线程执行完"</span>);</span><br><span class="line"><span class="number">16</span>                 r.wait();</span><br><span class="line"><span class="number">17</span>                 System.out.println(<span class="string">"被notity唤醒，得以继续执行"</span>);</span><br><span class="line"><span class="number">18</span>             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"><span class="number">19</span>                 <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line"><span class="number">20</span>                 e.printStackTrace();</span><br><span class="line"><span class="number">21</span>                 System.out.println(<span class="string">"main thread 本想等待，但被意外打断了"</span>);</span><br><span class="line"><span class="number">22</span>             &#125;</span><br><span class="line"><span class="number">23</span>             System.out.println(<span class="string">"线程t执行相加结果"</span> + r.getTotal());</span><br><span class="line"><span class="number">24</span>         &#125;</span><br><span class="line"><span class="number">25</span>     &#125;</span><br><span class="line"><span class="number">26</span> &#125;</span><br><span class="line"><span class="number">27</span> </span><br><span class="line"><span class="number">28</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"><span class="number">29</span>     <span class="keyword">private</span> <span class="keyword">int</span> total;</span><br><span class="line"><span class="number">30</span> </span><br><span class="line"><span class="number">31</span>     <span class="meta">@Override</span></span><br><span class="line"><span class="number">32</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">33</span>         <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"><span class="number">34</span>         <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="number">35</span>             System.out.println(<span class="string">"Thread name is:"</span> + Thread.currentThread().getName());</span><br><span class="line"><span class="number">36</span>             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line"><span class="number">37</span>                 total += i;</span><br><span class="line"><span class="number">38</span>             &#125;</span><br><span class="line"><span class="number">39</span>             notify();</span><br><span class="line"><span class="number">40</span>             System.out.println(<span class="string">"执行notif后同步代码块中依然可以继续执行直至完毕"</span>);</span><br><span class="line"><span class="number">41</span>         &#125;</span><br><span class="line"><span class="number">42</span>         System.out.println(<span class="string">"执行notif后且同步代码块外的代码执行时机取决于线程调度"</span>);</span><br><span class="line"><span class="number">43</span>     &#125;</span><br><span class="line"><span class="number">44</span> </span><br><span class="line"><span class="number">45</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTotal</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">46</span>         <span class="keyword">return</span> total;</span><br><span class="line"><span class="number">47</span>     &#125;</span><br><span class="line"><span class="number">48</span> &#125;</span><br></pre></td></tr></table></figure>
<p>运行结果为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> main thread 等待t线程执行完</span><br><span class="line"><span class="number">2</span> Thread name is:Thread-<span class="number">0</span></span><br><span class="line"><span class="number">3</span> 执行notif后同步代码块中依然可以继续执行直至完毕</span><br><span class="line"><span class="number">4</span> 执行notif后且同步代码块外的代码执行时机取决于线程调度  <span class="comment">//此行输出位置有具体的JVM线程调度决定，有可能最后执行</span></span><br><span class="line"><span class="number">5</span> 被notity唤醒，得以继续执行</span><br><span class="line"><span class="number">6</span> 线程t执行相加结果<span class="number">45</span></span><br></pre></td></tr></table></figure>
<p>既然是作用于多线程中，为什么却是Object这个基类所具有的方法？原因在于理论上任何对象都可以视为线程同步中的监听器，且wait(…)/notify()|notifyAll()方法只能在同步代码块中才能使用。</p>
<p>从上述例子的输出结果中可以得出如下结论：</p>
<p>1、wait(…)方法调用后当前线程将立即阻塞，且适当其所持有的同步代码块中的锁，直到被唤醒或超时或打断后且重新获取到锁后才能继续执行；</p>
<p>2、notify()/notifyAll()方法调用后，其所在线程不会立即释放所持有的锁，直到其所在同步代码块中的代码执行完毕，此时释放锁，因此，如果其同步代码块后还有代码，其执行则依赖于JVM的线程调度。</p>
<p>在Java源码中，可以看到wait()具体定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">wait</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"><span class="number">2</span>      wait(<span class="number">0</span>);</span><br><span class="line"><span class="number">3</span>  &#125;</span><br></pre></td></tr></table></figure>
<p>且wait(long timeout, int nanos)方法定义内部实质上也是通过调用wait(long timeout)完成。而wait(long timeout)是一个native方法。因此，wait(…)方法本质上都是native方式实现。</p>
<p>notify()/notifyAll()方法也都是native方法。</p>
<p>Java中线程具有较多的知识点，是一块比较大且重要的知识点。后期会有博文专门针对Java多线程作出详细总结。此处不再细述。</p>
<p>protected void finalize();<br>finalize方法主要与Java垃圾回收机制有关。首先我们看一下finalized方法在Object中的具体定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>我们发现Object类中finalize方法被定义成一个空方法，为什么要如此定义呢？finalize方法的调用时机是怎么样的呢？</p>
<p>首先，Object中定义finalize方法表明Java中每一个对象都将具有finalize这种行为，其具体调用时机在：JVM准备对此对形象所占用的内存空间进行垃圾回收前，将被调用。由此可以看出，此方法并不是由我们主动去调用的（虽然可以主动去调用，此时与其他自定义方法无异）。</p>
<p>JVM垃圾回收机制是Java中重点的一块内容，在以后的博文中也将会详细总结。</p>
<p>来源：<a href="http://www.cnblogs.com/lwbqqyumidi/p/3693015.html" target="_blank" rel="external">http://www.cnblogs.com/lwbqqyumidi/p/3693015.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">107</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.4.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
