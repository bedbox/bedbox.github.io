<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android 通过JNI实现守护进程 | Codes Online</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android 通过JNI实现守护进程</h1><a id="logo" href="/.">Codes Online</a><p class="description">_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _enjoying</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android 通过JNI实现守护进程</h1><div class="post-meta">Oct 13, 2017<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>开发一个需要常住后台的App其实是一件非常头疼的事情，不仅要应对国内各大厂商的ROM，还需要应对各类的安全管家… 虽然不断的研究各式各样的方法，但是效果并不好，比如任务管理器把App干掉，服务就起不来了…网上搜寻一番后，<br><strong>主要的方法有以下几种方法，但其实也都治标不治本:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1、提高Service的优先级：这个，也只能说在系统内存不足需要回收资源的时候，优先级较高，不容易被回收，然并卵...  </span><br><span class="line"></span><br><span class="line">2、提高Service所在进程的优先级：效果不是很明显  </span><br><span class="line"></span><br><span class="line">3、在onDestroy方法里重启service：这个倒还算挺有效的一个方法，但是，直接干掉进程的时候，onDestroy()方法都进不来，更别想重启了  </span><br><span class="line"></span><br><span class="line">4、broadcast广播：和第3种一样，没进入onDestroy()，就不知道什么时候发广播了，另外，在Android4.4以上，程序完全退出后，就不好接收广播了，需要在发广播的地方特定处理  </span><br><span class="line"></span><br><span class="line">5、放到System/app底下作为系统应用：这个也就是平时玩玩，没多大的实际意义。  </span><br><span class="line"></span><br><span class="line">6、Service的onStartCommand()方法，返回START_STICKY，这个主要是针对系统资源不足而导致的服务被关闭，还是有一定的道理的。</span><br></pre></td></tr></table></figure>
<p>在这里推荐一篇文章：【腾讯Bugly】Android 进程保活招式大全<br>应对的方法是有，实现起来都比较繁琐，而且稳定性也不好。如果你自己可以定制ROM，那就有很多种办法了，比如把你的应用加入白名单，或是多安装一个没有图标的app作为守护进程… 不过这个思想大部分程序都不适用。</p>
<p>那么，有没有办法在一个APP里面，开启一个子线程，在主线程被干掉了之后，子线程通过监听、轮询等方式去判断服务是否存在，不存在的话则开启服务。答案自然是肯定的，<strong>通过JNI的方式，fork()出一个子线程作为守护进程，轮询监听服务状态。守护进程（Daemon）是运行在后台的一种特殊进程。它独立于控制终端并且周期性地执行某种任务或等待处理某些发生的事件。而守护进程的会话组和当前目录，文件描述符都是独立的。后台运行只是终端进行了一次fork，让程序在后台执行，这些都没有改变</strong>。</p>
<p>那么我们先来看看Android4.4的源码，ActivityManagerService（源码/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java）是如何关闭在应用退出后清理内存的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process.killProcessQuiet(pid);</span><br></pre></td></tr></table></figure>
<p>应用退出后，ActivityManagerService就把主进程给杀死了，但是，在Android5.0中，ActivityManagerService却是这样处理的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Process.killProcessQuiet(app.pid);  </span><br><span class="line">Process.killProcessGroup(app.info.uid, app.pid);</span><br></pre></td></tr></table></figure>
<p><strong>虽只差了一句代码，差别却很大。Android5.0在应用退出后，ActivityManagerService不仅把主进程给杀死，另外把主进程所属的进程组一并杀死，这样一来，由于子进程和主进程在同一进程组，子进程在做的事情，也就停止了</strong>…要不怎么说Android5.0在安全方面做了很多更新呢…</p>
<p>那么，有没有办法让子进程脱离出来，不要受到主进程的影响，当然也是可以的。那么，在C/C++层是如何实现的呢？先上关键代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * srvname  进程名 </span></span><br><span class="line"><span class="comment"> * sd 之前创建子进程的pid写入的文件路径 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* srvname, <span class="keyword">char</span>* sd)</span> </span>&#123;  </span><br><span class="line">    pthread_t id;  </span><br><span class="line">    <span class="keyword">int</span> ret;  </span><br><span class="line">    struct rlimit r;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> pid = fork();  </span><br><span class="line">    LOGI(<span class="string">"fork pid: %d"</span>, pid);  </span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">        LOGI(<span class="string">"first fork() error pid %d,so exit"</span>, pid);  </span><br><span class="line">        exit(<span class="number">0</span>);  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">0</span>) &#123;  </span><br><span class="line">        LOGI(<span class="string">"first fork(): I'am father pid=%d"</span>, getpid());  </span><br><span class="line">        <span class="comment">//exit(0);  </span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//  第一个子进程  </span></span><br><span class="line">        LOGI(<span class="string">"first fork(): I'am child pid=%d"</span>, getpid());  </span><br><span class="line">        setsid();  </span><br><span class="line">        LOGI(<span class="string">"first fork(): setsid=%d"</span>, setsid());  </span><br><span class="line">        umask(<span class="number">0</span>); <span class="comment">//为文件赋予更多的权限，因为继承来的文件可能某些权限被屏蔽  </span></span><br><span class="line">  </span><br><span class="line">        <span class="keyword">int</span> pid = fork();  </span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">// 第二个子进程  </span></span><br><span class="line">            <span class="comment">// 这里实际上为了防止重复开启线程，应该要有相应处理  </span></span><br><span class="line">  </span><br><span class="line">            LOGI(<span class="string">"I'am child-child pid=%d"</span>, getpid());  </span><br><span class="line">            chdir(<span class="string">"/"</span>); <span class="comment">//&lt;span style="font-family: Arial, Helvetica, sans-serif;"&gt;修改进程工作目录为根目录，chdir(“/”)&lt;/span&gt;  </span></span><br><span class="line">            <span class="comment">//关闭不需要的从父进程继承过来的文件描述符。  </span></span><br><span class="line">            <span class="keyword">if</span> (r.rlim_max == RLIM_INFINITY) &#123;  </span><br><span class="line">                r.rlim_max = <span class="number">1024</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">int</span> i;  </span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; r.rlim_max; i++) &#123;  </span><br><span class="line">                close(i);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            umask(<span class="number">0</span>);  </span><br><span class="line">            ret = pthread_create(&amp;id, NULL, (<span class="keyword">void</span> *) thread, srvname); <span class="comment">// 开启线程，轮询去监听启动服务  </span></span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;  </span><br><span class="line">                printf(<span class="string">"Create pthread error!\n"</span>);  </span><br><span class="line">                exit(<span class="number">1</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">int</span> stdfd = open (<span class="string">"/dev/null"</span>, O_RDWR);  </span><br><span class="line">            dup2(stdfd, STDOUT_FILENO);  </span><br><span class="line">            dup2(stdfd, STDERR_FILENO);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            exit(<span class="number">0</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 启动Service </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Java_com_yyh_fork_NativeRuntime_startService</span><span class="params">(JNIEnv* env, jobject thiz,  </span></span></span><br><span class="line"><span class="function"><span class="params">        jstring cchrptr_ProcessName, jstring sdpath)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">char</span> * rtn = jstringTostring(env, cchrptr_ProcessName); <span class="comment">// 得到进程名称  </span></span><br><span class="line">    <span class="keyword">char</span> * sd = jstringTostring(env, sdpath);  </span><br><span class="line">    LOGI(<span class="string">"Java_com_yyh_fork_NativeRuntime_startService run....ProcessName:%s"</span>, rtn);  </span><br><span class="line">    a = rtn;  </span><br><span class="line">    start(<span class="number">1</span>, rtn, sd);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这里有几个重点需要理解一下：</strong></p>
<p>1、为什么要fork两次？第一次fork的作用是为后面setsid服务。setsid的调用者不能是进程组组长(group leader)，而第一次调用的时候父进程是进程组组长。第二次调用后，把前面一次fork出来的子进程退出，这样第二次fork出来的子进程，就和他们脱离了关系。</p>
<p>2、setsid()作用是什么？setsid() 使得第二个子进程是会话组长(sid==pid)，也是进程组组长(pgid == pid)，并且脱离了原来控制终端。故不管控制终端怎么操作，新的进程正常情况下不会收到他发出来的这些信号。</p>
<p>3、umask(0)的作用：由于子进程从父进程继承下来的一些东西，可能并未把权限继承下来，所以要赋予他更高的权限，便于子进程操作。</p>
<p>4、chdir (“/“);作用：进程活动时，其工作目录所在的文件系统不能卸下，一般需要将工作目录改变到根目录。</p>
<p>5、进程从创建它的父进程那里继承了打开的文件描述符。如不关闭，将会浪费系统资源，造成进程所在的文件系统无法卸下以及引起无法预料的错误。所以在最后，记得关闭掉从父进程继承过来的文件描述符。<br>然后，在上面的代码中开启线程后做的事，就是循环去startService()，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">thread</span><span class="params">(<span class="keyword">char</span>* srvname)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;  </span><br><span class="line">        check_and_restart_service(srvname); <span class="comment">// 应该要去判断service状态，这里一直restart 是不足之处  </span></span><br><span class="line">        sleep(<span class="number">4</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 检测服务，如果不存在服务则启动. </span></span><br><span class="line"><span class="comment"> * 通过am命令启动一个laucher服务,由laucher服务负责进行主服务的检测,laucher服务在检测后自动退出 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">check_and_restart_service</span><span class="params">(<span class="keyword">char</span>* service)</span> </span>&#123;  </span><br><span class="line">    LOGI(<span class="string">"当前所在的进程pid="</span>,getpid());  </span><br><span class="line">    <span class="keyword">char</span> cmdline[<span class="number">200</span>];  </span><br><span class="line">    sprintf(cmdline, <span class="string">"am startservice --user 0 -n %s"</span>, service);  </span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">200</span>];  </span><br><span class="line">    sprintf(tmp, <span class="string">"cmd=%s"</span>, cmdline);  </span><br><span class="line">    ExecuteCommandWithPopen(cmdline, tmp, <span class="number">200</span>);  </span><br><span class="line">    LOGI( tmp, LOG);  </span><br><span class="line">&#125;       </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 执行命令 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ExecuteCommandWithPopen</span><span class="params">(<span class="keyword">char</span>* command, <span class="keyword">char</span>* out_result,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> resultBufferSize)</span> </span>&#123;  </span><br><span class="line">    FILE * fp;  </span><br><span class="line">    out_result[resultBufferSize - <span class="number">1</span>] = <span class="string">'\0'</span>;  </span><br><span class="line">    fp = popen(command, <span class="string">"r"</span>);  </span><br><span class="line">    <span class="keyword">if</span> (fp) &#123;  </span><br><span class="line">        fgets(out_result, resultBufferSize - <span class="number">1</span>, fp);  </span><br><span class="line">        out_result[resultBufferSize - <span class="number">1</span>] = <span class="string">'\0'</span>;  </span><br><span class="line">        pclose(fp);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        LOGI(<span class="string">"popen null,so exit"</span>);  </span><br><span class="line">        exit(<span class="number">0</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这两个启动服务的函数，里面就涉及到一些Android和linux的命令了，这里我就不细说了。特别是am，挺强大的功能的，不仅可以开启服务，也可以开启广播等等…然后调用ndk-build命令进行编译，生成so库。</p>
<p>C/C++端关键的部分主要是以上这些，接下来就是Java端调用。<br>首先来看一下so库的加载类，以及C++函数的调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yyh.fork;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.DataInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.DataOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NativeRuntime</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NativeRuntime theInstance = <span class="keyword">null</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NativeRuntime</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NativeRuntime <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (theInstance == <span class="keyword">null</span>)  </span><br><span class="line">            theInstance = <span class="keyword">new</span> NativeRuntime();  </span><br><span class="line">        <span class="keyword">return</span> theInstance;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * RunExecutable 启动一个可自行的lib*.so文件 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2016-1-18 下午8:22:28 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pacaageName </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> alias 别名 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args 参数 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">RunExecutable</span><span class="params">(String pacaageName, String filename, String alias, String args)</span> </span>&#123;  </span><br><span class="line">        String path = <span class="string">"/data/data/"</span> + pacaageName;  </span><br><span class="line">        String cmd1 = path + <span class="string">"/lib/"</span> + filename;  </span><br><span class="line">        String cmd2 = path + <span class="string">"/"</span> + alias;  </span><br><span class="line">        String cmd2_a1 = path + <span class="string">"/"</span> + alias + <span class="string">" "</span> + args;  </span><br><span class="line">        String cmd3 = <span class="string">"chmod 777 "</span> + cmd2;  </span><br><span class="line">        String cmd4 = <span class="string">"dd if="</span> + cmd1 + <span class="string">" of="</span> + cmd2;  </span><br><span class="line">        StringBuffer sb_result = <span class="keyword">new</span> StringBuffer();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">new</span> File(<span class="string">"/data/data/"</span> + alias).exists()) &#123;  </span><br><span class="line">            RunLocalUserCommand(pacaageName, cmd4, sb_result); <span class="comment">// 拷贝lib/libtest.so到上一层目录,同时命名为test.  </span></span><br><span class="line">            sb_result.append(<span class="string">";"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        RunLocalUserCommand(pacaageName, cmd3, sb_result); <span class="comment">// 改变test的属性,让其变为可执行  </span></span><br><span class="line">        sb_result.append(<span class="string">";"</span>);  </span><br><span class="line">        RunLocalUserCommand(pacaageName, cmd2_a1, sb_result); <span class="comment">// 执行test程序.  </span></span><br><span class="line">        sb_result.append(<span class="string">";"</span>);  </span><br><span class="line">        <span class="keyword">return</span> sb_result.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 执行本地用户命令 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2016-1-18 下午8:23:01 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pacaageName </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sb_out_Result </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">RunLocalUserCommand</span><span class="params">(String pacaageName, String command, StringBuffer sb_out_Result)</span> </span>&#123;  </span><br><span class="line">        Process process = <span class="keyword">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            process = Runtime.getRuntime().exec(<span class="string">"sh"</span>); <span class="comment">// 获得shell进程  </span></span><br><span class="line">            DataInputStream inputStream = <span class="keyword">new</span> DataInputStream(process.getInputStream());  </span><br><span class="line">            DataOutputStream outputStream = <span class="keyword">new</span> DataOutputStream(process.getOutputStream());  </span><br><span class="line">            outputStream.writeBytes(<span class="string">"cd /data/data/"</span> + pacaageName + <span class="string">"\n"</span>); <span class="comment">// 保证在command在自己的数据目录里执行,才有权限写文件到当前目录  </span></span><br><span class="line">            outputStream.writeBytes(command + <span class="string">" &amp;\n"</span>); <span class="comment">// 让程序在后台运行，前台马上返回  </span></span><br><span class="line">            outputStream.writeBytes(<span class="string">"exit\n"</span>);  </span><br><span class="line">            outputStream.flush();  </span><br><span class="line">            process.waitFor();  </span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[inputStream.available()];  </span><br><span class="line">            inputStream.read(buffer);  </span><br><span class="line">            String s = <span class="keyword">new</span> String(buffer);  </span><br><span class="line">            <span class="keyword">if</span> (sb_out_Result != <span class="keyword">null</span>)  </span><br><span class="line">                sb_out_Result.append(<span class="string">"CMD Result:\n"</span> + s);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (sb_out_Result != <span class="keyword">null</span>)  </span><br><span class="line">                sb_out_Result.append(<span class="string">"Exception:"</span> + e.getMessage());  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(String compname)</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">startService</span><span class="params">(String srvname, String sdpath)</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">findProcess</span><span class="params">(String packname)</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">stopService</span><span class="params">()</span></span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            System.loadLibrary(<span class="string">"helper"</span>); <span class="comment">// 加载so库  </span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们在收到开机广播后，启动该服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yyh.activity;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;  </span><br><span class="line"><span class="keyword">import</span> android.content.Context;  </span><br><span class="line"><span class="keyword">import</span> android.content.Intent;  </span><br><span class="line"><span class="keyword">import</span> android.util.Log;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.yyh.fork.NativeRuntime;  </span><br><span class="line"><span class="keyword">import</span> com.yyh.utils.FileUtils;  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneStatReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String TAG = <span class="string">"tag"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (Intent.ACTION_BOOT_COMPLETED.equals(intent.getAction())) &#123;  </span><br><span class="line">            Log.i(TAG, <span class="string">"手机开机了~~"</span>);  </span><br><span class="line">            NativeRuntime.getInstance().startService(context.getPackageName() + <span class="string">"/com.yyh.service.HostMonitor"</span>, FileUtils.createRootPath());  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_USER_PRESENT.equals(intent.getAction())) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Service服务里面，就可以做该做的事情。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yyh.service;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> android.app.Service;  </span><br><span class="line"><span class="keyword">import</span> android.content.Intent;  </span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;  </span><br><span class="line"><span class="keyword">import</span> android.util.Log;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostMonitor</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>.onCreate();  </span><br><span class="line">        Log.i(<span class="string">"daemon_java"</span>, <span class="string">"HostMonitor: onCreate! I can not be Killed!"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;  </span><br><span class="line">        Log.i(<span class="string">"daemon_java"</span>, <span class="string">"HostMonitor: onStartCommand! I can not be Killed!"</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent arg0)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当然，也不要忘记在Manifest.xml文件配置receiver和service：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"com.yyh.activity.PhoneStatReceiver"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:permission</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> &gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.BOOT_COMPLETED"</span> /&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.USER_PRESENT"</span> /&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span>  </span><br><span class="line">          </span><br><span class="line">        <span class="tag">&lt;<span class="name">service</span>  <span class="attr">android:name</span>=<span class="string">"com.yyh.service.HostMonitor"</span>  </span></span><br><span class="line"><span class="tag">                  <span class="attr">android:enabled</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">                  <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>run起来，在程序应用里面，结束掉这个进程，不一会了，又自动起来了~~~~跟流氓软件一个样，没错，就是这么贱…</p>
<p>这边是运行在谷歌的原生系统上，Android版本为5.0… 在其他系统下稳定性还远远不足，但是要真正做到杀不死服务几乎是不可能的。 总结一下就是：<strong>服务常驻要应对的不是各种难的技术，而是各大ROM。QQ为什么不会被杀死，是因为国内各大ROM不想让他死…</strong><br>本文主要提供的是一个思路，实现还有诸多不足之处，菜鸟之作，不喜勿喷。</p>
<p><strong>Android 通过JNI实现双守护进程可以用这个思路去实现。</strong></p>
<p>来源：<a href="http://blog.csdn.net/yyh352091626/article/details/50542554" target="_blank" rel="external">http://blog.csdn.net/yyh352091626/article/details/50542554</a></p>
<p>其他还有一些技术之外的措施，比如说<strong>应用内 Push 通道</strong>的选择：</p>
<p><strong>国外版应用：</strong></p>
<p>接入 Google 的 GCM。</p>
<p><strong>国内版应用：</strong></p>
<p>根据终端不同，在小米手机（包括 MIUI）接入小米推送、华为手机接入华为推送；其他手机可以考虑接入腾讯信鸽或极光推送与小米推送做 A/B Test。</p>
<p><a href="https://github.com/52im/MarsDaemon" target="_blank" rel="external">github开源进程保活项目</a></p>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/10/14/thymeleaf/" class="pre">Java模板引擎Thymeleaf</a><a href="/2017/10/12/jvm-intro/" class="next">JVM原理讲解和调优</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenCV/">OpenCV</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/嵌入式/">嵌入式</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/环境搭建/">环境搭建</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/行业/">行业</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.linkedkeeper.com/" title="张松然" target="_blank">张松然</a><ul></ul><a href="http://weishu.me/" title="维术" target="_blank">维术</a><ul></ul><a href="http://zhixinliu.com/" title="Zhixin Liu" target="_blank">Zhixin Liu</a><ul></ul><a href="http://www.ruanyifeng.com/" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.tianmaying.com/user/luoruici" title="Ricky" target="_blank">Ricky</a><ul></ul><a href="http://jeffdeng.me/" title="荒于嬉" target="_blank">荒于嬉</a><ul></ul><a href="https://kcaogen.com/blog" title="康草根" target="_blank">康草根</a><ul></ul><a href="http://13blog.site/" title="zhenfeng13" target="_blank">zhenfeng13</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Codes Online.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>